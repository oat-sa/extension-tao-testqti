function _typeof(obj){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_typeof(obj)}(function(global,factory){"object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&"undefined"!=typeof module?module.exports=factory(require("lodash")):"function"==typeof define&&define.amd?define("core/delegator",["lodash"],factory):(global=global||self,global["core/delegator"]=factory(global._))})(this,function(_){'use strict';function delegator(api,provider,config){function delegate(fnName){var response,args;if(!provider)throw new Error("There is no "+name+" provider!");else if(_.isFunction(provider[fnName])||defaultProvider)args=_slice.call(arguments,1),response=(provider[fnName]||defaultProvider).apply(context,args),wrapper&&(response=wrapper(response)),eventifier&&api.trigger.apply(api,[fnName,response].concat(args));else throw new Error("There is no method called "+fnName+" in the "+name+" provider!");return response}var extendedConfig=_.defaults(config||{},defaults),eventifier=!!(extendedConfig.eventifier&&api&&api.trigger),context=extendedConfig.forward?provider:api,defaultProvider=_.isFunction(extendedConfig.defaultProvider)?extendedConfig.defaultProvider:_.noop,wrapper=_.isFunction(extendedConfig.wrapper)?extendedConfig.wrapper:null,name=extendedConfig.name;return extendedConfig.required&&(defaultProvider=null),delegate}_=_&&_.hasOwnProperty("default")?_["default"]:_;var defaults={name:"provided",eventifier:!0},_slice=[].slice;return delegator}),function(global,factory){"object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&"undefined"!=typeof module?module.exports=factory():"function"==typeof define&&define.amd?define("core/promise",factory):(global=global||self,global["core/promise"]=factory())}(this,function(){'use strict';return Promise}),function(global,factory){"object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&"undefined"!=typeof module?module.exports=factory(require("lodash"),require("core/delegator"),require("core/promise")):"function"==typeof define&&define.amd?define("core/plugin",["lodash","core/delegator","core/promise"],factory):(global=global||self,global["core/plugin"]=factory(global._,global["core/delegator"],global["core/promise"]))}(this,function(_,delegator,Promise){'use strict';function pluginFactory(provider,defaults){var pluginName;if(!_.isPlainObject(provider)||!_.isString(provider.name)||_.isEmpty(provider.name)||!_.isFunction(provider.init))throw new TypeError("A plugin should be defined at least by a name property and an init method");return pluginName=provider.name,defaults=defaults||{},function(host,areaBroker,config){var states={},pluginContent={},plugin,delegate;if(!_.isObject(host)||!_.isFunction(host.on)||!_.isFunction(host.trigger))throw new TypeError("A plugin host should be a valid eventified object");return config=_.defaults(config||{},defaults),plugin={install:function(){var self=this;return delegate("install").then(function(){self.trigger("install")})},init:function(content){var self=this;return states={},content&&(pluginContent=content),delegate("init",content).then(function(){self.setState("init",!0).trigger("init")})},render:function(){var self=this;return delegate("render").then(function(){self.setState("ready",!0).trigger("render").trigger("ready")})},finish:function(){var self=this;return delegate("finish").then(function(){self.setState("finish",!0).trigger("finish")})},destroy:function(){var self=this;return delegate("destroy").then(function(){config={},states={},self.setState("init",!1),self.trigger("destroy")})},trigger:function(name){var args=[].slice.call(arguments,1);return host.trigger.apply(host,["plugin-"+name+"."+pluginName,plugin].concat(args)),this},getHost:function(){return host},getAreaBroker:function(){return areaBroker},getConfig:function(){return config},setConfig:function(name,value){return _.isPlainObject(name)?config=_.defaults(name,config):config[name]=value,this},getState:function(name){return!!states[name]},setState:function(name,active){if(!_.isString(name)||_.isEmpty(name))throw new TypeError("The state must have a name");return states[name]=!!active,this},getContent:function(){return pluginContent},setContent:function(content){return pluginContent=content,this},getName:function(){return pluginName},show:function(){var self=this;return delegate("show").then(function(){self.setState("visible",!0).trigger("show")})},hide:function(){var self=this;return delegate("hide").then(function(){self.setState("visible",!1).trigger("hide")})},enable:function(){var self=this;return delegate("enable").then(function(){self.setState("enabled",!0).trigger("enable")})},disable:function(){var self=this;return delegate("disable").then(function(){self.setState("enabled",!1).trigger("disable")})}},delegate=delegator(plugin,provider,{eventifier:!1,wrapper:function(response){return Promise.resolve(response)}}),_.isString(defaults.hostName)&&!_.isEmpty(defaults.hostName)&&(plugin["get"+defaults.hostName.charAt(0).toUpperCase()+defaults.hostName.slice(1)]=plugin.getHost),plugin}}return _=_&&_.hasOwnProperty("default")?_["default"]:_,delegator=delegator&&delegator.hasOwnProperty("default")?delegator["default"]:delegator,Promise=Promise&&Promise.hasOwnProperty("default")?Promise["default"]:Promise,pluginFactory}),define("taoQtiTest/runner/plugins/content/accessibility/focusOnFirstField",["jquery","lodash","taoTests/runner/plugin","ckeditor"],function($,_,pluginFactory,ckEditor){'use strict';function isIOSDevice(){return /(iPhone|iPad)/i.test(navigator.userAgent)}return pluginFactory({name:"focusOnFirstField",init:function(){var self=this;isIOSDevice()||this.getTestRunner().after("renderitem",function(){var $input=self.getAreaBroker().getContentArea().find(".qti-itemBody").find("input, textarea, select").not(":input[type=button], :input[type=submit], :input[type=reset]").first(),$cke=$input.closest(".qti-interaction").find(".cke");$cke.length?_.delay(function(){ckEditor.instances[$cke.attr("id").replace(/^cke_/,"")].focus()},100):$input.focus()})}})}),function(global,factory){"object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&"undefined"!=typeof module?module.exports=factory(require("lodash")):"function"==typeof define&&define.amd?define("core/format",["lodash"],factory):(global=global||self,global["core/format"]=factory(global._))}(this,function(_){'use strict';function format(message){var replacements=Array.prototype.slice.call(arguments,1);return _.reduce(message.match(pattern),function(acc,match,index){var replacement="";if(void 0!==replacements[index]){switch(match){case"%d":replacement=+replacements[index];break;case"%j":try{replacement=JSON.stringify(replacements[index]).replace(/"/g,"")}catch(e){}break;default:replacement=replacements[index];}message=message.replace(match,replacement)}return message},message)}_=_&&_.hasOwnProperty("default")?_["default"]:_;var pattern=/(%[sdj])/g;return format}),function(global,factory){"object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&"undefined"!=typeof module?module.exports=factory(require("lodash"),require("core/format"),require("core/promise")):"function"==typeof define&&define.amd?define("core/logger/api",["lodash","core/format","core/promise"],factory):(global=global||self,global["core/logger/api"]=factory(global._,global["core/format"],global["core/promise"]))}(this,function(_,format,Promise){'use strict';_=_&&_.hasOwnProperty("default")?_["default"]:_,format=format&&format.hasOwnProperty("default")?format["default"]:format,Promise=Promise&&Promise.hasOwnProperty("default")?Promise["default"]:Promise;var defaultLevel="info",levels={fatal:60,error:50,warn:40,info:30,debug:20,trace:10},logQueue=[],getLevel=function(level){return"undefined"==typeof level||_.isString(level)&&!_.has(levels,level)?defaultLevel:_.isNumber(level)?_.findKey(levels,function(l){return l===level})||defaultLevel:level},getLevelNum=function(level){return _.isString(level)&&_.has(levels,level)?levels[level]:_.isNumber(level)&&_.contains(levels,level)?level:levels[defaultLevel]},checkMinLevel=function(minLevel,level){return getLevelNum(level)>=getLevelNum(minLevel)},loggerFactory=function loggerFactory(name,minLevel,fields){var baseRecord,logger;if(!_.isString(name)||_.isEmpty(name))throw new TypeError("A logger needs a name");return _.isPlainObject(minLevel)&&"undefined"==typeof field&&(fields=minLevel,minLevel=defaultLevel),baseRecord=_.defaults(fields||{},{name:name,pid:1,hostname:navigator.userAgent}),logger={log:function(level,recordFields,message){var rest=[],time=new Date().toISOString(),record,err;if(!1!==loggerFactory.providers&&checkMinLevel(minLevel||defaultLevel,level))return _.isString(recordFields)||recordFields instanceof Error?(message=recordFields,recordFields={},rest=[].slice.call(arguments,2)):rest=[].slice.call(arguments,3),record={level:getLevel(level),v:0,time:time},checkMinLevel(levels.error,level)||message instanceof Error?(message instanceof Error?err=message:(message=_.isObject(message)?JSON.stringify(message):message,err=new Error(message)),record.msg=err.message,record.err=err):record.msg=format.apply(null,[message].concat(rest)),_.merge(record,baseRecord,recordFields),logQueue.push(record),loggerFactory.flush(),this},level:function level(value){return"undefined"==typeof value?getLevel(minLevel):(minLevel=getLevelNum(value),this)},child:function(childFields){return loggerFactory(name,minLevel,_.defaults(childFields,baseRecord))}},_.reduce(levels,function(target,level,levelName){return target[levelName]=_.partial(logger.log,level),target},logger)};return loggerFactory.levels=levels,loggerFactory.providers=!1,loggerFactory.load=function(providerConfigs){var self=this,modules=[];return this.providers=[],new Promise(function(resolve,reject){_.forEach(providerConfigs,function(providerConfig,providerName){modules.push(providerName)}),require(modules,function(){var loadedProviders=[].slice.call(arguments);_.forEach(loadedProviders,function(provider,moduleKey){try{self.register(provider,providerConfigs[modules[moduleKey]])}catch(err){reject(err)}}),self.flush(),resolve()},reject)})},loggerFactory.register=function(provider,providerConfig){if(!_.isPlainObject(provider)||!_.isFunction(provider.log))throw new TypeError("A log provider is an object with a log method");provider.checkMinLevel=checkMinLevel,_.isFunction(provider.setConfig)&&provider.setConfig(providerConfig),this.providers=this.providers||[],this.providers.push(provider)},loggerFactory.flush=function(){_.isArray(this.providers)&&0<this.providers.length&&(_.forEach(logQueue,function(message){_.forEach(loggerFactory.providers,function(provider){provider.log.call(provider,message)})}),logQueue=[])},loggerFactory.setDefaultLevel=function(level){return defaultLevel=getLevel(level),defaultLevel},loggerFactory}),function(global,factory){"object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&"undefined"!=typeof module?module.exports=factory(require("lodash"),require("module"),require("core/logger/api")):"function"==typeof define&&define.amd?define("core/logger",["lodash","module","core/logger/api"],factory):(global=global||self,global["core/logger"]=factory(global._,global.module,global["core/logger/api"]))}(this,function(_,module,loggerFactory){'use strict';_=_&&_.hasOwnProperty("default")?_["default"]:_,module=module&&module.hasOwnProperty("default")?module["default"]:module,loggerFactory=loggerFactory&&loggerFactory.hasOwnProperty("default")?loggerFactory["default"]:loggerFactory;var defaultConfig={level:loggerFactory.levels.warn,loggers:{"core/logger/console":{level:"warn"}}},config=_.defaults(module.config()||{},defaultConfig),logger=loggerFactory("core/logger");return loggerFactory.setDefaultLevel(config.level),loggerFactory.load(config.loggers),window.onerror=function(msg,url,line,col){logger.error("Caught[via window.onerror]: '"+msg+"' from "+url+":"+line+":"+col)},window.setTaoLogLevel=function(level){return loggerFactory.setDefaultLevel(level)},loggerFactory}),function(global,factory){"object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&"undefined"!=typeof module?module.exports=factory(require("lodash"),require("core/promise"),require("lib/uuid"),require("core/logger")):"function"==typeof define&&define.amd?define("core/eventifier",["lodash","core/promise","lib/uuid","core/logger"],factory):(global=global||self,global["core/eventifier"]=factory(global._,global["core/promise"],global["lib/uuid"],global["core/logger"]))}(this,function(_,Promise,uuid,loggerFactory){'use strict';function getEventNames(eventNames){return!_.isString(eventNames)||_.isEmpty(eventNames)?[]:_(eventNames.split(/\s/g)).compact().uniq().value()}function getName(eventName){return-1<eventName.indexOf(".")?eventName.substr(0,eventName.indexOf(".")):eventName}function getNamespace(eventName){return-1<eventName.indexOf(".")?eventName.substr(eventName.indexOf(".")+1):"@"}function getHandlerObject(){return{before:[],between:[],after:[]}}function eventifier(target){var eventHandlers={},getHandlers=function(eventName,type){var name=getName(eventName),ns=getNamespace(eventName);return type=type||"between",eventHandlers[ns]=eventHandlers[ns]||{},eventHandlers[ns][name]=eventHandlers[ns][name]||getHandlerObject(),eventHandlers[ns][name][type]},eventApi={on:function(eventNames,handler){return _.isFunction(handler)&&_.forEach(getEventNames(eventNames),function(eventName){getHandlers(eventName).push(handler)}),this},off:function(eventNames){return _.forEach(getEventNames(eventNames),function(eventName){var name=getName(eventName),ns=getNamespace(eventName),offNamespaces;ns&&!name?"*"===ns?(offNamespaces={},offNamespaces["@"]=eventHandlers["@"],eventHandlers=offNamespaces):eventHandlers[ns]={}:_.forEach(eventHandlers,function(nsHandlers,namespace){nsHandlers[name]&&("@"===ns||ns===namespace)&&(nsHandlers[name]=getHandlerObject())})}),this},removeAllListeners:function(){return eventHandlers={},this},trigger:function(eventNames){function triggerAllHandlers(allHandlers,name,ns){var event={name:name,namespace:ns};allHandlers.before.length?triggerBefore(allHandlers.before,event).then(function(){triggerBetween(allHandlers,event)}).catch(function(err){logHandlerStop("before",event,err)}):triggerBetween(allHandlers,event)}function triggerBefore(handlers,event){var beforeArgs=args.slice(),pHandlers;return beforeArgs.unshift(event),pHandlers=handlers.map(function(handler){var value=!shouldStop(event.name)&&handler.apply(self,beforeArgs);return!1===value?Promise.reject():value}),Promise.all(pHandlers)}function triggerBetween(allHandlers,event){shouldStop(event.name)?logHandlerStop("before",event):triggerHandlers(allHandlers.between,event).then(function(){triggerAfter(allHandlers.after,event)}).catch(function(err){logHandlerStop("on",event,err)})}function triggerAfter(handlers,event){shouldStop(event.name)?logHandlerStop("on",event):triggerHandlers(handlers,event).then(function(){shouldStop(event.name)&&logHandlerStop("after",event)}).catch(function(err){logHandlerStop("after",event,err)})}function triggerHandlers(handlers,event){var pHandlers;return pHandlers=handlers.map(function(handler){return shouldStop(event.name)?Promise.reject():handler.apply(self,args)}),Promise.all(pHandlers)}function logHandlerStop(stoppedIn,event,err){err instanceof Error&&logger.error(err),logger.trace({err:err,event:event.name,stoppedIn:stoppedIn},event.name+" handlers stopped")}function shouldStop(name){return stoppedEvents[name]}var self=this,args=[].slice.call(arguments,1);return stoppedEvents={},_.forEach(getEventNames(eventNames),function(eventName){var ns=getNamespace(eventName),name=getName(eventName),mergedHandlers=_(eventHandlers).filter(function(nsHandlers,namespace){return nsHandlers[name]&&("@"===ns||ns===namespace||"*"===namespace)}).reduce(function(acc,nsHandlers){return acc.before=acc.before.concat(nsHandlers[name].before),acc.between=acc.between.concat(nsHandlers[name].between),acc.after=acc.after.concat(nsHandlers[name].after),acc},getHandlerObject());logger.trace({event:eventName,args:args},"trigger %s",eventName),mergedHandlers&&triggerAllHandlers(mergedHandlers,name,ns)}),this},before:function(eventNames,handler){return _.isFunction(handler)&&_.forEach(getEventNames(eventNames),function(eventName){getHandlers(eventName,"before").push(handler)}),this},after:function(eventNames,handler){return _.isFunction(handler)&&_.forEach(getEventNames(eventNames),function(eventName){getHandlers(eventName,"after").push(handler)}),this},stopEvent:function(name){_.isString(name)&&!_.isEmpty(name.trim())&&(stoppedEvents[name.trim()]=!0)},spread:function(destination,eventNames){var self=this;return destination&&_.isFunction(destination.trigger)&&(_.isString(eventNames)&&(eventNames=getEventNames(eventNames)),_.forEach(eventNames,function(eventName){self.on(eventName,function(){var args=[eventName].concat([].slice.call(arguments));destination.trigger.apply(destination,args)})})),this}},targetName,logger,stoppedEvents;return target=target||{},targetName=target.name||target.id||target.serial||uuid(6),logger=eventifierLogger.child({target:targetName}),_(eventApi).functions().forEach(function(method){_.isFunction(target[method])&&eventifierLogger.warn("The target object has already a method named "+method,target),target[method]=function(){var args=[].slice.call(arguments);return eventApi[method].apply(target,args)}}),target}_=_&&_.hasOwnProperty("default")?_["default"]:_,Promise=Promise&&Promise.hasOwnProperty("default")?Promise["default"]:Promise,uuid=uuid&&uuid.hasOwnProperty("default")?uuid["default"]:uuid,loggerFactory=loggerFactory&&loggerFactory.hasOwnProperty("default")?loggerFactory["default"]:loggerFactory;var eventifierLogger=loggerFactory("core/eventifier");return eventifier}),function(global,factory){"object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&"undefined"!=typeof module?module.exports=factory(require("lodash")):"function"==typeof define&&define.amd?define("util/namespace",["lodash"],factory):(global=global||self,global["util/namespace"]=factory(global._))}(this,function(_){'use strict';_=_&&_.hasOwnProperty("default")?_["default"]:_;var reSplit=/\s/g,namespaceSep=".",namespaceHelper={split:function(names,normalize){return!_.isString(names)||_.isEmpty(names)?[]:(normalize&&(names=names.toLowerCase()),_(names.trim().split(reSplit)).compact().uniq().value())},getName:function(namespaced){return!_.isString(namespaced)||_.isEmpty(namespaced)?"":-1<namespaced.indexOf(namespaceSep)?namespaced.substr(0,namespaced.indexOf(namespaceSep)):namespaced},getNamespace:function(namespaced,defaultNs){return!_.isString(namespaced)||_.isEmpty(namespaced)?"":-1<namespaced.indexOf(namespaceSep)?namespaced.substr(namespaced.indexOf(namespaceSep)+1):defaultNs||"@"},namespaceAll:function(names,namespace,normalize){var suffix;return _.isArray(names)||(names=namespaceHelper.split(names,normalize)),normalize&&(namespace=namespace.toLowerCase()),suffix=namespace?namespaceSep+namespace:"",_(names).map(function(sh){return 0>sh.indexOf(namespaceSep)?sh+suffix:sh}).compact().uniq().value().join(" ")}};return namespaceHelper}),function(global,factory){"object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&"undefined"!=typeof module?module.exports=factory(require("jquery"),require("lodash"),require("util/namespace")):"function"==typeof define&&define.amd?define("util/shortcut/registry",["jquery","lodash","util/namespace"],factory):(global=global||self,global["util/shortcut/registry"]=factory(global.$,global._,global["util/namespace"]))}(this,function($,_,namespaceHelper){'use strict';var _StringfromCharCode=String.fromCharCode;function registerEvent(target,eventName,listener){target.addEventListener?target.addEventListener(eventName,listener,!1):target.attachEvent?target.attachEvent("on"+eventName,listener):target["on"+eventName]=listener}function unregisterEvent(target,eventName,listener){target.removeEventListener?target.removeEventListener(eventName,listener,!1):target.detachEvent?target.detachEvent("on"+eventName,listener):target["on"+eventName]=null}function getActualKey(event){var code=event.which||event.keyCode,character=32<=code?_StringfromCharCode(code).toLowerCase():"",key=event.key&&event.key.toLowerCase(),keyName=event.code&&event.code.toLowerCase();return keyName&&(0===keyName.indexOf("key")?("a">key||"z"<key)&&"a"<=character&&"z">=character&&(key=character):0===keyName.indexOf("digit")&&(key=keyName.substr(5))),specialKeys[code]||key||character}function getActualButton(event){var buttons={clickLeft:!1,clickRight:!1,clickMiddle:!1,clickBack:!1,clickForward:!1};if(event.buttons)buttons.clickLeft=!!(1&event.buttons),buttons.clickRight=!!(2&event.buttons),buttons.clickMiddle=!!(4&event.buttons),buttons.clickBack=!!(8&event.buttons),buttons.clickForward=!!(16&event.buttons);else switch(event.button){case 0:buttons.clickLeft=!0;break;case 1:buttons.clickMiddle=!0;break;case 2:buttons.clickRight=!0;break;case 3:buttons.clickBack=!0;break;case 4:buttons.clickForward=!0;}return buttons}function getActualScroll(event){return{scrollUp:0>event.deltaY,scrollDown:0<event.deltaY}}function normalizeCommand(descriptor){var key=translateKeys[descriptor.key]||descriptor.key,parts=[];return descriptor.ctrlKey&&parts.push("control"),descriptor.altKey&&parts.push("alt"),descriptor.shiftKey&&parts.push("shift"),descriptor.metaKey&&parts.push("meta"),descriptor.scrollDown&&parts.push("scrollDown"),descriptor.scrollUp&&parts.push("scrollUp"),descriptor.clickLeft&&parts.push("clickLeft"),descriptor.clickRight&&parts.push("clickRight"),descriptor.clickMiddle&&parts.push("clickMiddle"),descriptor.clickBack&&parts.push("clickBack"),descriptor.clickForward&&parts.push("clickForward"),key&&0>parts.indexOf(key)&&parts.push(key),parts.join("+")}function parseCommand(shortcut){var parts=namespaceHelper.getName(shortcut).split("+"),descriptor={keyboardInvolved:!1,mouseClickInvolved:!1,mouseWheelInvolved:!1,ctrlKey:!1,altKey:!1,shiftKey:!1,metaKey:!1,key:null,scrollUp:null,scrollDown:null,clickLeft:null,clickRight:null,clickMiddle:null,clickBack:null,clickForward:null};return _.forEach(parts,function(part){if(modifiers[part])descriptor[modifiers[part]]=!0;else if(0<=part.indexOf("mouse")){if(descriptor.keyboardInvolved)throw new Error("A shortcut cannot involve both mouse and regular keys!");0<=part.indexOf("scroll")&&(descriptor.mouseWheelInvolved=!0,descriptor.scrollUp=0<=part.indexOf("up"),descriptor.scrollDown=0<=part.indexOf("down")),0<=part.indexOf("click")&&(descriptor.mouseClickInvolved=!0,descriptor.clickLeft=0<=part.indexOf("left"),descriptor.clickRight=0<=part.indexOf("right"),descriptor.clickMiddle=0<=part.indexOf("middle"),descriptor.clickBack=0<=part.indexOf("back"),descriptor.clickForward=0<=part.indexOf("forward"))}else{if(descriptor.mouseClickInvolved||descriptor.mouseWheelInvolved)throw new Error("A shortcut cannot involve both mouse and regular keys!");descriptor.keyboardInvolved=!0,descriptor.key=part}}),descriptor}$=$&&$.hasOwnProperty("default")?$["default"]:$,_=_&&_.hasOwnProperty("default")?_["default"]:_,namespaceHelper=namespaceHelper&&namespaceHelper.hasOwnProperty("default")?namespaceHelper["default"]:namespaceHelper;var modifiers={ctrl:"ctrlKey",alt:"altKey",option:"altKey",shift:"shiftKey",meta:"metaKey",cmd:"metaKey",win:"metaKey"},translateKeys={escape:"esc",arrowdown:"down",arrowleft:"left",arrowright:"right",arrowup:"up"},specialKeys={8:"backspace",9:"tab",13:"enter",19:"pause",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"insert",46:"delete",91:"meta",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",145:"scrolllock",144:"numlock"};return function(root,defaultOptions){function getHandlers(command,namespace){return handlers[namespace]=handlers[namespace]||{},handlers[namespace][command]=handlers[namespace][command]||[],handlers[namespace][command]}function getCommandHandlers(command){return _.reduce(handlers,function(acc,nsHandlers){return nsHandlers[command]&&(acc=acc.concat(nsHandlers[command])),acc},[])}function clearHandlers(command,namespace){namespace&&!command?handlers[namespace]={}:_.forEach(handlers,function(nsHandlers,ns){nsHandlers[command]&&("*"===namespace||namespace===ns)&&(nsHandlers[command]=[])})}function setOptions(descriptor,options){descriptor.options=_.defaults(_.merge(descriptor.options||{},options),defaultOptions)}function registerKeyboard(){keyboardIsRegistered||(registerEvent(root,"keydown",onKeyboard),keyboardIsRegistered=!0),keyboardCount++}function unregisterKeyboard(){keyboardCount--,0>=keyboardCount&&(keyboardCount=0,keyboardIsRegistered&&(unregisterEvent(root,"keydown",onKeyboard),keyboardIsRegistered=!1))}function registerMouseClick(){mouseClickIsRegistered||(registerEvent(root,"click",onMouseClick),mouseClickIsRegistered=!0),mouseClickCount++}function unregisterMouseClick(){mouseClickCount--,0>=mouseClickCount&&(mouseClickCount=0,mouseClickIsRegistered&&(unregisterEvent(root,"click",onMouseClick),mouseClickIsRegistered=!1))}function registerMouseWheel(){mouseWheelIsRegistered||(registerEvent(root,"wheel",onMouseWheel),mouseWheelIsRegistered=!0),mouseWheelCount++}function unregisterMouseWheel(){mouseWheelCount--,0>=mouseWheelCount&&(mouseWheelCount=0,mouseWheelIsRegistered&&(unregisterEvent(root,"wheel",onMouseWheel),mouseWheelIsRegistered=!1))}function registerCommand(command,descriptor){shortcuts[command]=descriptor,descriptor.keyboardInvolved&&registerKeyboard(),descriptor.mouseClickInvolved&&registerMouseClick(),descriptor.mouseWheelInvolved&&registerMouseWheel()}function unregisterCommand(command){var descriptor=shortcuts[command];shortcuts[command]=null,descriptor&&(descriptor.keyboardInvolved&&unregisterKeyboard(),descriptor.mouseClickInvolved&&unregisterMouseClick(),descriptor.mouseWheelInvolved&&unregisterMouseWheel())}function onKeyboard(event){processShortcut(event,{keyboardInvolved:!0,ctrlKey:event.ctrlKey,altKey:event.altKey,shiftKey:event.shiftKey,metaKey:event.metaKey,key:getActualKey(event)})}function onMouseClick(event){processShortcut(event,_.merge({mouseClickInvolved:!0,ctrlKey:event.ctrlKey,altKey:event.altKey,shiftKey:event.shiftKey,metaKey:event.metaKey},getActualButton(event)))}function onMouseWheel(event){processShortcut(event,_.merge({mouseClickInvolved:!0,ctrlKey:event.ctrlKey,altKey:event.altKey,shiftKey:event.shiftKey,metaKey:event.metaKey},getActualScroll(event)))}function processShortcut(event,descriptor){var command=normalizeCommand(descriptor),shortcut=shortcuts[command],shortcutHandlers,$target;if(shortcut&&!states.disabled){if(!0===shortcut.options.avoidInput&&($target=$(event.target),$target.closest("[type=\"text\"],textarea").length&&(!shortcut.options.allowIn||!$target.closest(shortcut.options.allowIn).length)))return;!1===shortcut.options.propagate&&event.stopPropagation(),!0===shortcut.options.prevent&&event.preventDefault(),shortcutHandlers=getCommandHandlers(command),shortcutHandlers&&_.forEach(shortcutHandlers,function(handler){handler(event,command)})}}var keyboardIsRegistered=!1,mouseClickIsRegistered=!1,mouseWheelIsRegistered=!1,keyboardCount=0,mouseClickCount=0,mouseWheelCount=0,shortcuts={},handlers={},states={};return root.jquery&&(root=root.get(0)),{set:function(shortcut,options){return _.forEach(namespaceHelper.split(shortcut,!0),function(normalized){var descriptor=parseCommand(normalized),command=normalizeCommand(descriptor);setOptions(descriptor,options),registerCommand(command,descriptor)}),this},add:function(shortcut,handler,options){return _.isFunction(handler)&&_.forEach(namespaceHelper.split(shortcut,!0),function(normalized){var namespace=namespaceHelper.getNamespace(normalized,"*"),descriptor=parseCommand(normalized),command=normalizeCommand(descriptor);setOptions(descriptor,options),registerCommand(command,descriptor),getHandlers(command,namespace).push(handler)}),this},remove:function(shortcut){return _.forEach(namespaceHelper.split(shortcut,!0),function(normalized){var namespace=namespaceHelper.getNamespace(normalized,"*"),descriptor=parseCommand(normalized),command=normalizeCommand(descriptor);clearHandlers(command,namespace),getCommandHandlers(command).length||unregisterCommand(command)}),this},exists:function(shortcut){var normalized=(shortcut+"").trim().toLowerCase(),namespace=namespaceHelper.getNamespace(normalized,"*"),descriptor=parseCommand(normalized),command=normalizeCommand(descriptor),shortcutExists=!1;return shortcuts[command]?shortcutExists="*"===namespace||!!getHandlers(command,namespace).length:!command&&(shortcutExists=!_.isEmpty(handlers[namespace])),shortcutExists},clear:function(){return shortcuts={},handlers={},keyboardCount=0,mouseClickCount=0,mouseWheelCount=0,unregisterKeyboard(),unregisterMouseClick(),unregisterMouseWheel(),this},getState:function(name){return!!states[name]},setState:function(name,state){return states[name]=!!state,this},enable:function(){return this.setState("disabled",!1),this},disable:function(){return this.setState("disabled",!0),this}}}}),function(global,factory){"object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&"undefined"!=typeof module?module.exports=factory(require("util/shortcut/registry")):"function"==typeof define&&define.amd?define("util/shortcut",["util/shortcut/registry"],factory):(global=global||self,global["util/shortcut"]=factory(global["util/shortcut/registry"]))}(this,function(shortcutRegistry){'use strict';shortcutRegistry=shortcutRegistry&&shortcutRegistry.hasOwnProperty("default")?shortcutRegistry["default"]:shortcutRegistry;var shortcut=shortcutRegistry(window,{propagate:!1,prevent:!0});return shortcut}),define("css!taoQtiTestCss/plugins/key-navigation",[],function(){}),define("taoQtiTest/runner/plugins/content/accessibility/keyNavigation",["jquery","lodash","ui/keyNavigation/navigator","ui/keyNavigation/navigableDomElement","ui/keyNavigation/navigableGroupElement","util/shortcut","util/namespace","taoTests/runner/plugin","css!taoQtiTestCss/plugins/key-navigation"],function($,_,keyNavigator,navigableDomElement,navigableGroupElement,shortcut,namespaceHelper,pluginFactory){'use strict';function initToolbarNavigation(){var $navigationBar=$(".bottom-action-bar"),$focusables=$navigationBar.find(".action:not(.btn-group):visible, .action.btn-group .li-inner:visible"),navigables=navigableDomElement.createFromDoms($focusables);return navigables.length?[keyNavigator({id:"bottom-toolbar",replace:!0,group:$navigationBar,elements:navigables,defaultPosition:navigables.length-1}).on("right down",function(elem){return!!allowedToNavigateFrom(elem)&&void this.next()}).on("left up",function(elem){return!!allowedToNavigateFrom(elem)&&void this.previous()}).on("activate",function(cursor){cursor.navigable.getElement().click().mousedown()})]:[]}function initHeaderNavigation(){var $headerElements=$("[data-control=\"exit\"]:visible a"),navigables=navigableDomElement.createFromDoms($headerElements);return navigables.length?[keyNavigator({id:"header-toolbar",group:$headerElements.closest(".infoControl"),elements:navigables,loop:!0,replace:!0}).on("activate",function(cursor){cursor.navigable.getElement().click()})]:[]}function initNavigatorNavigation(testRunner){var $panel=testRunner.getAreaBroker().getPanelArea(),$navigator=$panel.find(".qti-navigator"),navigators=[],itemListingVisited=!1,filtersNavigator,itemsNavigator,$filters,$trees,navigableFilters,navigableTrees,filterCursor;return $navigator.length&&!$navigator.hasClass("disabled")&&($filters=$navigator.find(".qti-navigator-filters .qti-navigator-filter"),navigableFilters=navigableDomElement.createFromDoms($filters),navigableFilters.length&&(filtersNavigator=keyNavigator({keepState:!0,id:"navigator-filters",replace:!0,elements:navigableFilters,group:$navigator}).on("right",function(elem){return!!allowedToNavigateFrom(elem)&&void this.next()}).on("left",function(elem){return!!allowedToNavigateFrom(elem)&&void this.previous()}).on("down",function(elem){return!!allowedToNavigateFrom(elem)&&void(itemsNavigator&&_.defer(function(){itemListingVisited?itemsNavigator.focus().first():itemsNavigator.focus()}))}).on("up",function(elem){return!!allowedToNavigateFrom(elem)&&void(itemsNavigator&&_.defer(function(){itemsNavigator.last()}))}).on("focus",function(cursor,origin){cursor.navigable.getElement().click(),(filterCursor&&filterCursor.position!==cursor.position||origin)&&(itemListingVisited=!1),filterCursor=cursor}),navigators.push(filtersNavigator)),$trees=$navigator.find(".qti-navigator-tree .qti-navigator-item:not(.unseen) .qti-navigator-label"),navigableTrees=navigableDomElement.createFromDoms($trees),navigableTrees.length&&(itemsNavigator=keyNavigator({id:"navigator-items",replace:!0,elements:navigableTrees,defaultPosition:function(navigables){var pos=0;return filterCursor&&"flagged"!==filterCursor.navigable.getElement().data("mode")&&_.forIn(navigables,function(navigable,i){var $parent=navigable.getElement().parent(".qti-navigator-item");if($parent.hasClass("active")&&$parent.is(":visible"))return pos=i,!1}),pos}}).on("down",function(elem){return!!allowedToNavigateFrom(elem)&&void this.next()}).on("up",function(elem){return!!allowedToNavigateFrom(elem)&&void this.previous()}).on("right",function(elem){return!!allowedToNavigateFrom(elem)&&void(filtersNavigator&&filtersNavigator.focus().next())}).on("left",function(elem){return!!allowedToNavigateFrom(elem)&&void(filtersNavigator&&filtersNavigator.focus().previous())}).on("activate",function(cursor){cursor.navigable.getElement().click()}).on("lowerbound upperbound",function(){filtersNavigator&&filtersNavigator.focus()}).on("focus",function(cursor){itemListingVisited=!0,cursor.navigable.getElement().parent().addClass("key-navigation-highlight")}).on("blur",function(cursor){cursor.navigable.getElement().parent().removeClass("key-navigation-highlight")}))),navigators}function initDefaultContentNavigation(testRunner){var itemNavigators=[],$content=testRunner.getAreaBroker().getContentArea();return $content.find(".key-navigation-focusable").addClass("key-navigation-scrollable"),$content.find(".key-navigation-focusable,.qti-interaction").filter(function(){return!$(this).parents(".qti-interaction").length}).each(function(){var $itemElement=$(this);$itemElement.hasClass("qti-interaction")?itemNavigators=_.union(itemNavigators,initInteractionNavigation($itemElement)):itemNavigators.push(keyNavigator({elements:navigableDomElement.createFromDoms($itemElement),group:$itemElement,propagateTab:!1}))}),itemNavigators}function initAllContentButtonsNavigation(testRunner){var navigableElements=[],$content=testRunner.getAreaBroker().getContentArea(),$qtiIteractionsNodeList=$content.find(".key-navigation-focusable,.qti-interaction").filter(function(){return!$(this).parents(".qti-interaction").length}),$qtiChoiceNodesList=$qtiIteractionsNodeList.find(".qti-choice");return $content.find(".key-navigation-focusable").addClass("key-navigation-scrollable"),$qtiChoiceNodesList.each(function(){var $itemElement=$(this),keyNavigatorItem=keyNavigator({elements:navigableDomElement.createFromDoms($itemElement),group:$itemElement,propagateTab:!1});keyNavigatorItem.on("activate",function(cursor){var $elt=cursor.navigable.getElement();$elt.is(":checkbox")?$elt.each(function(){this.click()}):$elt.click()}),navigableElements.push(keyNavigatorItem)}),navigableElements}function initInteractionNavigation($interaction){var interactionNavigators=[],$inputs,interactionNavigables;if($interaction.find(".key-navigation-focusable").each(function(){var $nav=$(this);$nav.closest(".qti-choice").length||interactionNavigators.push(keyNavigator({elements:navigableDomElement.createFromDoms($nav),group:$nav,propagateTab:!1}))}),$interaction.off(".keyNavigation"),$inputs=$interaction.is(":input")?$interaction:$interaction.find(":input"),interactionNavigables=navigableDomElement.createFromDoms($inputs),interactionNavigables.length){var keyNavigatorItem=keyNavigator({elements:interactionNavigables,group:$interaction,loop:!1});keyNavigatorItem.on("right down",function(elem){return!!allowedToNavigateFrom(elem)&&void this.next()}).on("left up",function(elem){return!!allowedToNavigateFrom(elem)&&void this.previous()}).on("activate",function(cursor){var $elt=cursor.navigable.getElement();$elt.is(":checkbox")?$elt.each(function(){this.click()}):$elt.click()}).on("focus",function(cursor){cursor.navigable.getElement().closest(".qti-choice").addClass("key-navigation-highlight")}).on("blur",function(cursor){cursor.navigable.getElement().closest(".qti-choice").removeClass("key-navigation-highlight")}),interactionNavigators.push(keyNavigatorItem)}return interactionNavigators}function initRubricNavigation(){var rubricNavigators=[],$rubricArea=$("#qti-rubrics"),$itemElements;return $itemElements=$rubricArea.find(".qti-rubricBlock"),$itemElements.each(function(){var $itemElement=$(this),id="rubric_element_navigation_group_"+rubricNavigators.length;rubricNavigators.push(keyNavigator({id:id,elements:navigableDomElement.createFromDoms($itemElement),group:$itemElement,replace:!0}))}),rubricNavigators}function initTestRunnerNavigation(testRunner,config){var keyNavigatorItem,navigators;switch(document.activeElement&&document.activeElement.blur(),config.contentNavigatorType){case"linear":navigators=_.union(initRubricNavigation(testRunner),initAllContentButtonsNavigation(testRunner),initToolbarNavigation(testRunner),initNavigatorNavigation(testRunner),initHeaderNavigation(testRunner));break;default:navigators=_.union(initRubricNavigation(testRunner),initDefaultContentNavigation(testRunner),initToolbarNavigation(testRunner),initNavigatorNavigation(testRunner),initHeaderNavigation(testRunner));}return navigators=navigableGroupElement.createFromNavigators(navigators),keyNavigatorItem=keyNavigator({id:"test-runner",replace:!0,loop:!0,elements:navigators}),keyNavigatorItem.on("tab",function(elem){allowedToNavigateFrom(elem)&&this.next()}).on("shift+tab",function(elem){allowedToNavigateFrom(elem)&&this.previous()}),"linear"===config.contentNavigatorType&&keyNavigatorItem.on("right",function(elem){var isCurrentElementFirst=$(elem).is(":first-child");isCurrentElementFirst&&allowedToNavigateFrom(elem)&&this.next()}).on("left",function(elem){var isCurrentElementLast=$(elem).is(":last-child");isCurrentElementLast&&allowedToNavigateFrom(elem)&&this.previous()}),keyNavigatorItem}function allowedToNavigateFrom(element){var $element=$(element);return!($element.hasClass("no-key-navigation")||0<$element.parents(".no-key-navigation").length)}var defaultPluginConfig={contentNavigatorType:"default"};return pluginFactory({name:"keyNavigation",init:function(){var self=this,testRunner=this.getTestRunner(),testData=testRunner.getTestData()||{},testConfig=testData.config||{},pluginConfig=_.defaults((testConfig.plugins||{})[self.getName()]||{},defaultPluginConfig);this.disable(),testRunner.after("renderitem",function(){self.groupNavigator=initTestRunnerNavigation(testRunner,pluginConfig),shortcut.add("tab shift+tab",function(e){return!!allowedToNavigateFrom(e.target)&&void(!self.groupNavigator.isFocused()&&self.groupNavigator.focus())})}).on("unloaditem",function(){self.disable()}).on("setcontenttabtype",function(type){pluginConfig.contentNavigatorType=type})},destroy:function(){shortcut.remove("."+this.getName()),this.groupNavigator&&this.groupNavigator.destroy()}})}),function(global,factory){"object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&"undefined"!=typeof module?module.exports=factory(require("jquery"),require("lodash")):"function"==typeof define&&define.amd?define("core/pluginifier",["jquery","lodash"],factory):(global=global||self,global["core/pluginifier"]=factory(global.$,global._))}(this,function($,_){'use strict';$=$&&$.hasOwnProperty("default")?$["default"]:$,_=_&&_.hasOwnProperty("default")?_["default"]:_;var basePlugin={options:function options(dataNs,ns,_options){return this.each(function(){var $elt=$(this),currentOptions=$elt.data(dataNs);currentOptions&&$elt.data(dataNs,_.merge(currentOptions,_options))})},disable:function disable(dataNs,ns){return this.each(function(){var $elt=$(this),options=$elt.data(dataNs);options&&$elt.addClass(options.disableClass||"disabled").trigger("disable."+ns)})},enable:function enable(dataNs,ns){return this.each(function(){var $elt=$(this),options=$elt.data(dataNs);options&&$elt.removeClass(options.disableClass||"disabled").trigger("enable."+ns)})}};return{register:function register(pluginName,plugin,config){config=config||{};var ns=config.ns||pluginName.toLowerCase(),dataNs=config.dataNs||"ui."+ns,expose=config.expose||[];return _.isFunction($.fn[pluginName])?$.error("A plugin named "+pluginName+" is already registered"):_.isPlainObject(plugin)&&_.isFunction(plugin.init)?void(_.assign(plugin,_.transform(basePlugin,function(result,prop,key){_.isFunction(prop)&&(result[key]=_.partial(basePlugin[key],dataNs,ns))})),_.forEach(expose,function(toExposeName){var privateMethod=toExposeName,publicMethod=toExposeName;/^_/.test(expose)?publicMethod=publicMethod.replace(/^_/,""):privateMethod="_"+privateMethod,_.isFunction(plugin[privateMethod])&&!_.isFunction(plugin[publicMethod])&&(plugin[publicMethod]=function(){var args=Array.prototype.slice.call(arguments,0),returnValue;return this.each(function(){returnValue=plugin[privateMethod].apply(plugin,[$(this)].concat(args))}),returnValue||this})}),$.fn[pluginName]=function(method){if(plugin[method]){if(/^_/.test(method))$.error("Trying to call a private method `"+method+"`");else return plugin[method].apply(this,Array.prototype.slice.call(arguments,1));}else if("object"===_typeof(method)||!method)return plugin.init.apply(this,arguments);$.error("Method "+method+" does not exist on plugin")}):$.error("The object to register as a jQuery plugin must be a plain object with an `init` method.")}}}),function(global,factory){"object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&"undefined"!=typeof module?module.exports=factory(require("jquery"),require("lodash")):"function"==typeof define&&define.amd?define("core/dataattrhandler",["jquery","lodash"],factory):(global=global||self,global["core/dataattrhandler"]=factory(global.$,global._))}(this,function($,_){'use strict';$=$&&$.hasOwnProperty("default")?$["default"]:$,_=_&&_.hasOwnProperty("default")?_["default"]:_;var defaults={container:!1,listenerEvent:"click",useTarget:!0,bubbled:!1},letDefaultOn=[":radio",":checkbox"],shouldPreventDefault=function($elt){return!$elt.is(letDefaultOn.join(","))},DataAttrHandler=function(attrName,options){var self=this;this.options=_.defaults(options,defaults);var selector="[data-"+attrName+"]";return _.has(this.options,"namespace")&&_.isString(this.options.namespace)?void(this.options.container&&this.options.container.selector&&(selector=this.options.container.selector+" "+selector),this.options.inner&&(selector+=" "+this.options.inner),$(document).off(this.options.listenerEvent,selector).on(this.options.listenerEvent,selector,function(e){var $elt=$(e.target);if(!0===self.options.bubbled||$elt.is(selector)){var $target,$outer;void 0===$elt.data(attrName)&&(self.options.inner||self.options.bubbled)&&($outer=$elt,$elt=$elt.parents("[data-"+attrName+"]")),$target=!0===self.options.useTarget?DataAttrHandler.getTarget(attrName,$elt):self.options.inner?$outer:void 0,$elt.data(self.options.namespace)||("function"==typeof self.createPlugin&&self.createPlugin($elt,$target),$elt.is(":radio")&&$elt.attr("name")&&$(":radio[name=\""+$elt.attr("name")+"\"]").not($elt).on(self.options.listenerEvent,function(e){"function"==typeof self.callPluginMethod&&self.callPluginMethod($elt,$target),shouldPreventDefault($elt)&&e.preventDefault()})),"function"==typeof self.callPluginMethod&&self.callPluginMethod($elt,$target),shouldPreventDefault($elt)&&e.preventDefault()}})):$.error("The plugin data namespace option is required")};return DataAttrHandler.prototype.init=function(cb){return this.createPlugin=cb,this},DataAttrHandler.prototype.trigger=function(cb){return this.callPluginMethod=cb,this},DataAttrHandler.getTarget=function(attrName,$elt){var relativeRegex=/^(\+|>|~|:parent|<)/,$target=[],targetSelector=$elt.attr("data-"+attrName)||$elt.attr("href")||$elt.attr("attrName");if(!_.isEmpty(targetSelector)){var matches=relativeRegex.exec(targetSelector);if(null!==matches){var selector=targetSelector.replace(relativeRegex,"");$target=":parent"===matches[0]||"<"===matches[0]?$elt.parents(selector):"~"===matches[0]?$elt.siblings(selector):"+"===matches[0]?$elt.next(selector):$(selector,$elt)}else $target=$(targetSelector)}return $target},DataAttrHandler}),define("taoQtiTest/runner/plugins/content/dialog/dialog",["jquery","lodash","i18n","taoTests/runner/plugin","ui/dialog/alert","ui/dialog/confirm","util/shortcut/registry","util/shortcut","util/namespace"],function($,_,__,pluginFactory,dialogAlert,dialogConfirm,shortcutRegistry,globalShortcut,namespaceHelper){'use strict';var actionPrefix="tool-dialog-",defaultOptions={alert:{focus:"ok"},confirm:{focus:"ok"}};return pluginFactory({name:"dialog",init:function(){function closeAccept(dialog){dialog.trigger("okbtn.modal").hide()}function closeReject(dialog){dialog.hide()}function closeLast(accept,shortcut){var handle=opened.length&&opened[opened.length-1];handle&&(handle.shortcut=shortcut,accept?closeAccept(handle.dialog):closeReject(handle.dialog))}function addHandle(namespace,stack,dialog,message,accept,reject,options){var handle={context:namespace,dialog:dialog(message,function(e,reason){_.isFunction(accept)&&accept(handle.shortcut||reason)},function(e,reason){_.isFunction(reject)&&reject(handle.shortcut||reason)},options)};globalShortcut.disable(),dialogShortcut.enable(),stack.push(handle),opened.push(handle),handle.dialog.focus(options.focus),handle.dialog.on("closed.modal",function(){removeHandle(stack,handle.dialog),removeHandle(opened,handle.dialog),opened.length||(globalShortcut.enable(),dialogShortcut.disable())})}function removeHandle(stack,dialog){dialog&&_.remove(stack,function(handle){if(handle&&dialog===handle.dialog)return!0})}function closeDialogs(namespace,accept,stack){stack?_.forEach(stack,function(handle){handle&&("@"===namespace||namespace===handle.context)&&(accept?closeAccept(handle.dialog):closeReject(handle.dialog))}):(closeDialogs(namespace,accept,alerts),closeDialogs(namespace,accept,confirms))}var testRunner=this.getTestRunner(),testData=testRunner.getTestData()||{},testConfig=testData.config||{},pluginConfig=_.defaults((testConfig.plugins||{}).dialog||{},defaultOptions),pluginShortcuts=(testConfig.shortcuts||{}).dialog||{},alerts=[],confirms=[],opened=[],dialogShortcut=shortcutRegistry($("body"),{propagate:!1,prevent:!0});dialogShortcut.disable().set("Tab Shift+Tab"),testConfig.allowShortcuts&&_.forEach(pluginShortcuts,function(command,key){dialogShortcut.add(namespaceHelper.namespaceAll(command,"dialog",!0),function(e,shortcut){testRunner.trigger(actionPrefix+key,shortcut)})}),testRunner.before("alert.*",function(e,msg,accept,options){addHandle(e.namespace,alerts,dialogAlert,msg,accept,accept,_.merge({},pluginConfig.alert,options))}).before("confirm.*",function(e,msg,accept,reject,options){addHandle(e.namespace,confirms,dialogConfirm,msg,accept,reject,_.merge({},pluginConfig.confirm,options))}).before("closedialog.*",function(e,accept){closeDialogs(e.namespace,accept)}).on(actionPrefix+"accept",function(shortcut){closeLast(!0,shortcut)}).on(actionPrefix+"reject",function(shortcut){closeLast(!1,shortcut)}).on("destroy",function(){closeDialogs(".@"),dialogShortcut.clear(),dialogShortcut=null})}})}),define("taoQtiTest/runner/plugins/content/dialog/exitMessages",["lodash","core/promise","taoTests/runner/plugin"],function(_,Promise,pluginFactory){'use strict';return pluginFactory({name:"exitMessages",init:function(){},install:function(){var testRunner=this.getTestRunner();testRunner.before("leave",function(e,data){if(_.isObject(data)&&data.message)return new Promise(function(resolve){var context=testRunner.getTestContext();context&&context.itemIdentifier&&testRunner.disableItem(context.itemIdentifier),testRunner.trigger("disablefeedbackalerts").trigger("alert.leave",data.message,function(){testRunner.trigger("enablefeedbackalerts"),resolve()})})})}})}),define("taoQtiTest/runner/plugins/content/dialog/itemAlertMessage",["jquery","i18n","ui/hider","taoTests/runner/plugin"],function($,__,hider,pluginFactory){'use strict';return pluginFactory({name:"itemAlertMessage",init:function(){var self=this;this.$element=$(this.getContent().dom),this.$element.on("closed.modal",function(){$(this).modal("destroy")}).on("destroyed.modal",function(){self.$element=null,self.trigger("resume",self)})},render:function(){var testRunner=this.getTestRunner(),itemRunner=testRunner.itemRunner,$modalsContainer=this.getContent().$container;$modalsContainer||($modalsContainer=$("#modalFeedbacks",itemRunner._item.container)),$modalsContainer.append(this.$element),this.$element.modal({startClosed:!1,top:200})},destroy:function(){this.$element&&this.$element.length&&this.$element.modal("close")}})}),define("tpl!taoQtiTest/runner/plugins/templates/button",["handlebars"],function(hb){return hb.template(function(Handlebars,depth0,helpers,partials,data){function program1(depth0,data){var buffer="",stack1,helper;return buffer+=" ",(helper=helpers.className)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.className,stack1="function"===_typeof(helper)?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1),buffer}function program3(depth0,data){var buffer="",stack1,helper;return buffer+="<span class=\"icon icon-",(helper=helpers.icon)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.icon,stack1="function"===_typeof(helper)?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1),stack1=helpers.unless.call(depth0,depth0&&depth0.text,{hash:{},inverse:self.noop,fn:self.program(4,program4,data),data:data}),(stack1||0===stack1)&&(buffer+=stack1),buffer+="\"></span>",buffer}function program4(){return" no-label"}function program6(depth0,data){var buffer="",stack1,helper;return buffer+="<span class=\"text\">",(helper=helpers.text)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.text,stack1="function"===_typeof(helper)?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+"</span>",buffer}this.compilerInfo=[4,">= 1.0.0"],helpers=this.merge(helpers,Handlebars.helpers),data=data||{};var buffer="",escapeExpression=this.escapeExpression,self=this,stack1,helper;return buffer+="<li data-control=\"",(helper=helpers.control)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.control,stack1="function"===_typeof(helper)?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+"\" class=\"small btn-info action",stack1=helpers["if"].call(depth0,depth0&&depth0.className,{hash:{},inverse:self.noop,fn:self.program(1,program1,data),data:data}),(stack1||0===stack1)&&(buffer+=stack1),buffer+="\" title=\"",(helper=helpers.title)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.title,stack1="function"===_typeof(helper)?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+"\">\n    <a class=\"li-inner\" href=\"#\" onclick=\"return false\">\n        ",stack1=helpers["if"].call(depth0,depth0&&depth0.icon,{hash:{},inverse:self.noop,fn:self.program(3,program3,data),data:data}),(stack1||0===stack1)&&(buffer+=stack1),buffer+="\n        ",stack1=helpers["if"].call(depth0,depth0&&depth0.text,{hash:{},inverse:self.noop,fn:self.program(6,program6,data),data:data}),(stack1||0===stack1)&&(buffer+=stack1),buffer+="\n    </a>\n</li>",buffer})}),define("taoQtiTest/runner/plugins/content/dialog/itemInlineMessage",["jquery","i18n","ui/hider","taoTests/runner/plugin","tpl!taoQtiTest/runner/plugins/templates/button"],function($,__,hider,pluginFactory,buttonTpl){'use strict';var buttonData={next:{control:"move-forward",title:__("Submit and go to the next item"),icon:"forward",text:__("OK")},end:{control:"move-end",title:__("Submit and go to the end of the test"),icon:"fast-forward",text:__("OK & End test")}};return pluginFactory({name:"itemInlineMessage",init:function(){var self=this,testRunner=this.getTestRunner();this.$button=function(){var dataType=testRunner.getTestContext().isLast?"end":"next",$btn=$(buttonTpl(buttonData[dataType]));return $btn.addClass("modalFeedback-button"),$btn.on("click",function(e){e.preventDefault(),self.disable(),"move-end"===$(this).data("control")&&self.trigger("end"),$btn.remove(),self.$element.remove(),self.trigger("resume",self)}),$btn}(),this.$element=$(this.getContent().dom)},render:function(){var $navigationContainer=this.getAreaBroker().getNavigationArea(),testRunner=this.getTestRunner(),itemRunner=testRunner.itemRunner,$inlineContainer=this.getContent().$container;!$inlineContainer&&itemRunner._item.container&&($inlineContainer=$(".qti-itemBody",itemRunner._item.container)),$inlineContainer.append(this.$element),$(".modalFeedback-button",$navigationContainer).length||$navigationContainer.append(this.$button)},enable:function(){this.$button.removeProp("disabled").removeClass("disabled")},disable:function(){this.$button.prop("disabled",!0).addClass("disabled")},destroy:function(){this.$button.click()}})}),function(global,factory){"object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&"undefined"!=typeof module?module.exports=factory():"function"==typeof define&&define.amd?define("util/regexEscape",factory):(global=global||self,global["util/regexEscape"]=factory())}(this,function(){'use strict';return function(s){return s.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}}),function(global,factory){"object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&"undefined"!=typeof module?module.exports=factory(require("util/regexEscape")):"function"==typeof define&&define.amd?define("util/wrapLongWords",["util/regexEscape"],factory):(global=global||self,global["util/wrapLongWords"]=factory(global["util/regexEscape"]))}(this,function(regexEscape){'use strict';function wrapLongWords(str,threshold){str=str.toString().replace(/([\w])</g,"$1 <");for(var chunkExp=new RegExp(".{1,"+threshold+"}","g"),longWords=str.match(new RegExp("[\\S]{"+threshold+",}","g"))||[],i=longWords.length,cut;i--;)cut=getCutTerm(longWords[i],chunkExp),str=str.replace(new RegExp(regexEscape(longWords[i]),"g"),cut);return str}regexEscape=regexEscape&&regexEscape.hasOwnProperty("default")?regexEscape["default"]:regexEscape;var getCutTerm=function(longWord,chunkExp){for(var cutTerms=longWord.match(chunkExp),i=cutTerms.length,oldFirst="",newFirst="",offenders=[".",":",";"];i--;)newFirst=cutTerms[i].charAt(0),-1<offenders.indexOf(newFirst)&&(cutTerms[i]=cutTerms[i].substr(1)),-1<offenders.indexOf(oldFirst)&&(cutTerms[i]+=oldFirst),oldFirst=newFirst;return cutTerms.join(" ")};return wrapLongWords}),function(global,factory){"object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&"undefined"!=typeof module?module.exports=factory():"function"==typeof define&&define.amd?define("util/encode",factory):(global=global||self,global["util/encode"]=factory())}(this,function(){'use strict';var _reQuot=/"/g,_reApos=/'/g,encodeHTML=function(html){return document.createElement("a").appendChild(document.createTextNode(html)).parentNode.innerHTML};return{html:encodeHTML,attribute:function(html){return encodeHTML(html).replace(_reQuot,"&quot;").replace(_reApos,"&apos;")},encodeBase64:function(str){return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g,function(match,p1){return String.fromCharCode("0x"+p1)}))},decodeBase64:function(str){return decodeURIComponent(Array.prototype.map.call(atob(str),function(c){return"%"+("00"+c.charCodeAt(0).toString(16)).slice(-2)}).join(""))}}}),define("taoQtiTest/runner/plugins/content/feedback/feedback",["jquery","i18n","taoTests/runner/plugin","ui/feedback"],function($,__,pluginFactory,feedback){'use strict';return pluginFactory({name:"feedback",init:function(){var self=this,testRunner=this.getTestRunner(),closeCurrent=function(){currentFeedback&&currentFeedback.close()},currentFeedback;this.setState("enabled",!0),testRunner.on("error",function(err){var message=err,type="error";self.getState("enabled")&&("object"===_typeof(err)&&(message=err.message,type=err.type),message||(message="TestState"===type?__("The test has been closed/suspended!"):"FileNotFound"===type?__("File not found!"):__("An error occurred!")),currentFeedback=feedback().error(message))}).on("danger",function(message){self.getState("enabled")&&(currentFeedback=feedback().danger(message))}).on("warning",function(message){self.getState("enabled")&&(currentFeedback=feedback().warning(message))}).on("info",function(message){self.getState("enabled")&&(currentFeedback=feedback().info(message))}).on("alert.* confirm.* unloaditem",closeCurrent).on("disablefeedbackalerts",function(){closeCurrent(),self.setState("enabled",!1)}).on("enablefeedbackalerts",function(){self.setState("enabled",!0)})}})}),define("taoQtiTest/runner/plugins/content/loading/loading",["layout/loading-bar","taoTests/runner/plugin"],function(loadingBar,pluginFactory){'use strict';return pluginFactory({name:"loading",init:function(){var testRunner=this.getTestRunner();testRunner.on("unloaditem",function(){loadingBar.start()}).on("renderitem",function(){loadingBar.stop()})}})}),define("taoQtiTest/runner/plugins/content/modalFeedback/modalFeedback",["jquery","lodash","module","taoTests/runner/plugin","taoQtiTest/runner/plugins/content/dialog/itemInlineMessage","taoQtiTest/runner/plugins/content/dialog/itemAlertMessage","ui/autoscroll"],function($,_,module,pluginFactory,inlineMessage,alertMessage,autoscroll){'use strict';function destroyFeedback(feedback){var removed=!1;_.remove(renderedFeedbacks,function(storedFeedback){var found=storedFeedback===feedback;return found&&(removed=!0),found}),removed&&(feedback.destroy(),!renderedFeedbacks.length&&nextStep())}function defineMode(inline){inlineMode=inline,messagePlugin=inlineMode?inlineMessage:alertMessage}var inlineMode,messagePlugin,renderedFeedbacks,isDestroyed,nextStep;return pluginFactory({name:"QtiModalFeedback",init:function(){nextStep=function(){},defineMode(!!module.config().inlineModalFeedback)},render:function(){var self=this,testRunner=this.getTestRunner(),createMessages=function(renderingQueue,inline){var bInlineMode=inlineMode;isDestroyed=!1,renderedFeedbacks=[],_.isBoolean(inline)&&defineMode(inline),renderingQueue.length?(_.forEach(renderingQueue,function(renderingToken){var feedback=messagePlugin(testRunner,testRunner.getAreaBroker());feedback.init({dom:renderingToken.feedback.render({inline:inlineMode}),$container:inlineMode?renderingToken.$container:null}),feedback.render(),renderedFeedbacks.push(feedback)}),inlineMode&&renderedFeedbacks&&autoscroll($(".qti-modalFeedback",testRunner.getAreaBroker().getContentArea()).first(),testRunner.getAreaBroker().getContentArea().parents(".content-wrapper"))):nextStep(),defineMode(bInlineMode)};inlineMode?testRunner.off("plugin-resume.itemInlineMessage").on("plugin-resume.itemInlineMessage",function(){self.destroy()}):testRunner.off("plugin-resume.itemAlertMessage").on("plugin-resume.itemAlertMessage",function(feedback){destroyFeedback(feedback)}),testRunner.on("modalFeedbacks",function(renderingQueue,done,inline){nextStep=done,createMessages(renderingQueue,inline)})},destroy:function(){var tFeedbacks,i;if(!isDestroyed)if(isDestroyed=!0,!renderedFeedbacks)nextStep();else for(i in tFeedbacks=renderedFeedbacks.slice(0),tFeedbacks)destroyFeedback(tFeedbacks[i])}})}),define("taoQtiTest/runner/plugins/content/overlay/overlay",["jquery","i18n","taoTests/runner/plugin"],function($,__,pluginFactory){'use strict';return pluginFactory({name:"overlay",init:function(){var self=this,testRunner=this.getTestRunner();this.$element=$("<div />"),this.$element.on("click mousedown mouseup touchstart touchend keyup keydow keypress scroll drop",function(e){e.stopImmediatePropagation(),e.stopPropagation()});testRunner.on("disableitem",function(){self.enable()}).on("enableitem unloaditem",function(){self.disable()})},render:function(){var $contentArea=this.getTestRunner().getAreaBroker().getContentArea();$contentArea.after(this.$element)},destroy:function(){this.$element.remove()},enable:function(){var testRunner=this.getTestRunner(),testData=testRunner.getTestData()||{},testConfig=testData.config||{},pluginsConfig=testConfig.plugins||{},overlayConfig=pluginsConfig.overlay||{};this.$element.addClass("overlay"),overlayConfig.full&&this.$element.addClass("overlay-full")},disable:function(){this.$element.removeClass("overlay overlay-full")},show:function(){this.enable()},hide:function(){this.disable()}})}),define("taoQtiTest/runner/plugins/content/responsiveness/collapser",["lodash","jquery","taoTests/runner/plugin"],function(_,$,pluginFactory){'use strict';var labelHiddenCls="no-tool-label",separatorCls="separator",defaults={collapseTools:!0,collapseNavigation:!1,collapseInOrder:!1,hover:!1,collapseOrder:[]},$window=$(window);return pluginFactory({name:"collapser",init:function(){function buildCollapsiblesList(){allCollapsibles=config.collapseInOrder&&config.collapseOrder.length?getCollapsiblesFromConfig():config.collapseInOrder?getSortedCollapsiblesFromDom():getUnsortedCollapsiblesFromDom()}function getExtraWidth($element){var expandedWidth,collapsedWidth;return $element.removeClass(collapseCls),expandedWidth=$element.outerWidth(!0),$element.addClass(collapseCls),collapsedWidth=$element.outerWidth(!0),$element.removeClass(collapseCls),expandedWidth-collapsedWidth}function toggleCollapsibles(){availableWidth=getAvailableWidth(),availableWidth<previousAvailableWidth?collapseInOrder():expandInOrder(),previousAvailableWidth=availableWidth}function collapseInOrder(){for(var collapsiblesCopy=_.clone(allCollapsibles),toCollapse;collapseNeeded()&&collapsiblesCopy.length;)toCollapse=collapsiblesCopy.shift(),toCollapse.$elements.addClass(collapseCls)}function collapseNeeded(){return getToolbarWidth()>getAvailableWidth()}function expandInOrder(){_.forEachRight(allCollapsibles,function(toExpand){if(toExpand.$elements.hasClass(collapseCls))if(expandPossible(toExpand.extraWidth))toExpand.$elements.removeClass(collapseCls);else return!1})}function expandPossible(extraWidth){return getToolbarWidth()+extraWidth<getAvailableWidth()}function getAvailableWidth(){return $actionsBar.width()-20}function getToolbarWidth(){return $toolbox.outerWidth(!0)+$navigation.outerWidth(!0)}function getControlsFromDom(){var $controls=$();return config.collapseTools&&($controls=$controls.add($toolbox.find(">ul>[data-control]").not("."+labelHiddenCls).not("."+separatorCls))),config.collapseNavigation&&($controls=$controls.add($navigation.find(">ul>[data-control]").not("."+labelHiddenCls).not("."+separatorCls))),$controls}function getCollapsiblesFromConfig(){return _.compact(config.collapseOrder.map(function(selector){var $elements=$(selector).not("."+labelHiddenCls).not("."+separatorCls),extraWidth=0;return!!$elements.length&&($elements.each(function(){extraWidth+=getExtraWidth($(this))}),{$elements:$elements,extraWidth:extraWidth})}))}function getSortedCollapsiblesFromDom(){var $elements=getControlsFromDom(),_allCollapsibles=[],order={};return $elements.each(function(){var ctrl=this.dataset.control,key=ctrl.substring(0,ctrl.search(/[A-Z-_]/))||ctrl;order[key]=order[key]||$(),order[key]=order[key].add($(this))}),_.forOwn(order,function($elements){var extraWidth=0;$elements.each(function(){extraWidth+=getExtraWidth($(this))}),_allCollapsibles.push({$elements:$elements,extraWidth:extraWidth})}),_.compact(_allCollapsibles)}function getUnsortedCollapsiblesFromDom(){var $elements=getControlsFromDom(),_allCollapsibles=[],extraWidth=0;return $elements.each(function(){extraWidth+=getExtraWidth($(this))}),_allCollapsibles.push({$elements:$elements,extraWidth:extraWidth}),_.compact(_allCollapsibles)}var testRunner=this.getTestRunner(),testData=testRunner.getTestData()||{},testConfig=testData.config||{},pluginsConfig=testConfig.plugins||{},config=_.defaults(pluginsConfig.collapser||{},defaults),collapseCls=config.hover?"tool-label-collapsed-hover":"tool-label-collapsed",areaBroker=testRunner.getAreaBroker(),$actionsBar=areaBroker.getArea("actionsBar"),$toolbox=areaBroker.getToolboxArea(),$navigation=areaBroker.getNavigationArea(),allCollapsibles,availableWidth,previousAvailableWidth;$window.on("resize.collapser",_.throttle(function(){testRunner.trigger("collapseTools")},40)),testRunner.after("renderitem loaditem",function(){previousAvailableWidth=1/0,buildCollapsiblesList(),testRunner.trigger("collapseTools")}).on("collapseTools.collapser",function(){toggleCollapsibles()})},destroy:function(){$window.off(".collapser")}})}),define("tpl!taoQtiTest/runner/plugins/content/rubricBlock/rubricBlock",["handlebars"],function(hb){return hb.template(function(Handlebars,depth0,helpers,partials,data){return this.compilerInfo=[4,">= 1.0.0"],helpers=this.merge(helpers,Handlebars.helpers),data=data||{},"<div id=\"qti-rubrics\"></div>"})}),define("taoQtiTest/runner/plugins/content/rubricBlock/rubricBlock",["jquery","i18n","core/promise","ui/hider","taoTests/runner/plugin","tpl!taoQtiTest/runner/plugins/content/rubricBlock/rubricBlock"],function($,__,Promise,hider,pluginFactory,containerTpl){'use strict';var blankifyLinks=function($container){$("a",$container).attr("target","_blank")},mathify=function($container){return new Promise(function(resolve){0<$("math",$container).length?require(["mathJax"],function(MathJax){MathJax?(MathJax.Hub.Queue(["Typeset",MathJax.Hub],$container[0]),MathJax.Hub.Queue(resolve)):resolve()},resolve):resolve()})};return pluginFactory({name:"rubricBlock",init:function(){var self=this,testRunner=this.getTestRunner();this.$element=$(containerTpl()),this.hide(),testRunner.on("ready",function(){self.hide()}).on("loaditem",function(){var context=testRunner.getTestContext();context.rubrics&&(self.$element.html(context.rubrics),blankifyLinks(self.$element),mathify(self.$element).then(function(){testRunner.trigger("rubricblock")}))}).on("renderitem",function(){self.show()}).on("unloaditem",function(){self.hide(),self.$element.empty()})},render:function(){var $container=this.getAreaBroker().getContentArea();$container.before(this.$element)},destroy:function(){this.$element.remove()},enable:function(){this.$element.removeProp("disabled").removeClass("disabled")},disable:function(){this.$element.prop("disabled",!0).addClass("disabled")},show:function(){hider.show(this.$element)},hide:function(){hider.hide(this.$element)}})}),function(global,factory){"object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&"undefined"!=typeof module?module.exports=factory(require("lodash"),require("core/promise"),require("core/eventifier")):"function"==typeof define&&define.amd?define("core/polling",["lodash","core/promise","core/eventifier"],factory):(global=global||self,global["core/polling"]=factory(global._,global["core/promise"],global["core/eventifier"]))}(this,function(_,Promise,eventifier){'use strict';_=_&&_.hasOwnProperty("default")?_["default"]:_,Promise=Promise&&Promise.hasOwnProperty("default")?Promise["default"]:Promise,eventifier=eventifier&&eventifier.hasOwnProperty("default")?eventifier["default"]:eventifier;var pollingFactory=function(config){var _Mathabs=Math.abs,state={},startTimer=function(){timer=setTimeout(iteration,interval),state.stopped=!1,state.pending=!0},stopTimer=function(){clearTimeout(timer),timer=null,state.stopped=!0,state.pending=!1},iteration=function(){return max&&iter>=max?void polling.stop():void(iter=(iter||0)+1,state.processing=!0,state.pending=!1,polling.trigger("call"),action.call(context,polling),!promise&&!state.stopped&&(state.processing=!1,startTimer()))},polling={async:function(){var resolver={};return promise=new Promise(function(resolve,reject){resolver.resolve=resolve,resolver.reject=reject}),promise.then(function(){promise=null,state.processing=!1,state.stopped||startTimer(),polling.trigger("resolved")}).catch(function(){promise=null,state.processing=!1,polling.stop(),polling.trigger("rejected")}),polling.trigger("async",resolver),resolver},next:function(){var _next;return(state.stopped&&(iter=0),stopTimer(),max&&iter>=max)?this:(state.stopped=!1,promise?(_next=this.next.bind(this),promise.then(_next).catch(_next)):(this.trigger("next"),iteration()),this)},start:function(){return timer||(iter=0,startTimer(),this.trigger("start")),this},stop:function(){return stopTimer(),this.trigger("stop"),this},setInterval:function(value){return interval=_Mathabs(parseInt(value,10)||60000),this.trigger("setinterval",interval),this},getInterval:function(){return interval},setAction:function(fn){return action=fn,this.trigger("setaction",action),this},getAction:function(){return action},setContext:function(ctx){return context=ctx||this,this.trigger("setcontext",ctx),this},getContext:function(){return context},setMax:function(value){return max=_Mathabs(parseInt(value,10)||0),this},getMax:function(){return max},getIteration:function(){return iter||0},is:function(stateName){return!!state[stateName]}},timer,promise,interval,max,iter,action,context,autoStart;return eventifier(polling),interval=60000,context=polling,action=null,state.stopped=!0,autoStart=!1,iter=0,_.isFunction(config)&&(polling.setAction(config),config=null),_.isObject(config)&&(polling.setAction(config.action),polling.setInterval(config.interval||arguments[1]),polling.setContext(config.context),polling.setMax(config.max),autoStart=!!config.autoStart),autoStart&&polling.start(),polling};return pollingFactory}),define("tpl!taoQtiTest/runner/plugins/controls/connectivity/connectivity",["handlebars"],function(hb){return hb.template(function(Handlebars,depth0,helpers,partials,data){this.compilerInfo=[4,">= 1.0.0"],helpers=this.merge(helpers,Handlebars.helpers),data=data||{};var buffer="",escapeExpression=this.escapeExpression,helperMissing=helpers.helperMissing,stack1,helper,options;return buffer+="<div class=\"connectivity-box ",(helper=helpers.state)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.state,stack1="function"===_typeof(helper)?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+"\">\n    <span data-control=\"connectivity-connected\" class=\"qti-controls icon-connect\" title=\""+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Connected to server",options):helperMissing.call(depth0,"__","Connected to server",options)))+"\"></span>\n    <span data-control=\"connectivity-disconnected\" class=\"qti-controls icon-disconnect\" title=\""+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Disconnected from server",options):helperMissing.call(depth0,"__","Disconnected from server",options)))+"\"></span>\n</div>",buffer})}),define("taoQtiTest/runner/plugins/controls/connectivity/connectivity",["jquery","lodash","i18n","core/promise","core/polling","ui/waitingDialog/waitingDialog","taoTests/runner/plugin","tpl!taoQtiTest/runner/plugins/controls/connectivity/connectivity"],function($,_,__,Promise,pollingFactory,waitingDialog,pluginFactory,connectivityTpl){'use strict';var defaultConfig={checkInterval:30000,indicator:!0};return pluginFactory({name:"connectivity",init:function(){var self=this,testRunner=this.getTestRunner(),proxy=testRunner.getProxy(),config=_.defaults(this.getConfig()||{},defaultConfig);config&&config.indicator&&(this.$element=$(connectivityTpl({state:proxy.isOnline()?"connected":"disconnected"})),testRunner.on("disconnect",function(){self.$element.removeClass("connected").addClass("disconnected")}).on("reconnect",function(){self.$element.removeClass("disconnected").addClass("connected")})),this.polling&&_.isNumber(config.checkInterval)&&this.polling.setInterval(config.checkInterval)},install:function(){var self=this,waiting=!1,testRunner=this.getTestRunner(),proxy=testRunner.getProxy();this.displayWaitingDialog=function(message){var dialog;return new Promise(function(resolve){waiting||(waiting=!0,testRunner.before("pause.waiting",function(){return new Promise(function(pauseResolve){proxy.off("reconnect.pausing").after("reconnect.pausing",pauseResolve)})}),dialog=waitingDialog({message:__("You are encountering a prolonged connectivity loss. ")+message,waitContent:__("Please wait while we try to restore the connection."),proceedContent:__("The connection seems to be back, please proceed")}).on("proceed",function(){resolve()}).on("render",function(){proxy.off("reconnect.waiting").after("reconnect.waiting",function(){testRunner.off("pause.waiting"),waiting=!1,dialog.endWait()})}))})},this.polling=pollingFactory({action:function(){testRunner.getProxy().telemetry(testRunner.getTestContext().itemIdentifier,"up").catch(_.noop)},interval:defaultConfig.checkInterval,autoStart:!1}),proxy.on("disconnect",function(source){testRunner.getState("disconnected")||(testRunner.setState("disconnected",!0),testRunner.trigger("disconnect",source),self.polling.start())}).on("reconnect",function(){testRunner.getState("disconnected")&&(testRunner.setState("disconnected",!1),testRunner.trigger("reconnect"),self.polling.stop())}),testRunner.before("leave",function(e,data){if(proxy.isOffline())return self.displayWaitingDialog(data.message).then(function(){testRunner.trigger("leave",data)}).catch(function(generalErr){testRunner.trigger("error",generalErr)}),!1}),testRunner.before("error.connectivity",function(e,err){return!proxy.isConnectivityError(err)&&(proxy.isOffline()?(self.displayWaitingDialog(err.message).then(function(){"nav"===err.type&&testRunner.loadItem(testRunner.getTestContext().itemIdentifier),"finish"===err.type&&testRunner.finish(),"pause"===err.type&&testRunner.trigger("pause",{reasons:err.data&&err.data.reasons,message:err.data&&err.data.comment})}).catch(function(generalErr){testRunner.trigger("error",generalErr)}),!1):void 0)})},render:function(){var $container=this.getAreaBroker().getControlArea();this.$element&&$container.append(this.$element)}})}),function(global,factory){"object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&"undefined"!=typeof module?module.exports=factory():"function"==typeof define&&define.amd?define("core/timer",factory):(global=global||self,global["core/timer"]=factory())}(this,function(){'use strict';return function(config){function now(){return window.performance.now()}var initConfig=config||{},begin=now(),last=begin,duration=initConfig.startDuration||0,state={},disableAutoStart=!1===initConfig.autoStart,timer={start:function(startDuration){return begin=now(),last=begin,duration=startDuration||0,state.running=!0,state.started=!0,this},tick:function(){var timestamp=now(),elapsed;return state.running&&(elapsed=timestamp-last,last=timestamp),elapsed},pause:function(){return state.running&&(duration+=now()-begin,state.running=!1),this},resume:function(){return state.running||(begin=now(),last=begin,state.started=!0,state.running=!0),this},stop:function(){return state.running&&(duration+=now()-begin),state.running=!1,state.started=!1,this},getDuration:function(){return state.running?duration+(now()-begin):duration},is:function(stateName){return!!state[stateName]},add:function(time){return time=parseFloat(time),duration+=time,last-=time,this},sub:function(time){return time=parseFloat(time),duration-=time,last+=time,this}};return disableAutoStart||timer.start(initConfig.startDuration),timer}}),define("taoQtiTest/runner/plugins/controls/duration/duration",["lodash","core/polling","core/timer","core/promise","taoTests/runner/plugin"],function(_,pollingFactory,timerFactory,Promise,pluginFactory){'use strict';return pluginFactory({name:"duration",install:function(){this.getTestRunner().getTestStore().setVolatile(this.getName())},init:function(){var self=this,testRunner=this.getTestRunner();return testRunner.getPluginStore(this.getName()).then(function(durationStore){function getItemDuration(attemptId){return /^(.*)+#+\d+$/.test(attemptId)?durationStore.getItem(attemptId):Promise.reject(new Error("Is it really an attempt id, like \"itemid#attempt\""))}self.stopwatch=timerFactory({autoStart:!1}),self.polling=pollingFactory({action:function(){var context=testRunner.getTestContext(),itemAttemptId=context.itemIdentifier+"#"+context.attempt;durationStore.getItem(itemAttemptId).then(function(duration){var elapsed=self.stopwatch.tick();duration=_.isNumber(duration)?duration:0,elapsed=_.isNumber(elapsed)&&0<elapsed?elapsed/1e3:0,durationStore.setItem(itemAttemptId,duration+elapsed)})},interval:1000,autoStart:!1}),testRunner.after("renderitem",function(){self.enable()}).on("enableitem",function(){self.enable()}).before("move skip exit timeout",function(){var context=testRunner.getTestContext(),itemAttemptId=context.itemIdentifier+"#"+context.attempt;return getItemDuration(itemAttemptId).then(function(duration){var params={itemDuration:0};_.isNumber(duration)&&0<duration&&(params.itemDuration=duration),testRunner.getProxy().addCallActionParams(params)})}).on("move skip exit timeout error disableitem",function(){self.disable()}).on("plugin-get.duration",function(e,attemptId,getDuration){_.isFunction(getDuration)&&getDuration(getItemDuration(attemptId))})})},destroy:function(){this.polling.stop(),this.stopwatch.stop()},enable:function(){this.getState("enabled")||(this.polling.start(),this.stopwatch.resume())},disable:function(){this.getState("enabled")&&(this.polling.stop(),this.stopwatch.pause())}})}),define("taoQtiTest/runner/helpers/map",["lodash"],function(_){'use strict';function getEmptyStats(){return{questions:0,answered:0,flagged:0,viewed:0,total:0,questionsViewed:0}}return{getJumps:function(map){return map&&map.jumps},getParts:function(map){return map&&map.parts},getSections:function(map){var parts=this.getParts(map),result={};return _.forEach(parts,function(part){var sections=part.sections;sections&&_.forEach(sections,function(section){result[section.id]=section})}),result},getActiveItem:function(map){var parts=this.getParts(map),result={};return _.forEach(parts,function(part){var sections=part.sections;sections&&_.forEach(sections,function(section){if(section.active){var items=section.items;_.forEach(items,function(item){item.active&&(result=item)})}})}),result},getNextSections:function(map,sectionId){var sections=this.getSections(map),result={},canList=!1;return _.forEach(sections,function(section){canList&&(result[section.id]=section),section.id===sectionId&&(canList=!0)}),result},getJump:function(map,position){var jumps=this.getJumps(map);return jumps&&jumps[position]},getPart:function(map,partName){var parts=this.getParts(map);return parts&&parts[partName]},getSection:function(map,sectionName){var parts=this.getParts(map),section=null;return _.forEach(parts,function(part){var sections=part.sections;if(sections&&sections[sectionName])return section=sections[sectionName],!1}),section},getItem:function(map,itemName){var jump=_.find(this.getJumps(map),{identifier:itemName});return this.getItemAt(map,jump&&jump.position)},getTestStats:function(map){return map&&map.stats},getPartStats:function(map,partName){var part=this.getPart(map,partName);return part&&part.stats},getSectionStats:function(map,sectionName){var section=this.getSection(map,sectionName);return section&&section.stats},getScopeStats:function(map,position,scope){var jump=this.getJump(map,position);switch(scope){case"section":case"testSection":return this.getSectionStats(map,jump&&jump.section);case"part":case"testPart":return this.getPartStats(map,jump&&jump.part);default:case"test":return this.getTestStats(map);}},getScopeMap:function(map,position,scope){var scopeMap=_.cloneDeep(map||{}),jump=this.getJump(scopeMap,position),part=this.getPart(scopeMap,jump&&jump.part),section=this.getSection(scopeMap,jump&&jump.section);return scope&&"test"!==scope&&(scopeMap.parts={},part&&(scopeMap.parts[jump.part]=part)),part&&("section"===scope||"testSection"===scope)&&(part.sections={},section&&(part.sections[jump.section]=section)),section&&(section.stats=this.computeItemStats(section.items)),part&&(part.stats=this.computeStats(part.sections)),scopeMap.stats=this.computeStats(scopeMap.parts),scopeMap},getScopeMapFromContext:function(map,context,scope){var scopeMap=_.cloneDeep(map||{}),part,section;return context&&context.testPartId&&(part=this.getPart(scopeMap,context.testPartId)),context&&context.sectionId&&(section=this.getSection(scopeMap,context.sectionId)),scope&&"test"!==scope&&(scopeMap.parts={},part&&(scopeMap.parts[context.testPartId]=part)),part&&("section"===scope||"testSection"===scope)&&(part.sections={},section&&(part.sections[context.sectionId]=section)),section&&(section.stats=this.computeItemStats(section.items)),part&&(part.stats=this.computeStats(part.sections)),scopeMap.stats=this.computeStats(scopeMap.parts),scopeMap},getItemPart:function(map,position){var jump=this.getJump(map,position);return this.getPart(map,jump&&jump.part)},getItemSection:function(map,position){var jump=this.getJump(map,position),part=this.getPart(map,jump&&jump.part),sections=part&&part.sections;return sections&&sections[jump&&jump.section]},getItemAt:function(map,position){var jump=this.getJump(map,position),part=this.getPart(map,jump&&jump.part),sections=part&&part.sections,section=sections&&sections[jump&&jump.section],items=section&&section.items;return items&&items[jump&&jump.identifier]},getItemIdentifier:function(map,position){var item;return item=_.isFinite(position)?this.getItemAt(map,position):this.getItem(map,position),item&&item.id},each:function(map,callback){return _.isFunction(callback)&&_.forEach(map&&map.parts,function(part){_.forEach(part&&part.sections,function(section){_.forEach(section&&section.items,function(item){callback(item,section,part,map)})})}),map},updateItemStats:function(map,position){var jump=this.getJump(map,position),part=this.getPart(map,jump&&jump.part),sections=part&&part.sections,section=sections&&sections[jump&&jump.section];return section&&(section.stats=this.computeItemStats(section.items)),part&&(part.stats=this.computeStats(part.sections)),map&&(map.stats=this.computeStats(map.parts)),map},computeItemStats:function(items){return _.reduce(items,function(acc,item){return item.informational||(acc.questions++,item.answered&&acc.answered++,item.viewed&&acc.questionsViewed++),item.flagged&&acc.flagged++,item.viewed&&acc.viewed++,acc.total++,acc},getEmptyStats())},computeStats:function(collection){return _.reduce(collection,function(acc,item){return acc.questions+=item.stats.questions,acc.answered+=item.stats.answered,acc.flagged+=item.stats.flagged,acc.viewed+=item.stats.viewed,acc.total+=item.stats.total,acc.questionsViewed+=item.stats.questionsViewed,acc},getEmptyStats())},patch:function(currentMap,partialMap){var self=this,targetMap;if(!_.isPlainObject(partialMap)||!partialMap.parts)throw new TypeError("Invalid test map format");return currentMap&&"test"!==partialMap.scope?(targetMap=_.cloneDeep(currentMap),_.forEach(partialMap.parts,function(partialPart,targetPartId){"part"===partialMap.scope&&(targetMap.parts[targetPartId]=_.cloneDeep(partialPart)),"section"===partialMap.scope&&_.forEach(partialPart.sections,function(partialSection,targetSectionId){targetMap.parts[targetPartId].sections[targetSectionId]=_.cloneDeep(partialSection),targetMap.parts[targetPartId].sections[targetSectionId].stats=self.computeItemStats(targetMap.parts[targetPartId].sections[targetSectionId].items)}),targetMap.parts[targetPartId].stats=self.computeStats(targetMap.parts[targetPartId].sections)}),targetMap.stats=this.computeStats(targetMap.parts)):targetMap=_.cloneDeep(partialMap),targetMap=this.reindex(targetMap),targetMap},reindex:function(map){var offset=0,offsetPart=0,offsetSection=0,lastPartId,lastSectionId;if(!_.isPlainObject(map)||!map.parts)throw new TypeError("Invalid test map format");return map.jumps=[],_.sortBy(map&&map.parts,"position").forEach(function(part){_.sortBy(part&&part.sections,"position").forEach(function(section){_.sortBy(section&&section.items,"position").forEach(function(item){lastPartId!==part.id&&(offsetPart=0,lastPartId=part.id,part.position=offset),lastSectionId!==section.id&&(offsetSection=0,lastSectionId=section.id,section.position=offset),item.position=offset,item.index=offsetSection+1,item.positionInPart=offsetPart,item.positionInSection=offsetSection,map.jumps[offset]={identifier:item.id,section:section.id,part:part.id,position:offset},offset++,offsetSection++,offsetPart++})})}),map},createJumpTable:function(map){if(!_.isPlainObject(map)||!map.parts)throw new TypeError("Invalid test map format");return map.jumps=[],this.each(map,function(item,section,part){var offset=item.position;map.jumps[offset]={identifier:item.id,section:section.id,part:part.id,position:offset}}),map}}}),define("taoQtiTest/runner/plugins/controls/progressbar/progress",["lodash","i18n","core/format","taoQtiTest/runner/helpers/map"],function(_,__,format,mapHelper){'use strict';function getFixedMap(testMap,testContext){var item;return testContext.itemAnswered&&testContext.isLinear&&(testMap=_.cloneDeep(testMap),item=mapHelper.getItemAt(testMap,testContext.itemPosition),item.answered=!1),testMap}function getEmptyStats(){return{position:0,reached:0,viewed:0,completed:0,total:0}}function updateStats(stats,element,position){element.position<=position&&stats.position++,element.stats.viewed&&(stats.reached++,element.stats.viewed===element.stats.total&&stats.viewed++),element.stats.answered&&element.stats.answered===element.stats.questions&&stats.completed++,stats.total++}function updateItemStats(stats,element,position){element.position<=position&&stats.position++,element.viewed&&(stats.reached++,stats.viewed++),element.answered&&stats.completed++,stats.total++}function getCategoriesToMatch(categories){var matchSize=categories&&categories.length;return matchSize&&_.reduce(categories,function(map,category){return map[category]=!0,map},{})}function getProgressStats(testMap,testContext,config,scope){var fixedMap=getFixedMap(testMap,testContext),scopedMap=mapHelper.getScopeMap(fixedMap,testContext.itemPosition,scope),stats=_.clone(scopedMap.stats),categoriesToMatch,matchSize;return"categories"===config.indicator&&(categoriesToMatch=getCategoriesToMatch(config.categories),matchSize=config.categories&&config.categories.length,stats.matchedCategories=getEmptyStats()),stats.parts=getEmptyStats(),stats.sections=getEmptyStats(),stats.answerableParts=getEmptyStats(),stats.answerableSections=getEmptyStats(),_.forEach(scopedMap.parts,function(part){updateStats(stats.parts,part,testContext.itemPosition),0<part.stats.questions&&updateStats(stats.answerableParts,part,testContext.itemPosition),_.forEach(part.sections,function(section){updateStats(stats.sections,section,testContext.itemPosition),0<section.stats.questions&&updateStats(stats.answerableSections,section,testContext.itemPosition),"categories"===config.indicator&&_.forEach(section.items,function(item){matchCategories(item.categories,categoriesToMatch,matchSize)&&updateItemStats(stats.matchedCategories,item,testContext.itemPosition)})})}),stats}function matchCategories(categories,expectedCategories,minWanted){var matched=0;return expectedCategories&&_.forEach(categories,function(category){if(expectedCategories[category]&&(matched++,matched>=minWanted))return!1}),matched===minWanted}function getRatio(position,total){var _Mathfloor=Math.floor;return position&&0<total?_Mathfloor(100*(position/total)):0}function getProgressionLabel(position,total,type,config){var patterns=labels[type]||labels.item,pattern=config.showTotal?patterns.long:patterns.short;return format(pattern,position||"0",total||"0")}function getPositionProgression(position,total,type,config){return{position:position||0,total:total||0,ratio:getRatio(position,total),label:getProgressionLabel(position,total,type,config)}}function getRatioProgression(position,total){var ratio=getRatio(position,total);return{position:position||0,total:total||0,ratio:ratio,label:ratio+"%"}}var defaultConfig={scope:"test",indicator:"percentage",showTotal:!0,categories:[]},labels={item:{long:__("Item %d of %d"),short:__("Item %d")},section:{long:__("Section %d of %d"),short:__("Section %d")}},scopes={test:function(testMap,testContext,config){var stats=getProgressStats(testMap,testContext,config,"test"),item=mapHelper.getItemAt(testMap,testContext.itemPosition);return stats.position=item.position+1,stats},testPart:function(testMap,testContext,config){var stats=getProgressStats(testMap,testContext,config,"testPart"),item=mapHelper.getItemAt(testMap,testContext.itemPosition);return stats.position=item.positionInPart+1,stats},testSection:function(testMap,testContext,config){var stats=getProgressStats(testMap,testContext,config,"testSection"),item=mapHelper.getItemAt(testMap,testContext.itemPosition);return stats.position=item.positionInSection+1,stats}},indicators={percentage:function(stats){return getRatioProgression(stats.answered,stats.questions)},position:function(stats,config){return getPositionProgression(stats.position,stats.total,"item",config)},questions:function(stats,config){return getPositionProgression(stats.questionsViewed,stats.questions,"item",config)},sections:function(stats,config){return getPositionProgression(stats.answerableSections.reached,stats.answerableSections.total,"section",config)},categories:function(stats,config){return getPositionProgression(stats.matchedCategories.position,stats.matchedCategories.total,"item",config)}};return{isMatchedCategories:function(categories,expectedCategories){var categoriesToMatch=getCategoriesToMatch(expectedCategories),matchSize=expectedCategories&&expectedCategories.length;return matchCategories(categories,categoriesToMatch,matchSize)},computeStats:function(testMap,testContext,config){var statsComputer=config.scope&&scopes[config.scope]||scopes.test,stats=statsComputer(testMap,testContext,config||defaultConfig);return stats.overallCompleted=testContext.numberCompleted,stats.overall=testContext.numberItems,stats},computeIndicator:function(stats,type,config){var indicatorComputer=type&&indicators[type]||indicators.percentage;return indicatorComputer(stats||{},config||defaultConfig)},computeProgress:function(testMap,testContext,config){var progressData;return config=_.defaults(config||{},defaultConfig),progressData=this.computeStats(testMap,testContext,config),this.computeIndicator(progressData,config.indicator,config)}}}),define("tpl!taoQtiTest/runner/plugins/controls/progressbar/renderer/percentage",["handlebars"],function(hb){return hb.template(function(Handlebars,depth0,helpers,partials,data){return this.compilerInfo=[4,">= 1.0.0"],helpers=this.merge(helpers,Handlebars.helpers),data=data||{},"<div class=\"progress-box\">\n    <div data-control=\"progress-bar\" class=\"qti-controls progressbar info\"></div>\n    <div data-control=\"progress-label\" class=\"qti-controls\"></div>\n</div>"})}),define("taoQtiTest/runner/plugins/controls/progressbar/renderer/percentage",["ui/component","tpl!taoQtiTest/runner/plugins/controls/progressbar/renderer/percentage","ui/progressbar"],function(component,percentageTpl){'use strict';var defaults={showLabel:!0};return function(config,progressData){return component({update:function(data){progressData=data,this.is("rendered")&&this.controls&&(this.controls.$label.text(progressData.label),this.controls.$bar.progressbar("value",progressData.ratio)),this.trigger("update",data)}},defaults).setTemplate(percentageTpl).on("render",function(){this.controls={$label:this.getElement().find("[data-control=\"progress-label\"]"),$bar:this.getElement().find("[data-control=\"progress-bar\"]")},this.config.showLabel||this.controls.$label.hide(),this.controls.$bar.progressbar(),progressData&&this.update(progressData),this.is("hidden")&&this.hide()}).on("destroy",function(){this.controls=null}).init(config)}}),define("tpl!taoQtiTest/runner/plugins/controls/progressbar/renderer/position",["handlebars"],function(hb){return hb.template(function(Handlebars,depth0,helpers,partials,data){return this.compilerInfo=[4,">= 1.0.0"],helpers=this.merge(helpers,Handlebars.helpers),data=data||{},"<div class=\"progress-box\">\n    <div data-control=\"progress-bar\" class=\"qti-controls progressbar\">\n        <div class=\"progressbar-points\"></div>\n    </div>\n    <div data-control=\"progress-label\" class=\"qti-controls\"></div>\n</div>"})}),define("tpl!taoQtiTest/runner/plugins/controls/progressbar/renderer/position-point",["handlebars"],function(hb){return hb.template(function(Handlebars,depth0,helpers,partials,data){function program1(depth0){var buffer="";return buffer+="\n<span class=\"progressbar-point\" data-index=\""+escapeExpression("function"===_typeof(depth0)?depth0.apply(depth0):depth0)+"\"></span>\n",buffer}this.compilerInfo=[4,">= 1.0.0"],helpers=this.merge(helpers,Handlebars.helpers),data=data||{};var escapeExpression=this.escapeExpression,self=this,stack1;return stack1=helpers.each.call(depth0,depth0,{hash:{},inverse:self.noop,fn:self.program(1,program1,data),data:data}),stack1||0===stack1?stack1:""})}),define("taoQtiTest/runner/plugins/controls/progressbar/renderer/position",["lodash","ui/component","tpl!taoQtiTest/runner/plugins/controls/progressbar/renderer/position","tpl!taoQtiTest/runner/plugins/controls/progressbar/renderer/position-point"],function(_,component,positionTpl,pointTpl){'use strict';var defaults={showLabel:!0};return function(config,progressData){var count=0;return component({update:function(data){progressData=data,this.is("rendered")&&this.controls&&(count!==progressData.total&&(count=progressData.total,this.controls.$bar.empty().append(pointTpl(_.range(count)))),this.controls.$label.text(progressData.label),this.controls.$bar.children().removeClass("reached current").slice(0,progressData.position).addClass("reached").slice(-1).addClass("current")),this.trigger("update",data)}},defaults).setTemplate(positionTpl).on("render",function(){this.controls={$label:this.getElement().find("[data-control=\"progress-label\"]"),$bar:this.getElement().find("[data-control=\"progress-bar\"] .progressbar-points")},this.config.showLabel||this.controls.$label.hide(),progressData&&this.update(progressData),this.is("hidden")&&this.hide()}).on("destroy",function(){this.controls=null}).init(config)}}),define("taoQtiTest/runner/plugins/controls/progressbar/progressbar",["lodash","taoTests/runner/plugin","taoQtiTest/runner/helpers/map","taoQtiTest/runner/plugins/controls/progressbar/progress","taoQtiTest/runner/plugins/controls/progressbar/renderer/percentage","taoQtiTest/runner/plugins/controls/progressbar/renderer/position"],function(_,pluginFactory,mapHelper,progressHelper,percentageRendererFactory,positionRendererFactory){'use strict';var renderers={percentage:percentageRendererFactory,position:positionRendererFactory};return pluginFactory({name:"progressBar",init:function(){var testRunner=this.getTestRunner(),testData=testRunner.getTestData(),config=_.defaults(this.getConfig(),testData.config.progressIndicator||{}),self=this,rendererFactory=renderers[config.renderer]||renderers.percentage,progressConfig={indicator:config.type||"percentage",scope:config.scope||"test",showLabel:config.showLabel,showTotal:config.showTotal,categories:config.categories},hiddenByQuestions=function(item){return item&&item.informational&&"questions"===progressConfig.indicator},hiddenByCategories=function(item){return item&&"categories"===progressConfig.indicator&&!progressHelper.isMatchedCategories(item.categories,progressConfig.categories)},isProgressbarHidden=function(item){return hiddenByQuestions(item)||hiddenByCategories(item)},update=function(){var testContext=testRunner.getTestContext(),testMap=testRunner.getTestMap(),item=mapHelper.getItemAt(testMap,testContext.itemPosition);isProgressbarHidden(item)?self.renderer.hide():(self.renderer.show(),self.renderer.update(progressHelper.computeProgress(testMap,testContext,progressConfig)))};this.renderer=rendererFactory(progressConfig),update(),testRunner.on("ready loaditem",update)},render:function(){var $container=this.getAreaBroker().getControlArea();this.renderer.render($container)},destroy:function(){this.renderer&&this.renderer.destroy(),this.renderer=null},show:function(){this.renderer&&this.renderer.show()},hide:function(){this.renderer&&this.renderer.hide()}})}),define("taoQtiTest/runner/plugins/controls/testState/testState",["lodash","taoTests/runner/plugin"],function(_,pluginFactory){'use strict';return pluginFactory({name:"testState",install:function(){var testRunner=this.getTestRunner();testRunner.getProxy().use(function(req,res,next){var data=res&&res.data;return data&&data.type&&"TestState"===data.type&&!testRunner.getState("closedOrSuspended")?(testRunner.setState("closedOrSuspended",!0),void(testRunner.getState("ready")?(_.isEmpty(data.messages)||!_.find(data.messages,{channel:"teststate"}))&&testRunner.trigger("leave",data):testRunner.trigger("destroy"))):void next()})},init:function(){var testRunner=this.getTestRunner(),isLeaving=!1;testRunner.getProxy().channel("teststate",function(data){isLeaving||!data||"close"!==data.type&&"pause"!==data.type||testRunner.getState("closedOrSuspended")||(isLeaving=!0,testRunner.setState("closedOrSuspended",!0),testRunner.trigger("leave",data))})}})}),function(global,factory){"object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&"undefined"!=typeof module?module.exports=factory(require("moment")):"function"==typeof define&&define.amd?define("core/encoder/time",["moment"],factory):(global=global||self,global["core/encoder/time"]=factory(global.moment))}(this,function(moment){'use strict';moment=moment&&moment.hasOwnProperty("default")?moment["default"]:moment;return{encode:function encode(modelValue){var seconds=parseInt(modelValue,10);isNaN(seconds)&&(seconds=0);var time=moment.duration(seconds,"seconds"),h=10<=time.get("hours")?time.get("hours"):"0"+time.get("hours"),m=10<=time.get("minutes")?time.get("minutes"):"0"+time.get("minutes"),s=10<=time.get("seconds")?time.get("seconds"):"0"+time.get("seconds");return h+":"+m+":"+s},decode:function decode(nodeValue){var time=moment(nodeValue,"HH:mm:ss");return time.seconds()+60*time.minutes()+3600*time.hours()}}}),define("tpl!taoQtiTest/runner/plugins/controls/timer/component/tpl/countdown",["handlebars"],function(hb){return hb.template(function(Handlebars,depth0,helpers,partials,data){this.compilerInfo=[4,">= 1.0.0"],helpers=this.merge(helpers,Handlebars.helpers),data=data||{};var buffer="",escapeExpression=this.escapeExpression,stack1,helper;return buffer+="<div class=\"countdown\" data-control=\"",(helper=helpers.id)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.id,stack1="function"===_typeof(helper)?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+"\" data-type=\"",(helper=helpers.type)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.type,stack1="function"===_typeof(helper)?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+"\" data-scope=\"",(helper=helpers.scope)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.scope,stack1="function"===_typeof(helper)?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+"\" title=\"",(helper=helpers.label)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.label,stack1="function"===_typeof(helper)?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+"\" disabled>\n    <span class=\"label truncate\">",(helper=helpers.label)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.label,stack1="function"===_typeof(helper)?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+"</span>\n    <span class=\"time\"></span>\n</div>",buffer})}),define("css!taoQtiTest/runner/plugins/controls/timer/component/css/countdown",[],function(){}),define("taoQtiTest/runner/plugins/controls/timer/component/countdown",["jquery","lodash","core/encoder/time","core/polling","core/timer","ui/component","tpl!taoQtiTest/runner/plugins/controls/timer/component/tpl/countdown","ui/tooltip","css!taoQtiTest/runner/plugins/controls/timer/component/css/countdown.css"],function($,_,timeEncoder,pollingFactory,timerFactory,component,countdownTpl,tooltip){'use strict';var defaults={showBeforeStart:!0,displayWarning:!0,polling:!0,frequency:500},warningTimeout={info:2e3,success:2e3,warning:4e3,danger:4e3,error:8e3};return function($container,config){var countdown=component({update:function(remainingTime){var self=this,encodedTime,warningId,warningMessage;return this.is("completed")||(this.remainingTime=0>=remainingTime?0:parseInt(remainingTime,10),this.is("rendered")&&this.is("running")&&(encodedTime=timeEncoder.encode(this.remainingTime/1000),encodedTime!==this.encodedTime&&(this.encodedTime=encodedTime,$time.text(this.encodedTime)),this.warnings&&(warningId=_.findLastKey(this.warnings,function(warning){return warning&&!warning.shown&&0<warning.threshold&&warning.threshold>=self.remainingTime}),warningId&&(this.warnings[warningId].shown=!0,warningMessage=_.isFunction(this.warnings[warningId].message)?this.warnings[warningId].message(this.remainingTime):this.warnings[warningId].message,this.trigger("warn",warningMessage,this.warnings[warningId].level))),this.trigger("change",this.remainingTime,encodedTime)),0===this.remainingTime&&this.complete()),this},start:function(){return!this.is("rendered")||this.is("running")||this.is("completed")||(this.enable(),this.setState("running",!0),this.polling&&(this.polling.start(),this.is("started")?this.timer.resume():(this.setState("started",!0),this.timer.start())),this.trigger("start")),this},stop:function(){return this.is("rendered")&&this.is("running")&&(this.setState("running",!1),this.polling&&(this.timer.pause(),this.polling.stop()),this.trigger("stop")),this},complete:function(){return this.is("rendered")&&this.is("running")&&!this.is("completed")&&(this.stop(),this.setState("completed",!0),this.trigger("complete end")),this}},defaults).on("init",function(){var self=this;this.remainingTime=this.config.remainingTime,this.config.warnings&&(this.warnings=_.sortBy(this.config.warnings,"threshold")),!0===this.config.polling&&0<this.config.frequency&&(this.timer=timerFactory({autoStart:!1}),this.polling=pollingFactory({action:function(){var elapsed=self.timer.tick();self.update(self.remainingTime-elapsed)},interval:this.config.frequency,autoStart:!1})),this.render($container)}).on("render",function(){$time=$(".time",this.getElement()),!0===this.config.showBeforeStart&&$time.text(timeEncoder.encode(this.remainingTime/1000))}).on("warn",function(message,level){var countdownTooltip;level=level||"warning",this.is("rendered")&&this.is("running")&&_.isString(message)&&!_.isEmpty(message)&&($time.removeClass("txt-success txt-info txt-warning txt-danger txt-error").addClass("txt-"+level),!0===this.config.displayWarning&&(countdownTooltip=tooltip.create(this.getElement(),message,{trigger:"manual",theme:level,placement:"bottom"}),countdownTooltip.show(),setTimeout(function(){countdownTooltip.hide(),countdownTooltip.dispose()},warningTimeout[level]||2e3)))}),$time;return countdown.setTemplate(countdownTpl),_.defer(function(){countdown.init(config)}),countdown}}),define("tpl!taoQtiTest/runner/plugins/controls/timer/component/tpl/timerbox",["handlebars"],function(hb){return hb.template(function(Handlebars,depth0,helpers,partials,data){function program1(depth0,data){var buffer="",helper,options;return buffer+="\n    <a href=\"#\" class=\"timer-toggler hidden\" title=\""+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Hide timers",options):helperMissing.call(depth0,"__","Hide timers",options)))+"\"><span class=\"icon-clock\"></span></a>\n    ",buffer}this.compilerInfo=[4,">= 1.0.0"],helpers=this.merge(helpers,Handlebars.helpers),data=data||{};var buffer="",helperMissing=helpers.helperMissing,escapeExpression=this.escapeExpression,self=this,stack1;return buffer+="<div class=\"timer-box\">\n    ",stack1=helpers["if"].call(depth0,(stack1=depth0&&depth0.zenMode,null==stack1||!1===stack1?stack1:stack1.enabled),{hash:{},inverse:self.noop,fn:self.program(1,program1,data),data:data}),(stack1||0===stack1)&&(buffer+=stack1),buffer+="\n    <div class=\"timer-wrapper\">\n\n    </div>\n</div>",buffer})}),define("css!taoQtiTest/runner/plugins/controls/timer/component/css/timerbox",[],function(){}),define("taoQtiTest/runner/plugins/controls/timer/component/timerbox",["jquery","lodash","i18n","core/promise","ui/component","ui/hider","taoQtiTest/runner/plugins/controls/timer/component/countdown","tpl!taoQtiTest/runner/plugins/controls/timer/component/tpl/timerbox","css!taoQtiTest/runner/plugins/controls/timer/component/css/timerbox.css"],function($,_,__,Promise,component,hider,countdownFactory,timerboxTpl){'use strict';var defaults={zenMode:{enabled:!0,startHidden:!1}};return function(config){var timerbox=component({update:function(timers){var self=this,updating=[],timerIdsToRemove=_.difference(_.keys(this.timers),_.keys(timers));return timerIdsToRemove.length&&_.forEach(timerIdsToRemove,function(timerId){updating.push(self.removeTimer(timerId))}),_.forEach(timers,function(timer,id){"undefined"==typeof self.timers[id]?updating.push(self.addTimer(id,timer)):updating.push(self.updateTimer(id,timer))}),Promise.all(updating).then(function(results){return 0<_.size(self.timers)?hider.show($zenModeToggler):hider.hide($zenModeToggler),self.trigger("update",results),results})},getTimers:function(){return this.timers},addTimer:function(id,timer){var self=this;return this.is("rendered")&&"undefined"==typeof this.timers[id]?new Promise(function(resolve){var countdown=countdownFactory($countdownContainer,_.defaults(timer,{displayWarning:self.config.displayWarning})).on("render",function(){self.timers[id]=_.clone(timer),self.timers[id].countdown=this,self.trigger("timerchange","add",self.timers[id]),self.trigger("timeradd",self.timers[id]),resolve(self.timers[id])}).on("start",function(){self.trigger("timerstart",self.timers[id])}).on("stop",function(){self.trigger("timerstop",self.timers[id])}).on("end",function(){self.trigger("timerend",self.timers[id])}).on("change",function(value){self.timers[id]&&(self.timers[id].remainingTime=value)});countdown.spread(self,["error","change","warn"])}):Promise.resolve(!1)},updateTimer:function(id,timer){return this.is("rendered")&&"undefined"!=typeof this.timers[id]?(this.timers[id].remainingTime=timer.remainingTime,this.timers[id].extraTime=timer.extraTime,_.isNumber(timer.remainingWithoutExtraTime)&&(this.timers[id].remainingWithoutExtraTime=timer.remainingWithoutExtraTime),this.timers[id].countdown&&this.timers[id].countdown.update(timer.remainingTime),this.trigger("timerchange","update",this.timers[id]),this.trigger("timerupdate",this.timers[id]),Promise.resolve(this.timers[id])):Promise.resolve(!1)},removeTimer:function(id){var self=this;return this.is("rendered")&&"undefined"!=typeof this.timers[id]?new Promise(function(resolve){var deindex=function(){var removed=_.omit(self.timers[id],"countdown");self.timers=_.omit(self.timers,id),self.trigger("timerchange","remove",removed),self.trigger("timerremove",removed),resolve(removed)};self.timers[id].countdown?self.timers[id].countdown.on("destroy",deindex).destroy():deindex()}):Promise.resolve()},start:function(){return _.forEach(this.timers,function(timer){timer.countdown&&timer.countdown.start()}),this},stop:function(){return _.forEach(this.timers,function(timer){timer.countdown&&timer.countdown.stop()}),this},toggleZenMode:function(){return this.is("rendered")&&this.config.zenMode.enabled&&(this.is("zen")?(this.setState("zen",!1),$zenModeToggler.attr("title",__("Hide timers"))):(this.setState("zen",!0),$zenModeToggler.attr("title",__("Show timers"))),this.trigger("zenchange",this.is("zen"))),this}},defaults).on("init",function(){this.timers={}}).on("render",function(){var self=this,$element=this.getElement();$countdownContainer=$(".timer-wrapper",$element),this.config.zenMode.enabled&&($zenModeToggler=$(".timer-toggler",$element),self.setState("zen",!!self.config.zenMode.startHidden),$zenModeToggler.on("click",function(e){e.preventDefault(),self.toggleZenMode()})),this.config.timers&&this.update(this.config.timers)}),$zenModeToggler,$countdownContainer;return timerbox.setTemplate(timerboxTpl),_.defer(function(){timerbox.init(config)}),timerbox}}),define("taoQtiTest/runner/plugins/controls/timer/strategy/enforcedStay",[],function(){'use strict';return function(testRunner,timer){var testContext=testRunner.getTestContext();return!!(timer&&"min"===timer.type&&"item"===timer.scope&&testContext.isLinear)&&{name:"enforcedStay",setUp:function(){testRunner.on("enablenav.enforcestay",function(){testRunner.trigger("disablenav")}),testRunner.trigger("disablenav")},complete:function(){this.tearDown(),testRunner.trigger("enablenav")},tearDown:function(){testRunner.off("enablenav.enforcestay")}}}}),define("taoQtiTest/runner/plugins/controls/timer/strategy/extraTime",["lodash"],function(_){'use strict';var _Mathmax=Math.max,lastConsumedExtraTime=0;return function(testRunner,timer){var applyExtraTime=function(){_.isNumber(timer.extraTime)&&0<timer.extraTime&&!timer.extraTimeSetup&&(timer.extraTimeSetup=!0,testRunner.before("move.extra skip.extra exit.extra timeout.extra",function(){var consumedExtraTime=0,testContext=testRunner.getTestContext();timer.remainingTime<timer.extraTime&&(consumedExtraTime=_Mathmax(timer.extraTime-timer.remainingTime,0)/1000,lastConsumedExtraTime=_Mathmax(consumedExtraTime,lastConsumedExtraTime,testContext.extraTime.consumed),testRunner.getProxy().addCallActionParams({consumedExtraTime:lastConsumedExtraTime}))}).after("move.extra skip.extra exit.extra timeout.extra",function(){lastConsumedExtraTime=0}))};return!!(timer&&"max"===timer.type)&&{name:"extraTime",setUp:function(){applyExtraTime()},start:function(){applyExtraTime()},tearDown:function(){testRunner.off("move.extra skip.extra exit.extra timeout.extra")}}}}),define("taoQtiTest/runner/plugins/controls/timer/strategy/guidedNavigation",[],function(){'use strict';return function(testRunner,timer){var testData=testRunner.getTestData(),testContext=testRunner.getTestContext(),config=testData&&testData.config;return!!(timer&&"locked"===timer.type&&"item"===timer.scope&&!0===config.guidedNavigation&&!0===testContext.isLinear)&&{name:"guidedNavigation",setUp:function(){testRunner.trigger("hidenav")},complete:function(){testRunner.trigger("disableitem disablenav shownav"),setTimeout(function(){testRunner.trigger("move","next","item")},500)}}}}),define("taoQtiTest/runner/plugins/controls/timer/strategy/timeout",[],function(){'use strict';return function(testRunner,timer){return!!(timer&&"max"===timer.type)&&{name:"timeout",complete:function(){if(timer.qtiClassName&&timer.source)return testRunner.timeout(timer.qtiClassName,timer.source,timer)}}}}),define("taoQtiTest/runner/helpers/currentItem",["lodash"],function(_){'use strict';var responseCardinalities={single:"base",multiple:"list",ordered:"list",record:"record"},interactionMinConstraintProperties={matchInteraction:"minAssociations",choiceInteraction:"minChoices",orderInteraction:"minChoices",associateInteraction:"minAssociations",hottextInteraction:"minChoices",hotspotInteraction:"minChoices",graphicOrderInteraction:"minChoices",graphicAssociateInteraction:"minAssociations",selectPointInteraction:"minChoices"},currentItemHelper={getDeclarations:function(runner){var itemRunner=runner.itemRunner;return itemRunner._item&&itemRunner._item.responses},getResponseDeclaration:function(runner,identifier){var found=null;return _.forEach(currentItemHelper.getDeclarations(runner),function(declaration){var attributes=declaration.attributes||{};if(attributes.identifier===identifier)return found=declaration,!1}),found},toResponse:function(value,baseType,cardinality){var mappedCardinality=responseCardinalities[cardinality],response={};return _.isString(value)&&(value=[value]),value=_.map(value||[],function(v){return"boolean"===baseType?!0===v||"true"===v:v}),mappedCardinality&&("base"===mappedCardinality?0===value.length?response.base=null:(response.base={},response.base[baseType]=value[0]):(response[mappedCardinality]={},response[mappedCardinality][baseType]=value)),response},isQtiValueNull:function(value,baseType,cardinality){var mappedCardinality=responseCardinalities[cardinality];return _.isObject(value)&&null===value[mappedCardinality]&&(value=null),_.isObject(value)&&value[mappedCardinality]&&"undefined"!=typeof value[mappedCardinality][baseType]&&(value=value[mappedCardinality][baseType]),null===value||"string"===baseType&&_.isEmpty(value)||"single"!==cardinality&&_.isEmpty(value)},isQuestionAnswered:function(response,baseType,cardinality,defaultValue,constraintValue){var fullyAnswered=!0,answered,currentCardinality,responses;return defaultValue=defaultValue||null,constraintValue=constraintValue||0,currentItemHelper.isQtiValueNull(response,baseType,cardinality)?answered=!1:(answered=!_.isEqual(response,currentItemHelper.toResponse(defaultValue,baseType,cardinality)),0!==constraintValue&&(currentCardinality=responseCardinalities[cardinality],responses=response[currentCardinality][baseType]||[],fullyAnswered=responses&&responses.length>=constraintValue),answered=answered&&fullyAnswered),answered},guessInteractionConstraintValues:function(runner){var itemRunner=runner.itemRunner,itemBody=itemRunner._item&&itemRunner._item.bdy||{},interactions=itemBody.elements||{},constraintValues={};return _.forEach(interactions,function(interaction){var attributes=interaction.attributes||{},qtiClass=interaction.__proto__.qtiClass,constraintProperty;interactionMinConstraintProperties.hasOwnProperty(qtiClass)&&(constraintProperty=interactionMinConstraintProperties[qtiClass],constraintValues[attributes.responseIdentifier]=attributes[constraintProperty])}),constraintValues},isAnswered:function(runner,partially){var itemRunner=runner.itemRunner,responses=itemRunner&&itemRunner.getResponses(),count=0,empty=0,declarations,constraintValues;return itemRunner&&(declarations=currentItemHelper.getDeclarations(runner),constraintValues=currentItemHelper.guessInteractionConstraintValues(runner),_.forEach(declarations,function(declaration){var attributes=declaration.attributes||{},response=responses[attributes.identifier],baseType=attributes.baseType,cardinality=attributes.cardinality;count++,currentItemHelper.isQuestionAnswered(response,baseType,cardinality,declaration.defaultValue,constraintValues[attributes.identifier])||empty++})),!1===partially?0<count&&0===empty:0<count&&empty<count},getStimuliHrefs:function(runner){var itemRunner=runner.itemRunner,itemBody=itemRunner._item&&itemRunner._item.bdy||{},interactions=itemBody.elements||{};return _(interactions).values().filter(function(element){return"include"===element.qtiClass}).pluck("attributes").pluck("href").value()},getTextStimuliHrefs:function(runner){var stimuli=this.getStimuliHrefs(runner),textStimuli;return 0<stimuli.length?(textStimuli=stimuli.filter(function(stimulusHref){var domNode=document.querySelector(".qti-include[data-href=\""+stimulusHref+"\"]");return _(domNode.childNodes).some(function(child){return child.nodeType===child.TEXT_NODE})}),textStimuli):[]}};return currentItemHelper}),define("taoQtiTest/runner/helpers/stats",["lodash","taoQtiTest/runner/helpers/map","taoQtiTest/runner/helpers/currentItem"],function(_,mapHelper,currentItemHelper){'use strict';return{getInstantStats:function(scope,runner,sync){var map=runner.getTestMap(),context=runner.getTestContext(),stats=_.clone(mapHelper.getScopeStats(map,context.itemPosition,scope)),item=mapHelper.getItemAt(map,context.itemPosition),isItemCurrentlyAnswered;return item.informational||(isItemCurrentlyAnswered=currentItemHelper.isAnswered(runner),!isItemCurrentlyAnswered&&context.itemAnswered?stats.answered--:(isItemCurrentlyAnswered||sync)&&!context.itemAnswered?stats.answered++:sync&&!isItemCurrentlyAnswered&&context.itemAnswered&&context.isLinear&&stats.answered++),stats}}}),define("taoQtiTest/runner/helpers/messages",["lodash","i18n","taoQtiTest/runner/helpers/map","taoQtiTest/runner/helpers/stats"],function(_,__,mapHelper,statsHelper){'use strict';function getUnansweredItemsWarning(scope,runner,sync){var stats=statsHelper.getInstantStats(scope,runner,sync),unansweredCount=stats&&stats.questions-stats.answered,flaggedCount=stats&&stats.flagged,itemsCountMessage="";return"section"===scope||"testSection"===scope?(itemsCountMessage=0===unansweredCount?__("You answered all %s question(s) in this section",stats.questions.toString()):__("You answered only %s of the %s question(s) in this section",stats.answered.toString(),stats.questions.toString()),flaggedCount&&(itemsCountMessage+=", "+__("and flagged %s of them",flaggedCount.toString()))):"test"===scope?(itemsCountMessage=0===unansweredCount?__("You answered all %s question(s) in this test",stats.questions.toString()):__("You have %s unanswered question(s)",unansweredCount.toString()),flaggedCount&&(itemsCountMessage+=" "+__("and you flagged %s item(s) that you can review now",flaggedCount.toString()))):"part"==scope&&(itemsCountMessage=0===unansweredCount?__("You answered all %s question(s)",stats.questions.toString()):__("You have %s unanswered question(s)",unansweredCount.toString()),flaggedCount&&(itemsCountMessage+=" "+__("and you flagged %s item(s) that you can review now",flaggedCount.toString()))),itemsCountMessage&&(itemsCountMessage+="."),itemsCountMessage}return{getExitMessage:function(message,scope,runner,sync){var itemsCountMessage="",testData=runner.getTestData(),testConfig=testData&&testData.config,messageEnabled=!testConfig||testConfig.enableUnansweredItemsWarning;return messageEnabled&&(itemsCountMessage=getUnansweredItemsWarning(scope,runner,sync)),(itemsCountMessage+" "+message).trim()}}}),define("taoQtiTest/runner/helpers/navigation",["lodash","taoQtiTest/runner/helpers/map"],function(_,mapHelper){'use strict';var navigationHelper={isLeavingSection:function(testContext,testMap,direction,scope,position){var section,sectionStats,nbItems,item;if(_.isPlainObject(testContext)&&_.isPlainObject(testMap)&&!_.isEmpty(testContext.sectionId)&&!_.isEmpty(testContext.itemIdentifier))return section=mapHelper.getSection(testMap,testContext.sectionId),sectionStats=mapHelper.getSectionStats(testMap,testContext.sectionId),nbItems=sectionStats&&sectionStats.total,item=mapHelper.getItem(testMap,testContext.itemIdentifier),"section"===scope||"testPart"===scope||"next"===direction&&item.positionInSection+1===nbItems||"previous"===direction&&0===item.positionInSection||"jump"===direction&&0<position&&(position<section.position||position>=section.position+nbItems);throw new TypeError("Invalid test context and test map")},isLeavingTestPart:function(testContext,testMap,direction,scope,position){var testPart,testPartStats,nbItems,item,section,sectionStats;if(_.isPlainObject(testContext)&&_.isPlainObject(testMap)&&!_.isEmpty(testContext.testPartId)&&!_.isEmpty(testContext.sectionId)&&!_.isEmpty(testContext.itemIdentifier))return testPart=mapHelper.getPart(testMap,testContext.testPartId),testPartStats=mapHelper.getPartStats(testMap,testContext.testPartId),nbItems=testPartStats&&testPartStats.total,item=mapHelper.getItem(testMap,testContext.itemIdentifier),"section"===scope&&(section=mapHelper.getSection(testMap,testContext.sectionId),sectionStats=mapHelper.getSectionStats(testMap,testContext.sectionId)),"testPart"===scope||"next"===direction&&"item"===scope&&item.positionInPart+1===nbItems||"next"===direction&&"section"===scope&&section.position+sectionStats.total>=nbItems||"previous"===direction&&"item"===scope&&0===item.positionInPart||"previous"===direction&&"section"===scope&&section.position===testPart.position||"jump"===direction&&0<position&&(position<testPart.position||position>=testPart.position+nbItems);throw new TypeError("Invalid test context and test map")},isLast:function(testMap,itemIdentifier){return this.isLastOf(testMap,itemIdentifier,"test")},isFirst:function(testMap,itemIdentifier){return this.isFirstOf(testMap,itemIdentifier,"test")},isLastOf:function(testMap,itemIdentifier,scope){var item,stats;if(!_.isPlainObject(testMap))throw new TypeError("Invalid test map");if(_.isEmpty(itemIdentifier))throw new TypeError("Invalid item identifier");if(scope=scope||"test",item=mapHelper.getItem(testMap,itemIdentifier),stats=mapHelper.getScopeStats(testMap,item.position,scope),stats&&_.isNumber(stats.total)){if("test"===scope)return item.position+1===stats.total;if("section"===scope||"assessmentSection"===scope||"testSection"===scope)return item.positionInSection+1===stats.total;if("part"===scope||"testPart"===scope)return item.positionInPart+1===stats.total}return!1},isFirstOf:function(testMap,itemIdentifier,scope){var item;if(!_.isPlainObject(testMap))throw new TypeError("Invalid test map");if(_.isEmpty(itemIdentifier))throw new TypeError("Invalid item identifier");return scope=scope||"test",item=mapHelper.getItem(testMap,itemIdentifier),"test"===scope?0===item.position:"section"===scope||"assessmentSection"===scope||"testSection"===scope?0===item.positionInSection:("part"===scope||"testPart"===scope)&&0===item.positionInPart},getSiblingItems:function(testMap,itemPosition,direction,size){var itemId=mapHelper.getItemIdentifier(testMap,itemPosition),previous=null,siblings=[],itemChain=_.reduce(testMap&&testMap.jumps,function(map,jump){var ref=jump.identifier;return previous&&(map[previous].next=ref),map[ref]={identifier:ref,previous:previous,next:null},previous=ref,map},{}),directions;return size=_.isFinite(size)?parseInt(size,10):3,directions=direction&&"both"!==direction?[direction]:["previous","next"],_.forEach(directions,function(link){var id=itemId;_.times(size,function(){return id=itemChain[id]&&itemChain[id][link],!!id&&void siblings.push(mapHelper.getItem(testMap,id))})}),siblings},getNextItem:function(testMap,itemPosition){var siblings=navigationHelper.getSiblingItems(testMap,itemPosition,"next",1);return siblings.length?siblings[0]:null},getPreviousItem:function(testMap,itemPosition){var siblings=navigationHelper.getSiblingItems(testMap,itemPosition,"previous",1);return siblings.length?siblings[0]:null},isMovingToNextItem:function(action,params){return params=params||{},"timeout"===action||"skip"===action||"move"===action&&"next"===params.direction&&"item"===params.scope},isMovingToPreviousItem:function(action,params){return params=params||{},"move"===action&&"previous"===params.direction&&"item"===params.scope},isJumpingToItem:function(action,params){return params=params||{},"move"===action&&"jump"===params.direction&&"item"===params.scope}};return navigationHelper}),define("taoQtiTest/runner/plugins/controls/timer/strategy/warnSectionLeaving",["lodash","i18n","core/promise","taoQtiTest/runner/helpers/messages","taoQtiTest/runner/helpers/navigation"],function(_,__,Promise,messages,navigationHelper){'use strict';var exitMessage=__("Once you close this section, you cannot return to it or change your answers.");return function(testRunner,timer){var leaveTimedSection=function(direction,scope,position){var context=testRunner.getTestContext(),map=testRunner.getTestMap(),testData=testRunner.getTestData();return!(context.isTimeout||context.itemSessionState===testData.itemStates.closed||context.sectionId!==timer.source)&&navigationHelper.isLeavingSection(context,map,direction,scope,position)};return!!(timer&&"section"===timer.scope&&"max"===timer.type)&&{name:"warnSectionLeaving",setUp:function(){testRunner.off("move.warntimedsection skip.warntimedsection").before("move.warntimedsection skip.warntimedsection",function(e,type,scope,position){var context=testRunner.getTestContext(),testDataBeforeMove=testRunner.getTestData(),config=testDataBeforeMove&&testDataBeforeMove.config,timerConfig=config&&config.timer||{},options=context&&context.options||{},movePromise=new Promise(function(resolve,reject){context.isLast&&options.endTestWarning?resolve():!leaveTimedSection(type||"next",scope,position)||options.noExitTimedSectionWarning||timerConfig.keepUpToTimeout?resolve():testRunner.trigger("confirm.exittimed",messages.getExitMessage(exitMessage,"section",testRunner),resolve,reject,{buttons:{labels:{ok:__("Close this Section"),cancel:__("Review my Answers")}}})});return movePromise.catch(function(){_.defer(function(){testRunner.trigger("enableitem enablenav")})}),movePromise})},complete:function(){return this.tearDown()},tearDown:function(){testRunner.off("move.warntimedsection skip.warntimedsection")}}}}),define("taoQtiTest/runner/plugins/controls/timer/strategy/strategyHandler",["lodash","core/promise","taoQtiTest/runner/plugins/controls/timer/strategy/enforcedStay","taoQtiTest/runner/plugins/controls/timer/strategy/extraTime","taoQtiTest/runner/plugins/controls/timer/strategy/guidedNavigation","taoQtiTest/runner/plugins/controls/timer/strategy/timeout","taoQtiTest/runner/plugins/controls/timer/strategy/warnSectionLeaving"],function(_,Promise,extraTimeStrategy,enforcedStayStrategy,guidedNavigationStrategy,timeoutStrategy,warnSectionLeavingStrategy){'use strict';var defaultAvailableStrategies=[extraTimeStrategy,enforcedStayStrategy,guidedNavigationStrategy,timeoutStrategy,warnSectionLeavingStrategy];return function(testRunner,strategies){var actives={},applyToStrategies=function(timerId,action){var api=_.keys(strategyHandler);if(_.isEmpty(timerId)||_.isEmpty(action)||!_.contains(api,action))throw new TypeError("Invalid timer id or unauthorized action");return _.isArray(actives[timerId])?Promise.all(_.map(actives[timerId],function(strategy){if(_.isFunction(strategy[action]))return strategy[action]()})):Promise.resolve()},strategyHandler;if(!testRunner||!_.isFunction(testRunner.on)||!_.isFunction(testRunner.getTestContext))throw new TypeError("The strategy handler needs a valid test runner.");return strategyHandler={setUp:function(timer){return _.forEach(strategies||defaultAvailableStrategies,function(availableStrategy){var strategy=availableStrategy(testRunner,timer);!1!==strategy&&(actives[timer.id]=actives[timer.id]||[],actives[timer.id].push(strategy))}),applyToStrategies(timer.id,"setUp")},getActives:function(timer){return timer&&timer.id&&_.isArray(actives[timer.id])?actives[timer.id]:[]},start:function(timer){return applyToStrategies(timer.id,"start")},stop:function(timer){return applyToStrategies(timer.id,"stop")},complete:function(timer){return applyToStrategies(timer.id,"complete")},tearDown:function(timer){return applyToStrategies(timer.id,"tearDown").then(function(){actives=_.omit(actives,timer.id)})}},strategyHandler}}),define("taoQtiTest/runner/plugins/controls/timer/timers",["lodash","i18n","moment","core/format","core/logger"],function(_,__,moment,format,loggerFactory){'use strict';var logger=loggerFactory("taoQtiTest/runner/plugins/controls/timer/timers"),precision=1e3,scopes=["item","section","testPart","test"],scopeMapping={assessmentTest:"test",assessmentSection:"section",assessmentItemRef:"item"},getScope=function(value){return scopeMapping[value]?scopeMapping[value]:_.contains(scopes,value)?value:null},warningMessages={item:__("Warning \u2013 You have %s remaining to complete this item."),section:__("Warning \u2013 You have %s remaining to complete this section."),testPart:__("Warning \u2013 You have %s remaining to complete this test part."),test:__("Warning \u2013 You have %s remaining to complete this test.")};return function(timeConstraints,isLinear,config){var timers={},constraintsWarnings=_.reduce(config.warnings,function(acc,warnings,qtiScope){var scope=getScope(qtiScope);return acc[scope]=_.map(warnings,function(value,key){return{threshold:parseInt(key,10)*precision,message:function(remainingTime){var displayRemaining=moment.duration(remainingTime/precision,"seconds").humanize();return format(warningMessages[scope],displayRemaining)},level:value,shown:!1}}),acc},{}),buildTimer=function(type,constraintData){var timer=_.pick(constraintData,["label","scope","source","extraTime","qtiClassName"]);return timer.type=type,timer.allowLateSubmission=constraintData.allowLateSubmission,"min"===type?(timer.id=type+"-"+constraintData.scope+"-"+constraintData.source,timer.originalTime=constraintData.minTime*precision,timer.remainingTime=constraintData.minTimeRemaining*precision):(timer.id=constraintData.source,timer.originalTime=constraintData.maxTime*precision,timer.remainingTime=constraintData.maxTimeRemaining*precision),timer.remainingWithoutExtraTime=timer.remainingTime,timer.extraTime&&(timer.extraTime.consumed*=precision,timer.extraTime.remaining*=precision,timer.extraTime.total*=precision,timer.total=timer.originalTime+timer.extraTime.total,timer.remainingTime+=timer.extraTime.remaining),"max"===type&&_.isArray(constraintsWarnings[timer.scope])&&(timer.warnings=constraintsWarnings[timer.scope]),timer};return _.forEach(timeConstraints,function(timeConstraint){var constraintData=_.clone(timeConstraint),newTimer;constraintData.scope=getScope(timeConstraint.scope||timeConstraint.qtiClassName),constraintData.scope?!1===constraintData.minTime&&!1===constraintData.maxTime?logger.warning("Time constraint defined with no time, skipping"):config.guidedNavigation&&isLinear&&constraintData.maxTime&&constraintData.minTime&&constraintData.minTime===constraintData.maxTime&&0<constraintData.maxTime?(newTimer=buildTimer("locked",constraintData),timers[newTimer.id]=newTimer):(isLinear&&constraintData.minTime&&0<constraintData.minTime&&(newTimer=buildTimer("min",constraintData),timers[newTimer.id]=newTimer),constraintData.maxTime&&0<constraintData.maxTime&&(newTimer=buildTimer("max",constraintData),timers[newTimer.id]=newTimer)):logger.warning("Wrong data, a time constraint should apply to a valid scope, skipping")}),logger.debug("Timers built from timeConstraints",timers),timers}}),define("taoQtiTest/runner/plugins/controls/timer/plugin",["jquery","lodash","core/promise","taoTests/runner/plugin","taoQtiTest/runner/plugins/controls/timer/strategy/strategyHandler","taoQtiTest/runner/plugins/controls/timer/component/timerbox","taoQtiTest/runner/plugins/controls/timer/timers"],function($,_,Promise,pluginFactory,getStrategyHandler,timerboxFactory,timersFactory){'use strict';return pluginFactory({name:"timer",install:function(){var testRunner=this.getTestRunner();this.loadTimers=function(timeStore,config){var testContext=testRunner.getTestContext(),timeConstraints=testContext.timeConstraints,isLinear=!!testContext.isLinear,timers=timersFactory(timeConstraints,isLinear,config);return Promise.all(_.map(timers,function(timer){return timeStore.getItem("consumed_"+timer.id).then(function(savedConsumedTime){_.isNumber(savedConsumedTime)&&0<=savedConsumedTime&&config.restoreTimerFromClient&&(timer.remainingTime=timer.originalTime+timer.extraTime.total-savedConsumedTime)})})).then(function(){return timers})},this.saveTimers=function(timeStore,timers){return Promise.all(_.map(timers,function(timer){return timeStore.setItem("consumed_"+timer.id,timer.originalTime+timer.extraTime.total-timer.remainingTime)}))},testRunner.getTestStore().setVolatile(this.getName())},init:function(){var self=this,testRunner=this.getTestRunner(),testData=testRunner.getTestData(),config=_.merge({},this.getConfig(),{contextualWarnings:!1,warnings:testData&&testData.config&&testData.config.timerWarning||{},guidedNavigation:testData&&testData.config&&testData.config.guidedNavigation,restoreTimerFromClient:testData&&testData.config&&testData.config.timer.restoreTimerFromClient}),strategyHandler=getStrategyHandler(testRunner),handleError=function(err){testRunner.trigger("error",err)};return new Promise(function(resolve){return testRunner.getPluginStore(self.getName()).then(function(timeStore){testRunner.before("renderitem resumeitem",function(){var testContext=testRunner.getTestContext();if(self.timerbox&&testContext.timeConstraints)return self.loadTimers(timeStore,config).then(function(timers){return self.timerbox.update(timers)}).catch(handleError)}).on("enableitem",function(){self.timerbox&&self.timerbox.start()}).after("renderitem",function(){self.timerbox&&self.timerbox.start()}).on("disableitem move skip",function(){self.timerbox&&self.timerbox.stop()}),timeStore.getItem("zen-mode").then(function(startZen){self.timerbox=timerboxFactory({zenMode:{enabled:!0,startHidden:!!startZen},displayWarning:config.contextualWarnings}).on("change",_.throttle(function(){self.saveTimers(timeStore,this.getTimers())},1e3)).on("timeradd",function(timer){strategyHandler.setUp(timer).catch(handleError)}).on("timerremove",function(timer){strategyHandler.tearDown(timer).catch(handleError)}).on("timerstart",function(timer){strategyHandler.start(timer).catch(handleError)}).on("timerstop",function(timer){strategyHandler.stop(timer).catch(handleError)}).on("timerend",function(timer){strategyHandler.complete(timer).catch(handleError)}).on("timerchange",function(action,timer){self.trigger(action+"timer",timer.qtiClassName,timer)}).on("zenchange",function(isZen){timeStore.setItem("zen-mode",!!isZen)}).on("init",resolve).on("error",handleError),config.contextualWarnings||self.timerbox.on("warn",function(message,level){level&&message&&testRunner.trigger(level,message)})}).catch(handleError)})})},render:function(){this.timerbox.render(this.getAreaBroker().getControlArea())},destroy:function(){this.timerbox&&this.timerbox.stop().destroy()},show:function(){this.timerbox&&this.timerbox.show()},hide:function(){this.timerbox&&this.timerbox.hide()}})}),define("tpl!taoQtiTest/runner/plugins/controls/title/title",["handlebars"],function(hb){return hb.template(function(Handlebars,depth0,helpers,partials,data){function program1(depth0,data){var buffer="",stack1,helper;return buffer+="\n        <span data-control=\"",(helper=helpers.control)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.control,stack1="function"===_typeof(helper)?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+"\" class=\"qti-controls\" title=\"",(helper=helpers.text)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.text,stack1="function"===_typeof(helper)?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+"\">",stack1=helpers.unless.call(depth0,null==data||!1===data?data:data.first,{hash:{},inverse:self.noop,fn:self.program(2,program2,data),data:data}),(stack1||0===stack1)&&(buffer+=stack1),(helper=helpers.text)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.text,stack1="function"===_typeof(helper)?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+"</span>\n    ",buffer}function program2(){return" - "}this.compilerInfo=[4,">= 1.0.0"],helpers=this.merge(helpers,Handlebars.helpers),data=data||{};var buffer="",escapeExpression=this.escapeExpression,self=this,stack1;return buffer+="<div class=\"title-box truncate\">\n    ",stack1=helpers.each.call(depth0,depth0&&depth0.titles,{hash:{},inverse:self.noop,fn:self.program(1,program1,data),data:data}),(stack1||0===stack1)&&(buffer+=stack1),buffer+="\n</div>",buffer})}),define("taoQtiTest/runner/plugins/controls/title/title",["jquery","i18n","taoTests/runner/plugin","tpl!taoQtiTest/runner/plugins/controls/title/title"],function($,__,pluginFactory,titleTpl){'use strict';return pluginFactory({name:"title",init:function(){var self=this,testRunner=this.getTestRunner(),testData=testRunner.getTestData(),createElement=function(){var context=testRunner.getTestContext(),titles=[{control:"qti-test-title",text:testData.title}];return context.isDeepestSectionVisible&&titles.push({control:"qti-test-position",text:context.sectionTitle}),$(titleTpl({titles:titles}))};this.$element=createElement(),testRunner.after("renderitem",function(){var $element=createElement();self.$element.replaceWith($element),self.$element=$element})},render:function(){var $container=this.getAreaBroker().getControlArea();$container.append(this.$element)}})}),define("taoQtiTest/runner/plugins/controls/trace/itemTraceVariables",["lodash","moment","taoTests/runner/plugin"],function(_,moment,pluginFactory){'use strict';function timestamp(){return Date.now()/1000}return pluginFactory({name:"itemTraceVariables",install:function(){this.getTestRunner().getTestStore().setVolatile("trace")},init:function(){function onError(err){testRunner.trigger("error",err)}var testRunner=this.getTestRunner(),variables={};return testRunner.getPluginStore("trace").then(function(tracesStore){testRunner.after("renderitem enableitem",function(){var context=testRunner.getTestContext();variables={ITEM_START_TIME_CLIENT:timestamp()},tracesStore.getItem(context.itemIdentifier).then(function(data){return data&&_.merge(variables,data),tracesStore.setItem(context.itemIdentifier,variables)}).catch(onError)}).before("move skip exit timeout",function(){var context=testRunner.getTestContext();return variables.ITEM_END_TIME_CLIENT=timestamp(),variables.ITEM_TIMEZONE=moment().utcOffset(moment().utcOffset()).format("Z"),tracesStore.setItem(context.itemIdentifier,variables).catch(onError)}).before("unloaditem",function(){var context=testRunner.getTestContext();return testRunner.getProxy().callItemAction(context.itemIdentifier,"storeTraceData",{traceData:JSON.stringify(variables)},!0)})})}})}),define("taoQtiTest/runner/plugins/navigation/allowSkipping",["lodash","i18n","taoTests/runner/plugin","taoQtiTest/runner/helpers/currentItem"],function(_,__,pluginFactory,currentItemHelper){'use strict';var defaults={allowPartial:!0};return pluginFactory({name:"allowSkipping",init:function(){this.getTestRunner().before("nav-next move",function(){var self=this,testContext=this.getTestContext(),isInteracting=!this.getItemState(testContext.itemIdentifier,"disabled"),testData=this.getTestData()||{},testConfig=testData.config||{},pluginsConfig=testConfig.plugins||{},config=_.defaults(pluginsConfig.allowSkipping||{},defaults),warning=config.allowPartial?__("A response to every question in this item is required."):__("A response to this item is required.");if(isInteracting&&testContext.enableAllowSkipping&&!testContext.allowSkipping)return new Promise(function(resolve,reject){return 0===_.size(currentItemHelper.getDeclarations(self))?resolve():currentItemHelper.isAnswered(self,config.allowPartial)?resolve():void(!self.getState("alerted.notallowed")&&(self.setState("alerted.notallowed",!0),self.trigger("alert.notallowed",warning,function(){self.trigger("resumeitem"),reject(),self.setState("alerted.notallowed",!1)})))})})}})}),define("taoQtiTest/runner/plugins/navigation/next/nextWarningHelper",[],function(){'use strict';var toBoolean=function(value,defaultValue){return"undefined"==typeof value?defaultValue:!0===value||"true"===value};return function(options){function itemCanBeTriedAtWill(){return!1===isLast&&!1===isLinear&&-1===remainingAttempts&&!isNextItemInLinearPart()}function isNextItemInLinearPart(){return nextPart&&"undefined"!=typeof nextPart.isLinear&&isLastOfPart()&&!0===nextPart.isLinear}function shouldWarnOnTestEnd(){return isLast&&(endTestWarning||warnBeforeNext)&&shouldWarnForUnansweredItems()}function shouldWarnForUnansweredItems(){var hasUnanswered=stats&&0!=stats.questions-stats.answered,hasFlagged=stats&&0!==stats.flagged;return!unansweredOnly||hasUnanswered||hasFlagged}function shouldWarnOnPartChange(){return nextPartWarning&&isLastOfPart()&&shouldWarnForUnansweredItems()}function isLastOfPart(){return nextPart&&nextPart.id&&testPartId!==nextPart.id}var endTestWarning=toBoolean(options.endTestWarning,!1),isLast=toBoolean(options.isLast,!1),isLinear=toBoolean(options.isLinear,!1),nextItemWarning=toBoolean(options.nextItemWarning,!1),nextPartWarning=toBoolean(options.nextPartWarning,!1),stats=options.stats,nextPart=options.nextPart||{},remainingAttempts="undefined"==typeof options.remainingAttempts?-1:options.remainingAttempts,testPartId=options.testPartId||"",unansweredOnly=toBoolean(options.unansweredOnly,!1),warnBeforeNext=function(){return nextItemWarning&&!itemCanBeTriedAtWill()}(),warnBeforeEnd=function(){return shouldWarnOnTestEnd()||shouldWarnOnPartChange()}();return{shouldWarnBeforeEnd:function shouldWarnBeforeEnd(){return warnBeforeEnd},shouldWarnBeforeNext:function shouldWarnBeforeNext(){return warnBeforeNext}}}}),define("taoQtiTest/runner/plugins/navigation/next",["jquery","lodash","i18n","ui/hider","taoTests/runner/plugin","taoQtiTest/runner/plugins/navigation/next/nextWarningHelper","taoQtiTest/runner/helpers/messages","taoQtiTest/runner/helpers/map","taoQtiTest/runner/helpers/stats","util/shortcut","util/namespace","tpl!taoQtiTest/runner/plugins/templates/button"],function($,_,__,hider,pluginFactory,nextWarningHelper,messages,mapHelper,statsHelper,shortcut,namespaceHelper,buttonTpl){'use strict';var buttonData={next:{control:"move-forward",title:__("Submit and go to the next item"),icon:"forward",text:__("Next")},end:{control:"move-end",title:__("Submit and go to the end of the test"),icon:"fast-forward",text:__("End test")}},createElement=function(context){var dataType=context.isLast?"end":"next";return $(buttonTpl(buttonData[dataType]))},updateElement=function($element,context){var dataType=context.isLast?"end":"next";$element.attr("data-control")!==buttonData[dataType].control&&($element.attr("data-control",buttonData[dataType].control).attr("title",buttonData[dataType].title).find(".text").text(buttonData[dataType].text),"next"==dataType?$element.find(".icon-"+buttonData.end.icon).removeClass("icon-"+buttonData.end.icon).addClass("icon-"+buttonData.next.icon):$element.find(".icon-"+buttonData.next.icon).removeClass("icon-"+buttonData.next.icon).addClass("icon-"+buttonData.end.icon))};return pluginFactory({name:"next",init:function(){function doNext(nextItemWarning){function enableNav(){testRunner.trigger("enablenav")}var context=testRunner.getTestContext(),testOptions=context.options||{},map=testRunner.getTestMap(),nextItemPosition=context.itemPosition+1,nextPartWarning=testOptions.nextPartWarning||testOptions.unansweredWarning,unansweredOnly=!testOptions.endTestWarning&&testOptions.unansweredWarning,warningScope=nextPartWarning?"part":"test";if(testRunner.trigger("disablenav"),!1!==self.getState("enabled")){var warningHelper=nextWarningHelper({endTestWarning:testOptions.endTestWarning,isLast:context.isLast,isLinear:context.isLinear,nextItemWarning:nextItemWarning,nextPartWarning:nextPartWarning,nextPart:mapHelper.getItemPart(map,nextItemPosition),remainingAttempts:context.remainingAttempts,testPartId:context.testPartId,unansweredWarning:testOptions.unansweredWarning,stats:statsHelper.getInstantStats(warningScope,testRunner),unansweredOnly:unansweredOnly});warningHelper.shouldWarnBeforeEnd()?testRunner.trigger("confirm.endTest",messages.getExitMessage(__("You are about to submit the test. You will not be able to access this test once submitted. Click OK to continue and submit the test."),warningScope,testRunner),_.partial(triggerNextAction,context),enableNav):warningHelper.shouldWarnBeforeNext()?testRunner.trigger("confirm.next",__("You are about to go to the next item. Click OK to continue and go to the next item."),_.partial(triggerNextAction,context),enableNav):triggerNextAction(context)}}function triggerNextAction(context){context.isLast&&self.trigger("end"),testRunner.next()}var self=this,testRunner=this.getTestRunner(),testData=testRunner.getTestData(),testConfig=testData.config||{},pluginShortcuts=(testConfig.shortcuts||{})[this.getName()]||{};this.$element=createElement(testRunner.getTestContext()),this.$element.on("click",function(e){e.preventDefault(),testRunner.trigger("nav-next")}),testConfig.allowShortcuts&&pluginShortcuts.trigger&&shortcut.add(namespaceHelper.namespaceAll(pluginShortcuts.trigger,this.getName(),!0),function(){!0===self.getState("enabled")&&testRunner.trigger("nav-next",!0)},{avoidInput:!0,prevent:!0}),this.disable(),testRunner.on("loaditem",function(){updateElement(self.$element,testRunner.getTestContext())}).on("enablenav",function(){self.enable()}).on("disablenav",function(){self.disable()}).on("hidenav",function(){self.hide()}).on("shownav",function(){self.show()}).on("nav-next",function(nextItemWarning){doNext(nextItemWarning)})},render:function(){var $container=this.getAreaBroker().getNavigationArea();$container.append(this.$element)},destroy:function(){shortcut.remove("."+this.getName()),this.$element.remove()},enable:function(){this.$element.removeProp("disabled").removeClass("disabled")},disable:function(){this.$element.prop("disabled",!0).addClass("disabled")},show:function(){hider.show(this.$element)},hide:function(){hider.hide(this.$element)}})}),define("taoQtiTest/runner/plugins/navigation/next/dialogConfirmNext",["jquery","lodash","i18n","ui/dialog","tpl!ui/dialog/tpl/checkbox"],function($,_,__,dialog,checkboxTpl){'use strict';return function(heading,message,accept,refuse,checkboxParams,dialogOptions){var accepted=!1,content=null,dlg;return checkboxParams&&!0!==checkboxParams.checked&&(content=checkboxTpl({checked:!1,text:"Don't show this again next time",id:"dont-show-again"})),dialogOptions=_.defaults({heading:heading,message:message,content:content,autoRender:!0,autoDestroy:!0,buttons:[{id:"cancel",type:"regular",label:__("Cancel"),close:!0},{id:"ok",type:"info",label:__("Go to next item"),close:!0}],onOkBtn:function(){var $checkbox;accepted=!0,_.isFunction(accept)&&(accept.call(this),checkboxParams&&($checkbox=$("input[name=\"dont-show-again\"]",this),$checkbox.prop("checked")&&_.isFunction(checkboxParams.submitChecked)?checkboxParams.submitChecked():!$checkbox.prop("checked")&&_.isFunction(checkboxParams.submitUnchecked)&&checkboxParams.submitUnchecked()))}},dialogOptions),dlg=dialog(dialogOptions),_.isFunction(refuse)&&dlg.on("closed.modal",function(){accepted||refuse.call(this)}),dlg}}),define("taoQtiTest/runner/plugins/navigation/next/linearNextItemWarning",["jquery","lodash","i18n","taoTests/runner/plugin","taoQtiTest/runner/helpers/map","taoQtiTest/runner/helpers/currentItem","taoQtiTest/runner/plugins/navigation/next/dialogConfirmNext"],function($,_,__,pluginFactory,mapHelper,currentItemHelper,dialogConfirmNext){'use strict';return pluginFactory({name:"linearNextItemWarning",init:function(){function getCustomNextMessage(action){var itemPartiallyAnswered=currentItemHelper.isAnswered(testRunner,!0),customNextMessage;return customNextMessage=itemPartiallyAnswered?"next"===action?__("Are you sure you want to go to the next item? You will not be able to go back and change your answer."):"skip"===action?__("Are you sure you want to clear your answer and go to the next item? You will not be able to go back and provide an answer."):__("Are you sure you want to go to the next item? You will not be able to go back."):__("Are you sure you want to go to the next item? You will not be able to go back and provide an answer."),customNextMessage}function doNextWarning(action){return testRunner.trigger("disablenav"),testStore.getStore(self.getName()).then(function(store){return store.getItem("dontShowLinearNextItemWarning").then(function(checkboxValue){var checkboxParams=null;if(!0!==checkboxValue)return testConfig.enableLinearNextItemWarningCheckbox&&(checkboxParams={checked:checkboxValue,submitChecked:function submitChecked(){store.setItem("dontShowLinearNextItemWarning",!0)},submitUnchecked:function submitUnchecked(){store.setItem("dontShowLinearNextItemWarning",!1)}}),new Promise(function(resolve,reject){dialogConfirmNext(__("Go to the next item?"),getCustomNextMessage(action),resolve,function(){reject({cancel:!0})},checkboxParams)})})}).catch(function(err){if(err&&err instanceof Error)throw err;return err&&!0===err.cancel?(testRunner.trigger("enablenav"),Promise.reject()):void 0})}var self=this,testRunner=this.getTestRunner(),testData=testRunner.getTestData(),testConfig=testData.config||{},testStore=testRunner.getTestStore();testStore.setVolatile(self.getName()),testRunner.on("init",function(){testStore.getStore(self.getName()).then(function(store){store.setItem("dontShowLinearNextItemWarning",null)})}).before("move skip",function(e,type,scope){var context=testRunner.getTestContext(),map=testRunner.getTestMap(),item=mapHelper.getItemAt(map,context.itemPosition);if(context.isLinear){if("section"===scope&&context.options.nextSectionWarning)return;if(context.options.nextPartWarning)return;if(item.informational)return;if("next"===type&&!context.isLast&&testConfig.forceEnableLinearNextItemWarning)return doNextWarning("next");if("skip"===e.name&&!context.isLast&&testConfig.forceEnableLinearNextItemWarning)return doNextWarning("skip")}})}})}),define("taoQtiTest/runner/plugins/navigation/nextSection",["jquery","lodash","i18n","ui/hider","taoTests/runner/plugin","taoQtiTest/runner/helpers/messages","tpl!taoQtiTest/runner/plugins/templates/button"],function($,_,__,hider,pluginFactory,messages,buttonTpl){'use strict';return pluginFactory({name:"nextsection",init:function(){function toggle(){var options=testRunner.getTestContext().options;testConfig.nextSection&&(options.nextSection||options.nextSectionWarning)?self.show():self.hide()}function nextSection(){testRunner.next("section")}var self=this,testRunner=this.getTestRunner(),testConfig=testRunner.getTestData().config;this.$element=$(buttonTpl({control:"next-section",title:__("Skip to the next section"),icon:"fast-forward",text:__("Next Section")})),this.$element.on("click",function(e){var context=testRunner.getTestContext(),enable=_.bind(self.enable,self);e.preventDefault(),!1!==self.getState("enabled")&&(self.disable(),context.options.nextSectionWarning?testRunner.trigger("confirm.nextsection",messages.getExitMessage(__("Once you close this section, you cannot return to it or change your answers."),"section",testRunner),nextSection,enable,{buttons:{labels:{ok:__("Close this Section"),cancel:__("Review my Answers")}}}):nextSection())}),this.disable(),toggle(),testRunner.on("loaditem",toggle).on("enablenav",function(){self.enable()}).on("disablenav",function(){self.disable()}).on("hidenav",function(){self.hide()}).on("shownav",function(){self.show()})},render:function(){var $container=this.getAreaBroker().getNavigationArea();$container.append(this.$element)},destroy:function(){this.$element.remove()},enable:function(){this.$element.removeProp("disabled").removeClass("disabled")},disable:function(){this.$element.prop("disabled",!0).addClass("disabled")},show:function(){hider.show(this.$element)},hide:function(){hider.hide(this.$element)}})}),define("taoQtiTest/runner/plugins/navigation/previous",["jquery","lodash","i18n","ui/hider","taoTests/runner/plugin","util/shortcut","util/namespace","taoQtiTest/runner/helpers/navigation","taoQtiTest/runner/helpers/map","tpl!taoQtiTest/runner/plugins/templates/button"],function($,_,__,hider,pluginFactory,shortcut,namespaceHelper,navigationHelper,mapHelper,buttonTpl){'use strict';return pluginFactory({name:"previous",init:function(){function doPrevious(previousItemWarning){var context=testRunner.getTestContext();testRunner.trigger("disablenav"),!1!==self.getState("enabled")&&(previousItemWarning&&-1!==context.remainingAttempts?testRunner.trigger("confirm.previous",__("You are about to go to the previous item. Click OK to continue and go to the previous item."),testRunner.previous,function(){testRunner.trigger("disablenav")}()):testRunner.previous())}var self=this,testRunner=this.getTestRunner(),testData=testRunner.getTestData(),testConfig=testData.config||{},pluginShortcuts=(testConfig.shortcuts||{})[this.getName()]||{},canDoPrevious=function(){var testMap=testRunner.getTestMap(),context=testRunner.getTestContext(),previousSection,previousPart;if(_.isPlainObject(testMap)&&0===_.size(testMap))return!1;if(navigationHelper.isFirst(testMap,context.itemIdentifier))return!1;if(navigationHelper.isFirstOf(testMap,context.itemIdentifier,"section")){if(context.isCatAdaptive)return!1;if(previousSection=mapHelper.getItemSection(testMap,context.itemPosition-1),previousSection.isCatAdaptive||previousSection.timeConstraint&&!context.options.noExitTimedSectionWarning)return!1}return!(navigationHelper.isFirstOf(testMap,context.itemIdentifier,"part")&&(previousPart=mapHelper.getItemPart(testMap,context.itemPosition-1),previousPart.isLinear))&&!1===context.isLinear&&!0===context.canMoveBackward},toggle=function(){canDoPrevious()?self.show():self.hide()};this.$element=$(buttonTpl({control:"move-backward",title:__("Submit and go to the previous item"),icon:"backward",text:__("Previous")})),this.$element.on("click",function(e){e.preventDefault(),testRunner.trigger("nav-previous")}),testConfig.allowShortcuts&&pluginShortcuts.trigger&&shortcut.add(namespaceHelper.namespaceAll(pluginShortcuts.trigger,this.getName(),!0),function(){canDoPrevious()&&!0===self.getState("enabled")&&testRunner.trigger("nav-previous",[!0])},{avoidInput:!0,prevent:!0}),toggle(),self.disable(),testRunner.on("loaditem",toggle).on("enablenav",function(){self.enable()}).on("disablenav",function(){self.disable()}).on("hidenav",function(){self.hide()}).on("shownav",function(){self.show()}).on("nav-previous",function(previousItemWarning){doPrevious(previousItemWarning)})},render:function(){var $container=this.getAreaBroker().getNavigationArea();$container.append(this.$element)},destroy:function(){shortcut.remove("."+this.getName()),this.$element.remove()},enable:function(){this.$element.removeProp("disabled").removeClass("disabled")},disable:function(){this.$element.prop("disabled",!0).addClass("disabled")},show:function(){hider.show(this.$element)},hide:function(){hider.hide(this.$element)}})}),define("tpl!taoQtiTest/runner/plugins/navigation/review/navigator",["handlebars"],function(hb){return hb.template(function(Handlebars,depth0,helpers,partials,data){function program3(depth0,data){var buffer="",helper,options;return buffer+="\n    <div class=\"qti-navigator-info collapsible\">\n                <span class=\"qti-navigator-label\">\n                    <span class=\"qti-navigator-text\">"+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Test status",options):helperMissing.call(depth0,"__","Test status",options)))+"</span>\n                    <span class=\"icon-up\"></span>\n                    <span class=\"icon-down\"></span>\n                </span>\n        <ul class=\"collapsible-panel plain\">\n            <li class=\"qti-navigator-viewed\" title=\""+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Viewed items",options):helperMissing.call(depth0,"__","Viewed items",options)))+"\">\n                        <span class=\"qti-navigator-label\">\n                            <span class=\"qti-navigator-icon icon-viewed\"></span>\n                            <span class=\"qti-navigator-text\">"+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Viewed",options):helperMissing.call(depth0,"__","Viewed",options)))+"</span>\n                            <span class=\"qti-navigator-counter\">-/-</span>\n                        </span>\n            </li>\n            <li class=\"qti-navigator-answered\" title=\""+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Completed items",options):helperMissing.call(depth0,"__","Completed items",options)))+"\">\n                        <span class=\"qti-navigator-label\">\n                            <span class=\"qti-navigator-icon icon-answered\"></span>\n                            <span class=\"qti-navigator-text\">"+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Answered",options):helperMissing.call(depth0,"__","Answered",options)))+"</span>\n                            <span class=\"qti-navigator-counter\">-/-</span>\n                        </span>\n            </li>\n            <li class=\"qti-navigator-unanswered\" title=\""+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Unanswered items",options):helperMissing.call(depth0,"__","Unanswered items",options)))+"\">\n                        <span class=\"qti-navigator-label\">\n                            <span class=\"qti-navigator-icon icon-unanswered\"></span>\n                            <span class=\"qti-navigator-text\">"+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Unanswered",options):helperMissing.call(depth0,"__","Unanswered",options)))+"</span>\n                            <span class=\"qti-navigator-counter\">-/-</span>\n                        </span>\n            </li>\n            <li class=\"qti-navigator-flagged\" title=\""+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Items marked for later review",options):helperMissing.call(depth0,"__","Items marked for later review",options)))+"\">\n                        <span class=\"qti-navigator-label\">\n                            <span class=\"qti-navigator-icon icon-flagged\"></span>\n                            <span class=\"qti-navigator-text\">"+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Flagged",options):helperMissing.call(depth0,"__","Flagged",options)))+"</span>\n                            <span class=\"qti-navigator-counter\">-/-</span>\n                        </span>\n            </li>\n        </ul>\n    </div>\n    ",buffer}function program9(depth0,data){var buffer="",helper,options;return buffer+=escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Unanswered",options):helperMissing.call(depth0,"__","Unanswered",options)))+" (<span class=\"qti-navigator-counter\">0</span>)",buffer}function program13(depth0,data){var buffer="",helper,options;return buffer+=escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Flagged",options):helperMissing.call(depth0,"__","Flagged",options)))+" (<span class=\"qti-navigator-counter\">0</span>)",buffer}this.compilerInfo=[4,">= 1.0.0"],helpers=this.merge(helpers,Handlebars.helpers),data=data||{};var buffer="",helperMissing=helpers.helperMissing,escapeExpression=this.escapeExpression,self=this,stack1,helper,options;return buffer+="<div class=\"qti-panel qti-navigator",stack1=helpers["if"].call(depth0,depth0&&depth0.hidden,{hash:{},inverse:self.noop,fn:self.program(1,function(){return" hidden"},data),data:data}),(stack1||0===stack1)&&(buffer+=stack1),buffer+="\">\n    <div class=\"qti-navigator-collapsible\">\n        <span class=\"qti-navigator-collapse icon icon-left\" title=\""+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Collapse the review panel",options):helperMissing.call(depth0,"__","Collapse the review panel",options)))+"\"></span>\n        <span class=\"qti-navigator-expand icon icon-right\" title=\""+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Expand the review panel",options):helperMissing.call(depth0,"__","Expand the review panel",options)))+"\"></span>\n    </div>\n    ",stack1=helpers["if"].call(depth0,depth0&&depth0.showLegend,{hash:{},inverse:self.noop,fn:self.program(3,program3,data),data:data}),(stack1||0===stack1)&&(buffer+=stack1),buffer+="\n\n\n    <div class=\"qti-navigator-filters\">\n        <ul class=\"plain clearfix\">\n            <li class=\"qti-navigator-filter active\" data-mode=\"all\">\n                <span title=\""+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Reset filters",options):helperMissing.call(depth0,"__","Reset filters",options)))+"\" class=\"qti-navigator-tab\">"+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"All",options):helperMissing.call(depth0,"__","All",options)))+"\n                    ",stack1=helpers.unless.call(depth0,depth0&&depth0.showLegend,{hash:{},inverse:self.noop,fn:self.program(5,function(){return"(<span class=\"qti-navigator-counter\">0</span>)"},data),data:data}),(stack1||0===stack1)&&(buffer+=stack1),buffer+="\n                </span>\n            </li>\n\n            <li class=\"qti-navigator-filter\" data-mode=\"unanswered\">\n                <span class=\"",stack1=helpers["if"].call(depth0,depth0&&depth0.showLegend,{hash:{},inverse:self.noop,fn:self.program(7,function(){return"icon-unanswered "},data),data:data}),(stack1||0===stack1)&&(buffer+=stack1),buffer+="qti-navigator-tab\" title=\""+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Only display the unanswered items",options):helperMissing.call(depth0,"__","Only display the unanswered items",options)))+"\">\n                    ",stack1=helpers.unless.call(depth0,depth0&&depth0.showLegend,{hash:{},inverse:self.noop,fn:self.program(9,program9,data),data:data}),(stack1||0===stack1)&&(buffer+=stack1),buffer+="\n                </span>\n            </li>\n\n            <li class=\"qti-navigator-filter\" data-mode=\"flagged\">\n                <span class=\"",stack1=helpers["if"].call(depth0,depth0&&depth0.showLegend,{hash:{},inverse:self.noop,fn:self.program(11,function(){return"icon-flagged "},data),data:data}),(stack1||0===stack1)&&(buffer+=stack1),buffer+="qti-navigator-tab\" title=\""+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Only display the items marked for review",options):helperMissing.call(depth0,"__","Only display the items marked for review",options)))+"\">\n                    ",stack1=helpers.unless.call(depth0,depth0&&depth0.showLegend,{hash:{},inverse:self.noop,fn:self.program(13,program13,data),data:data}),(stack1||0===stack1)&&(buffer+=stack1),buffer+="\n                </span>\n            </li>\n        </ul>\n    </div>\n\n    <nav class=\"qti-navigator-tree\"></nav>\n\n    <div id=\"qti-navigator-linear\" class=\"qti-navigator-linear\">\n        <span class=\"icon icon-info\" title=\""+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"In this part of the test navigation is not allowed.",options):helperMissing.call(depth0,"__","In this part of the test navigation is not allowed.",options)))+"\"></span>\n        <p class=\"qti-navigator-message\">\n            "+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"In this part of the test navigation is not allowed.",options):helperMissing.call(depth0,"__","In this part of the test navigation is not allowed.",options)))+"\n        </p>\n    </div>\n</div>",buffer})}),define("tpl!taoQtiTest/runner/plugins/navigation/review/navigatorTree",["handlebars"],function(hb){return hb.template(function(Handlebars,depth0,helpers,partials,data){function program1(depth0,data){var buffer="",stack1,helper;return buffer+="\n    <li class=\"qti-navigator-part collapsible ",stack1=helpers["if"].call(depth0,depth0&&depth0.active,{hash:{},inverse:self.program(4,program4,data),fn:self.program(2,program2,data),data:data}),(stack1||0===stack1)&&(buffer+=stack1),buffer+="\" data-id=\"",(helper=helpers.id)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.id,stack1="function"===_typeof(helper)?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+"\">\n        <span class=\"qti-navigator-label\" title=\"",(helper=helpers.label)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.label,stack1="function"===_typeof(helper)?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+"\">\n            <span class=\"qti-navigator-text\">",(helper=helpers.label)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.label,stack1="function"===_typeof(helper)?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+"</span>\n            <span class=\"icon-up\"></span>\n            <span class=\"icon-down\"></span>\n        </span>\n        ",stack1=helpers["if"].call(depth0,depth0&&depth0.isLinear,{hash:{},inverse:self.program(8,program8,data),fn:self.program(6,program6,data),data:data}),(stack1||0===stack1)&&(buffer+=stack1),buffer+="\n    </li>\n    ",buffer}function program2(){return"active"}function program4(){return"collapsed"}function program6(depth0,data){var buffer="",stack1,helper,options;return buffer+="\n        <div class=\"qti-navigator-linear-part collapsible-panel\">\n            <span class=\"icon icon-info\" title=\""+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"In this part of the test navigation is not allowed.",options):helperMissing.call(depth0,"__","In this part of the test navigation is not allowed.",options)))+"\"></span>\n            <p class=\"qti-navigator-message\">\n                "+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"In this part of the test navigation is not allowed.",options):helperMissing.call(depth0,"__","In this part of the test navigation is not allowed.",options)))+"\n            </p>\n            <p class=\"qti-navigator-actions\">\n                <button class=\"btn-info small\" data-position=\"",(helper=helpers.position)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.position,stack1="function"===_typeof(helper)?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+"\" title=\""+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Start Test-part",options):helperMissing.call(depth0,"__","Start Test-part",options)))+"\">\n                    <span class=\"qti-navigator-text\">"+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Start Test-part",options):helperMissing.call(depth0,"__","Start Test-part",options)))+"</span>\n                    <span class=\"icon-play r\"></span>\n                </button>\n            </p>\n        </div>\n        ",buffer}function program8(depth0,data){var buffer="",stack1;return buffer+="\n        <ul class=\"qti-navigator-sections collapsible-panel plain\">\n            ",stack1=helpers.each.call(depth0,depth0&&depth0.sections,{hash:{},inverse:self.noop,fn:self.program(9,program9,data),data:data}),(stack1||0===stack1)&&(buffer+=stack1),buffer+="\n        </ul>\n        ",buffer}function program9(depth0,data){var buffer="",stack1,helper;return buffer+="\n            <li class=\"qti-navigator-section collapsible ",stack1=helpers["if"].call(depth0,depth0&&depth0.active,{hash:{},inverse:self.program(4,program4,data),fn:self.program(2,program2,data),data:data}),(stack1||0===stack1)&&(buffer+=stack1),buffer+="\" data-id=\"",(helper=helpers.id)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.id,stack1="function"===_typeof(helper)?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+"\">\n                <span class=\"qti-navigator-label\" title=\"",(helper=helpers.label)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.label,stack1="function"===_typeof(helper)?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+"\">\n                    <span class=\"qti-navigator-text\">",(helper=helpers.label)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.label,stack1="function"===_typeof(helper)?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+"</span>\n                    <span class=\"qti-navigator-counter\">"+escapeExpression((stack1=(stack1=depth0&&depth0.stats,null==stack1||!1===stack1?stack1:stack1.answered),"function"===_typeof(stack1)?stack1.apply(depth0):stack1))+"/"+escapeExpression((stack1=(stack1=depth0&&depth0.stats,null==stack1||!1===stack1?stack1:stack1.total),"function"===_typeof(stack1)?stack1.apply(depth0):stack1))+"</span>\n                </span>\n                <ul class=\"qti-navigator-items collapsible-panel plain\">\n                    ",stack1=helpers.each.call(depth0,depth0&&depth0.items,{hash:{},inverse:self.noop,fn:self.program(10,program10,data),data:data}),(stack1||0===stack1)&&(buffer+=stack1),buffer+="\n                </ul>\n            </li>\n            ",buffer}function program10(depth0,data){var buffer="",stack1,helper;return buffer+="\n                    <li class=\"qti-navigator-item ",(helper=helpers.cls)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.cls,stack1="function"===_typeof(helper)?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+"\" data-id=\"",(helper=helpers.id)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.id,stack1="function"===_typeof(helper)?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+"\" data-position=\"",(helper=helpers.position)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.position,stack1="function"===_typeof(helper)?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+"\">\n                        <span class=\"qti-navigator-label truncate\" title=\"",(helper=helpers.label)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.label,stack1="function"===_typeof(helper)?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+"\">\n                            <span class=\"qti-navigator-icon icon-",(helper=helpers.icon)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.icon,stack1="function"===_typeof(helper)?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+"\"></span>\n                            <span class=\"qti-navigator-number\">",(helper=helpers.index)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.index,stack1="function"===_typeof(helper)?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+"</span>\n                            ",(helper=helpers.label)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.label,stack1="function"===_typeof(helper)?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+"\n                        </span>\n                    </li>\n                    ",buffer}this.compilerInfo=[4,">= 1.0.0"],helpers=this.merge(helpers,Handlebars.helpers),data=data||{};var buffer="",helperMissing=helpers.helperMissing,escapeExpression=this.escapeExpression,self=this,stack1;return buffer+="<ul class=\"qti-navigator-parts plain\">\n    ",stack1=helpers.each.call(depth0,depth0&&depth0.parts,{hash:{},inverse:self.noop,fn:self.program(1,program1,data),data:data}),(stack1||0===stack1)&&(buffer+=stack1),buffer+="\n</ul>",buffer})}),define("taoQtiTest/runner/plugins/navigation/review/navigator",["jquery","lodash","i18n","ui/component","ui/autoscroll","taoQtiTest/runner/helpers/map","tpl!taoQtiTest/runner/plugins/navigation/review/navigator","tpl!taoQtiTest/runner/plugins/navigation/review/navigatorTree"],function($,_,__,component,autoscroll,mapHelper,navigatorTpl,navigatorTreeTpl){'use strict';var _defaults={scope:"test",canCollapse:!1,preventsUnseen:!0,hidden:!1},_cssCls={active:"active",collapsed:"collapsed",collapsible:"collapsible",hidden:"hidden",disabled:"disabled",flagged:"flagged",answered:"answered",viewed:"viewed",unseen:"unseen",info:"info",icon:"qti-navigator-icon",scope:{test:"scope-test",testPart:"scope-test-part",testSection:"scope-test-section"}},_iconCls=[_cssCls.info,_cssCls.flagged,_cssCls.answered,_cssCls.viewed],_selectors={component:".qti-navigator",filterBar:".qti-navigator-filters",filter:".qti-navigator-filter",tree:".qti-navigator-tree",collapseHandle:".qti-navigator-collapsible",linearState:".qti-navigator-linear",infoAnswered:".qti-navigator-answered .qti-navigator-counter",infoViewed:".qti-navigator-viewed .qti-navigator-counter",infoUnanswered:".qti-navigator-unanswered .qti-navigator-counter",infoFlagged:".qti-navigator-flagged .qti-navigator-counter",infoPanel:".qti-navigator-info",infoPanelLabels:".qti-navigator-info > .qti-navigator-label",tabInfoAll:"[data-mode=\"all\"] .qti-navigator-counter",tabInfoUnanswered:"[data-mode=\"unanswered\"] .qti-navigator-counter",tabInfoFlagged:"[data-mode=\"flagged\"] .qti-navigator-counter",parts:".qti-navigator-part",partLabels:".qti-navigator-part > .qti-navigator-label",sections:".qti-navigator-section",sectionLabels:".qti-navigator-section > .qti-navigator-label",items:".qti-navigator-item",itemLabels:".qti-navigator-item > .qti-navigator-label",itemIcons:".qti-navigator-item > .qti-navigator-icon",activeItem:".qti-navigator-item.active",icons:".qti-navigator-icon",linearStart:".qti-navigator-linear-part button",counters:".qti-navigator-counter",actives:".active",collapsible:".collapsible",collapsiblePanels:".collapsible-panel",unseen:".unseen",answered:".answered",flagged:".flagged",notFlagged:":not(.flagged)",notAnswered:":not(.answered)",notInformational:":not(.info)",informational:".info",hidden:".hidden",disabled:".disabled"},_filterMap={all:"",unanswered:[_selectors.answered,_selectors.informational].join(","),flagged:_selectors.notFlagged,answered:_selectors.notAnswered,filtered:_selectors.hidden},navigatorApi={updateStats:function(position,flag){var map=this.map,item;map&&(item=mapHelper.getItemAt(map,position),item&&(item.flagged=flag,mapHelper.updateItemStats(map,position)))},getProgressionTotal:function(progression,target){var total;return total="questions"===target?progression.questions:progression.total,total},setItemFlag:function(position,flag){var $item=position&&position.jquery?position:this.controls.$tree.find("[data-position="+position+"]"),progression=this.progression,icon;this.updateStats(position,flag),$item.toggleClass(_cssCls.flagged,flag),icon=_.find(_iconCls,_.bind($item.hasClass,$item))||_cssCls.unseen,$item.find(_selectors.icons).attr("class",_cssCls.icon+" icon-"+icon),progression.flagged=this.controls.$tree.find(_selectors.flagged).length,this.writeCount(this.controls.$infoFlagged,progression.flagged,this.getProgressionTotal(progression,"questions")),this.filter(this.currentFilter)},filter:function(criteria){var self=this,$items=this.controls.$tree.find(_selectors.items).removeClass(_cssCls.hidden),filterCb=_filterMap[criteria];filterCb&&$items.filter(filterCb).addClass(_cssCls.hidden),this.controls.$tree.find(_selectors.sections).each(function(){var $section=$(this),$itemsFound=$section.find(_selectors.items).not(_selectors.hidden),$filtered=$itemsFound.not(_selectors.disabled);self.writeCount($section.find(_selectors.counters),$filtered.length,$itemsFound.length)}),this.currentFilter=criteria},updateConfig:function(config){var $component=this.getElement(),scopeClass=_cssCls.scope[this.config.scope||_defaults.scope];return config=_.merge(this.config,config||{}),$component.toggleClass(_cssCls.collapsible,config.canCollapse),$component.removeClass(scopeClass),scopeClass=_cssCls.scope[this.config.scope||_defaults.scope],$component.addClass(scopeClass),this},autoScroll:function(){autoscroll(this.controls.$tree.find(_selectors.activeItem),this.controls.$tree)},update:function(map,context){var scopedMap=this.getScopedMap(map,context),progression=scopedMap.stats||{questions:0,answered:0,flagged:0,viewed:0,total:0},totalQuestions=this.getProgressionTotal(progression,"questions"),activeItem,isSkipaheadEnabled;return this.map=map,this.progression=progression,this.writeCount(this.controls.$infoAnswered,progression.answered,totalQuestions),this.writeCount(this.controls.$infoUnanswered,totalQuestions-progression.answered,totalQuestions),this.writeCount(this.controls.$infoViewed,progression.viewed,this.getProgressionTotal(progression,"total")),this.writeCount(this.controls.$infoFlagged,progression.flagged,totalQuestions),this.writeCount(this.controls.$infoAll,totalQuestions,null),context.isLinear?(this.controls.$filterBar.hide(),this.controls.$linearState.show(),this.controls.$tree.empty()):(this.controls.$filterBar.show(),this.controls.$linearState.hide(),this.controls.$tree.html(navigatorTreeTpl(scopedMap)),this.autoScroll(),activeItem=mapHelper.getActiveItem(scopedMap),this.setState("prevents-unseen",this.config.preventsUnseen),isSkipaheadEnabled=activeItem&&activeItem.categories&&0<=_.indexOf(activeItem.categories,"x-tao-option-review-skipahead"),this.setState("skipahead-enabled",isSkipaheadEnabled),this.config.preventsUnseen&&!isSkipaheadEnabled&&this.controls.$tree.find(_selectors.unseen).addClass(_cssCls.disabled)),this.filter(this.controls.$filters.filter(_selectors.actives).data("mode")),this.trigger("update"),this},getScopedMap:function(map,context){var scopedMap=mapHelper.getScopeMapFromContext(map,context,this.config.scope),testPart=mapHelper.getPart(scopedMap,context.testPartId)||{},section=mapHelper.getSection(scopedMap,context.sectionId)||{},item=mapHelper.getItem(scopedMap,context.itemIdentifier)||{};return testPart.active=!0,section.active=!0,item.active=!0,mapHelper.each(scopedMap,function(itm){var cls=[],icon="";itm.active&&cls.push("active"),itm.informational&&(cls.push("info"),icon=icon||"info"),itm.flagged&&(cls.push("flagged"),icon=icon||"flagged"),itm.answered&&(cls.push("answered"),icon=icon||"answered"),itm.viewed?(cls.push("viewed"),icon=icon||"viewed"):(cls.push("unseen"),icon=icon||"unseen"),itm.cls=cls.join(" "),itm.icon=icon})},writeCount:function($place,count,total){var display=0;$place.parent().hasClass("qti-navigator-tab")?display=Math.max(count,0):0<total&&(display=Math.min(count,total)+"/"+total),$place.text(display)},select:function(position,open){var $tree=this.controls.$tree,selected=position&&position.jquery?position:$tree.find("[data-position="+position+"]"),hierarchy=selected.parentsUntil($tree),previousPosition=0,$previous=$tree.find(_selectors.activeItem);return $previous.length&&(previousPosition=$previous.data("position")),open&&this.openOnly(hierarchy),$tree.find(_selectors.actives).removeClass(_cssCls.active),hierarchy.add(selected).addClass(_cssCls.active),position=selected.data("position"),this.trigger("selected",position,previousPosition),selected},openSelected:function(){var $tree=this.controls.$tree,selected=$tree.find(_selectors.items+_selectors.actives),hierarchy=selected.parentsUntil($tree);return this.openOnly(hierarchy),selected},openOnly:function(opened,root){(root||this.controls.$tree).find(_selectors.collapsible).addClass(_cssCls.collapsed),opened.removeClass(_cssCls.collapsed)},togglePanel:function(panel,collapseSelector){var collapsed=panel.hasClass(_cssCls.collapsed);return collapseSelector&&this.controls.$tree.find(collapseSelector).addClass(_cssCls.collapsed),collapsed?panel.removeClass(_cssCls.collapsed):panel.addClass(_cssCls.collapsed),collapsed},toggle:function(show){return"undefined"==typeof show&&(show=this.is("hidden")),show?this.show():this.hide(),this}};return function(config,map,context){function flagItem($item){var position=$item.data("position"),flagged=!$item.hasClass(_cssCls.flagged);navigator.setItemFlag(position,flagged),navigator.trigger("flag",position,flagged)}function jump($item){var position=$item.data("position");navigator.trigger("jump",position)}var navigator;return navigator=component(navigatorApi,_defaults).setTemplate(navigatorTpl).on("destroy",function(){this.controls=null}).on("show",function(){this.autoScroll()}).on("render",function(){var self=this,$component=this.getElement(),$filterBar=$component.find(_selectors.filterBar),$filters=$filterBar.find("li"),$tree=$component.find(_selectors.tree);this.controls={$infoAnswered:$component.find(_selectors.infoAnswered),$infoViewed:$component.find(_selectors.infoViewed),$infoAll:$component.find(_selectors.tabInfoAll),$infoUnanswered:this.config.showLegend?$component.find(_selectors.infoUnanswered):$component.find(_selectors.tabInfoUnanswered),$infoFlagged:this.config.showLegend?$component.find(_selectors.infoFlagged):$component.find(_selectors.tabInfoFlagged),$filterBar:$filterBar,$filters:$filters,$tree:$tree,$linearState:$component.find(_selectors.linearState)},this.updateConfig(),$component.on("click"+_selectors.component,_selectors.collapseHandle,function(){self.is("disabled")||($component.toggleClass(_cssCls.collapsed),$component.hasClass(_cssCls.collapsed)&&self.openSelected())}),$component.on("click"+_selectors.component,_selectors.infoPanelLabels,function(){self.is("disabled")||self.togglePanel($(this).closest(_selectors.infoPanel),_selectors.infoPanel)}),$tree.on("click"+_selectors.component,_selectors.partLabels,function(){var $panel;self.is("disabled")||($panel=$(this).closest(_selectors.parts),self.togglePanel($panel,_selectors.parts)&&($panel.hasClass(_cssCls.active)?self.openSelected():self.openOnly($panel.find(_selectors.sections).first(),$panel)))}),$tree.on("click"+_selectors.component,_selectors.sectionLabels,function(){self.is("disabled")||self.togglePanel($(this).closest(_selectors.sections),_selectors.sections)}),$tree.on("click"+_selectors.component,_selectors.itemLabels,function(event){var $item,$target;self.is("disabled")||($item=$(this).closest(_selectors.items),!$item.hasClass(_cssCls.disabled)&&($target=$(event.target),self.config.canFlag&&$target.is(_selectors.icons)&&!$component.hasClass(_cssCls.collapsed)?!$item.hasClass(_cssCls.unseen)&&!$item.hasClass(_cssCls.info)&&flagItem($item):!$item.hasClass(_cssCls.active)&&(self.select($item),jump($item))))}),$tree.on("click"+_selectors.component,_selectors.linearStart,function(){var $btn;self.is("disabled")||($btn=$(this),!$btn.hasClass(_cssCls.disabled)&&($btn.addClass(_cssCls.disabled),jump($btn)))}),$filterBar.on("click"+_selectors.component,_selectors.filter,function(){var $btn,mode;self.is("disabled")||($btn=$(this),mode=$btn.data("mode"),$filters.removeClass(_cssCls.active),$component.removeClass(_cssCls.collapsed),$btn.addClass(_cssCls.active),self.filter(mode),self.autoScroll())}),this.update(map,context)}),navigator.currentFilter="all",navigator.init(config)}}),define("taoQtiTest/runner/plugins/navigation/review/review",["jquery","lodash","i18n","ui/hider","util/shortcut","util/namespace","taoTests/runner/plugin","taoQtiTest/runner/helpers/map","taoQtiTest/runner/plugins/navigation/review/navigator"],function($,_,__,hider,shortcut,namespaceHelper,pluginFactory,mapHelper,navigatorFactory){'use strict';function getFlagItemButtonData(context){var dataType=context.itemFlagged?"unsetFlag":"setFlag";return buttonData[dataType]}function getToggleButtonData(navigator){var dataType=navigator.is("hidden")?"showReview":"hideReview";return buttonData[dataType]}function updateButton(button,data){var $button=button.getElement();button.is("rendered")&&$button.data("control")!==data.control&&($button.data("control",data.control).attr("title",data.title),$button.find(".icon").attr("class","icon icon-"+data.icon),$button.find(".text").text(data.text),_.contains(data.control,"flag")&&(button.is("active")?button.turnOff():button.turnOn()))}function canFlag(testRunner){var context=testRunner.getTestContext(),map=testRunner.getTestMap(),item=mapHelper.getItemAt(map,context.itemPosition);return!(context.isLinear||!context.options.markReview||item&&item.informational)}var buttonData={setFlag:{control:"set-item-flag",title:__("Flag the current item for later review"),icon:"anchor",text:__("Flag for Review")},unsetFlag:{control:"unset-item-flag",title:__("Do not flag the current item for later review"),icon:"anchor",text:__("Unflag for Review")},showReview:{control:"show-review",title:__("Show the review screen"),icon:"right",text:__("Show Review")},hideReview:{control:"hide-review",title:__("Hide the review screen"),icon:"left",text:__("Hide Review")}};return pluginFactory({name:"review",init:function(){function isPluginAllowed(){var context=testRunner.getTestContext();return navigatorConfig.enabled&&context&&context.options&&context.options.reviewScreen}function flagItem(position,flag){return self.disable(),testRunner.getProxy().callTestAction("flagItem",{position:position,flag:flag}).then(function(){var context=testRunner.getTestContext();context.itemPosition===position&&(context.itemFlagged=flag),updateButton(self.flagItemButton,getFlagItemButtonData(context)),self.navigator.setItemFlag(position,flag),self.enable()}).catch(function(){self.navigator.setItemFlag(position,!flag),self.enable()})}function flagCurrentItem(){var context=testRunner.getTestContext();!1!==self.getState("enabled")&&flagItem(context.itemPosition,!context.itemFlagged)}function togglePanel(forcedState){var isHidden=_.isUndefined(forcedState)?self.navigator.is("hidden"):forcedState;isHidden?(self.explicitlyHidden=!1,self.navigator.show()):(self.explicitlyHidden=!0,self.navigator.hide()),updateButton(self.toggleButton,getToggleButtonData(self.navigator))}var self=this,testRunner=this.getTestRunner(),testData=testRunner.getTestData(),testContext=testRunner.getTestContext(),testMap=testRunner.getTestMap(),testConfig=testData.config||{},pluginShortcuts=(testConfig.shortcuts||{})[this.getName()]||{},navigatorConfig=testConfig.review||{},previousItemPosition;this.navigator=navigatorFactory(navigatorConfig,testMap,testContext).on("selected",function(position,previousPosition){previousItemPosition=previousPosition}).on("jump",function(position){!1!==self.getState("enabled")&&(self.disable(),testRunner.jump(position,"item"))}).on("flag",function(position,flag){!1!==self.getState("enabled")&&flagItem(position,flag)}).render(),testRunner.on("alert.notallowed",function(){self.navigator.select(previousItemPosition)}),this.explicitlyHidden=!1,this.toggleButton=this.getAreaBroker().getToolbox().createEntry(getToggleButtonData(this.navigator)),this.toggleButton.on("click",function(e){e.preventDefault(),testRunner.trigger("tool-reviewpanel")}),this.flagItemButton=this.getAreaBroker().getToolbox().createEntry(getFlagItemButtonData(testContext)),this.flagItemButton.on("click",function(e){e.preventDefault(),testRunner.trigger("tool-flagitem")}),testConfig.allowShortcuts&&(pluginShortcuts.flag&&shortcut.add(namespaceHelper.namespaceAll(pluginShortcuts.flag,this.getName(),!0),function(){testRunner.trigger("tool-flagitem")},{avoidInput:!0}),pluginShortcuts.toggle&&shortcut.add(namespaceHelper.namespaceAll(pluginShortcuts.toggle,this.getName(),!0),function(){testRunner.trigger("tool-reviewpanel")},{avoidInput:!0})),isPluginAllowed()||this.hide(),this.disable(),togglePanel(testConfig.review.defaultOpen),testRunner.on("render",function(){isPluginAllowed()?(self.show(),updateButton(self.toggleButton,getToggleButtonData(self.navigator))):self.hide()}).on("loaditem",function(){var context=testRunner.getTestContext(),map=testRunner.getTestMap();isPluginAllowed()?(updateButton(self.flagItemButton,getFlagItemButtonData(context)),self.navigator.update(map,context).updateConfig({canFlag:!context.isLinear&&context.options.markReview}),self.show(),updateButton(self.toggleButton,getToggleButtonData(self.navigator))):self.hide()}).on("enabletools enablenav",function(){isPluginAllowed()&&self.enable()}).on("disabletools disablenav",function(){isPluginAllowed()&&self.disable()}).on("hidenav",function(){self.hide()}).on("shownav",function(){isPluginAllowed()&&self.show()}).on("tool-flagitem",function(){isPluginAllowed()&&canFlag(testRunner)&&flagCurrentItem()}).on("tool-reviewpanel",function(){isPluginAllowed()&&self.getState("enabled")&&togglePanel()})},render:function(){var areaBroker=this.getAreaBroker(),$panelContainer=areaBroker.getPanelArea();$panelContainer.append(this.navigator.getElement())},destroy:function(){shortcut.remove("."+this.getName()),this.navigator.destroy()},enable:function(){var testRunner=this.getTestRunner(),testContext=testRunner.getTestContext();this.flagItemButton.enable(),this.toggleButton.enable(),this.navigator.enable(),testContext.itemFlagged?this.flagItemButton.turnOn():this.flagItemButton.turnOff()},disable:function(){this.flagItemButton.disable(),this.flagItemButton.turnOff(),this.toggleButton.disable(),this.navigator.disable()},show:function(){var testRunner=this.getTestRunner();canFlag(testRunner)?this.flagItemButton.show():this.flagItemButton.hide(),this.toggleButton.show(),this.explicitlyHidden?this.navigator.hide():this.navigator.show()},hide:function(){this.flagItemButton.hide(),this.toggleButton.hide(),this.navigator.hide()}})}),define("taoQtiTest/runner/plugins/navigation/skip",["jquery","lodash","i18n","ui/hider","taoTests/runner/plugin","taoQtiTest/runner/helpers/messages","tpl!taoQtiTest/runner/plugins/templates/button"],function($,_,__,hider,pluginFactory,messages,buttonTpl){'use strict';var buttonData={skip:{control:"skip",title:__("Skip and go to the next item"),icon:"external",text:__("Skip")},end:{control:"skip-end",title:__("Skip and go to the end of the test"),icon:"external",text:__("Skip and end test")}},createElement=function(context){var dataType=context.isLast?"end":"skip";return $(buttonTpl(buttonData[dataType]))},updateElement=function($element,context){var dataType=context.isLast?"end":"skip";$element.attr("data-control")!==buttonData[dataType].control&&$element.attr("data-control",buttonData[dataType].control).attr("title",buttonData[dataType].title).find(".text").text(buttonData[dataType].text)};return pluginFactory({name:"skip",init:function(){function doSkip(){testRunner.skip()}var self=this,testRunner=this.getTestRunner(),toggle=function(){var context=testRunner.getTestContext();return!0===context.options.allowSkipping?(self.show(),!0):(self.hide(),!1)};this.$element=createElement(testRunner.getTestContext()),this.$element.on("click",function(e){var enable=_.bind(self.enable,self),context=testRunner.getTestContext();e.preventDefault(),!1!==self.getState("enabled")&&(self.disable(),context.options.endTestWarning&&context.isLast?testRunner.trigger("confirm.endTest",messages.getExitMessage(__("You are about to submit the test. You will not be able to access this test once submitted. Click OK to continue and submit the test."),"test",testRunner),doSkip,enable):doSkip())}),toggle(),self.disable(),testRunner.on("loaditem",function(){toggle()&&updateElement(self.$element,testRunner.getTestContext())}).on("enablenav",function(){self.enable()}).on("disablenav",function(){self.disable()}).on("hidenav",function(){self.hide()}).on("shownav",function(){self.show()})},render:function(){var $container=this.getAreaBroker().getNavigationArea();$container.append(this.$element)},destroy:function(){this.$element.remove()},enable:function(){this.$element.removeProp("disabled").removeClass("disabled")},disable:function(){this.$element.prop("disabled",!0).addClass("disabled")},show:function(){hider.show(this.$element)},hide:function(){hider.hide(this.$element)}})}),define("taoQtiTest/runner/plugins/navigation/validateResponses",["lodash","i18n","taoTests/runner/plugin","taoQtiTest/runner/helpers/currentItem"],function(_,__,pluginFactory,currentItemHelper){'use strict';return pluginFactory({name:"validateResponses",init:function(){return this.getTestRunner().before("move",function(e,direction){var self=this,testContext=this.getTestContext(),isInteracting=!this.getItemState(testContext.itemIdentifier,"disabled"),testData=this.getTestData()||{},testConfig=testData.config||{},pluginConfig=_.defaults((testConfig.plugins||{}).validateResponses||{});return pluginConfig.validateOnPreviousMove||"previous"!==direction?isInteracting&&testContext.enableValidateResponses&&testContext.validateResponses?new Promise(function(resolve,reject){return 0===_.size(currentItemHelper.getDeclarations(self))?resolve():currentItemHelper.isAnswered(self,!1)?resolve():void(!self.getState("alerted.notallowed")&&(self.setState("alerted.notallowed",!0),self.trigger("alert.notallowed",__("A valid response to this item is required."),function(){self.trigger("resumeitem"),reject(),self.setState("alerted.notallowed",!1)})))}):void 0:Promise.resolve()}),this}})}),define("taoQtiTest/runner/plugins/navigation/warnBeforeLeaving",["i18n","taoTests/runner/plugin"],function(__,pluginFactory){'use strict';var warnMessage=__("Please confirm you want to leave the test."),warnListener=function(e){return e.returnValue=warnMessage,warnMessage};return pluginFactory({name:"warnBeforeLeaving",init:function(){this.enable()},destroy:function(){this.disable()},enable:function(){window.addEventListener("beforeunload",warnListener)},disable:function(){window.removeEventListener("beforeunload",warnListener)}})}),define("taoQtiTest/runner/plugins/security/disableRightClick",["taoTests/runner/plugin"],function(pluginFactory){'use strict';return pluginFactory({name:"disableRightClick",init:function(){["contextmenu","mousedown","mouseup"].forEach(function(eventName){window.document.addEventListener(eventName,function(event){2===event.button&&event.preventDefault()})})}})}),define("taoQtiTest/runner/plugins/tools/answerElimination/eliminator",["jquery","lodash","i18n","ui/hider","util/shortcut","util/namespace","taoTests/runner/plugin"],function($,_,__,hider,shortcut,namespaceHelper,pluginFactory){'use strict';var actionPrefix="tool-eliminator-",defaultConfig={removeEliminationsOnClose:!1,restoreEliminationsOnOpen:!1};return pluginFactory({name:"eliminator",init:function(){function isPluginEnabled(){var context=testRunner.getTestContext()||{},options=context.options||{};return!!options.eliminator}function togglePlugin(){self.$choiceInteractions&&(self.$choiceInteractions.toggleClass("eliminable"),isEliminable()?enableEliminator():disableEliminator())}function isEliminable(){return self.$choiceInteractions?self.$choiceInteractions.hasClass("eliminable"):void 0}function enableEliminator(){var $choices;self.$choiceInteractions&&($choices=self.$choiceInteractions.find(".qti-choice"),self.button.turnOn(),self.trigger("start"),config.restoreEliminationsOnOpen&&$choices.each(function(){var input=this.querySelector(".real-label input");this.dataset.wasEliminated&&(this.dataset.wasEliminated=null,this.classList.add("eliminated"),input.setAttribute("disabled","disabled"),input.checked=!1)}))}function disableEliminator(){var $choices;self.$choiceInteractions&&($choices=self.$choiceInteractions.find(".qti-choice"),self.$choiceInteractions.removeClass("eliminable"),self.button.turnOff(),self.trigger("end"),$choices.each(function(){this.classList.contains("eliminated")&&(this.dataset.wasEliminated=!0,this.classList.remove("eliminated"),this.querySelector(".real-label input").removeAttribute("disabled"))}))}var self=this,testRunner=this.getTestRunner(),$container=testRunner.getAreaBroker().getContentArea().parent(),testConfig=testRunner.getTestData().config||{},pluginShortcuts=(testConfig.shortcuts||{}).eliminator||{},config=_.defaults(_.clone((testConfig.plugins||{}).eliminator)||{},defaultConfig);this.button=this.getAreaBroker().getToolbox().createEntry({control:"eliminator",title:__("Eliminate choices"),icon:"eliminate",text:__("Answer Eliminator")}),this.button.on("click",function(e){e.preventDefault(),testRunner.trigger(actionPrefix+"toggle")}),testConfig.allowShortcuts&&_.forEach(pluginShortcuts,function(command,key){shortcut.add(namespaceHelper.namespaceAll(command,"eliminator",!0),function(){testRunner.trigger(actionPrefix+key)},{avoidInput:!0})}),this.disable(),testRunner.on("loaditem",function(){isPluginEnabled()?self.show():self.hide()}).on("renderitem",function(){return self.$choiceInteractions=$container.find(".qti-choiceInteraction"),self.$choiceInteractions.length?void(isPluginEnabled()&&self.show()):void self.hide()}).on("enabletools renderitem",function(){self.enable()}).on("disabletools unloaditem",function(){self.disable(),disableEliminator()}).on(actionPrefix+"toggle",function(){isPluginEnabled()&&togglePlugin()}).on("tool-answer-masking-toggle",function(){isEliminable()&&disableEliminator()})},destroy:function(){shortcut.remove(".eliminator")},enable:function(){this.button.enable()},disable:function(){this.button.disable()},show:function(){this.button.show()},hide:function(){this.button.hide()}})}),function(global,factory){"object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&"undefined"!=typeof module?module.exports=factory(require("lodash")):"function"==typeof define&&define.amd?define("core/statifier",["lodash"],factory):(global=global||self,global["core/statifier"]=factory(global._))}(this,function(_){'use strict';function statifierFactory(target){var states={},statesApi={getState:function(name){return!!states[name]},setState:function(name,value){return"undefined"==typeof value&&(value=!0),states[name]=!!value,this},clearStates:function(){return states={},this},getStates:function(){return _.reduce(states,function(result,state,key){return state&&result.push(key),result},[])}};return target=target||{},_(statesApi).functions().forEach(function(method){target[method]=function(){var args=[].slice.call(arguments);return statesApi[method].apply(target,args)}}),target}return _=_&&_.hasOwnProperty("default")?_["default"]:_,statifierFactory}),define("tpl!taoQtiTest/runner/plugins/tools/answerMasking/tpl/mask",["handlebars"],function(hb){return hb.template(function(Handlebars,depth0,helpers,partials,data){return this.compilerInfo=[4,">= 1.0.0"],helpers=this.merge(helpers,Handlebars.helpers),data=data||{},"<div class=\"answer-mask\">\n    <span class=\"answer-mask-toggle\"></span>\n</div>"})}),define("taoQtiTest/runner/plugins/tools/answerMasking/answerMasking",["lodash","jquery","core/statifier","ui/component","tpl!taoQtiTest/runner/plugins/tools/answerMasking/tpl/mask"],function(_,$,statifier,componentFactory,maskTpl){'use strict';return function($contentArea){function createMask($container){return componentFactory(maskApi).setTemplate(maskTpl).on("render",function(){var self=this,$component=this.getElement();$component.on("click.answerMasking",function(e){e.stopPropagation(),e.preventDefault(),self.toggle()})}).on("destroy",function(){var $component=this.getElement();$component.off(".answerMasking")}).init().render($container).mask()}var allMasks=[],maskApi={toggle:function(){return this.is("masked")?this.reveal():this.mask()},reveal:function(){var $container=this.getContainer();return $container.removeClass("masked"),$container.find("input").removeAttr("disabled"),this.setState("masked",!1),this},mask:function(){var $container=this.getContainer();return $container.addClass("masked"),$container.find("input").attr("disabled","disabled"),this.setState("masked",!0),this}},answerMasking;return answerMasking={enable:function(){var $choiceInteractions=$contentArea.find(".qti-choiceInteraction"),$qtiChoices=$contentArea.find(".qti-choice");allMasks=[],$choiceInteractions.addClass("maskable"),$qtiChoices.each(function(){var $choice=$(this);allMasks.push(createMask($choice))}),this.setState("enabled",!0)},disable:function(){var $choiceInteractions=$contentArea.find(".qti-choiceInteraction");$choiceInteractions.removeClass("maskable"),allMasks.forEach(function(mask){mask.reveal(),mask.destroy()}),allMasks=[],this.setState("enabled",!1)},getMasksState:function(){var state=allMasks.map(function(mask){return mask.is("masked")});return state},setMasksState:function(state){state=state||[],state.forEach(function(masked,index){var mask=allMasks[index];_.isObject(mask)&&_.isFunction(mask.reveal)&&!masked&&mask.reveal()})}},statifier(answerMasking),answerMasking}}),define("taoQtiTest/runner/plugins/tools/answerMasking/plugin",["jquery","lodash","i18n","taoTests/runner/plugin","ui/hider","util/shortcut","util/namespace","taoQtiTest/runner/plugins/tools/answerMasking/answerMasking"],function($,_,__,pluginFactory,hider,shortcut,namespaceHelper,answerMaskingFactory){'use strict';var actionPrefix="tool-answer-masking-",itemStates={},defaultConfig={restoreStateOnToggle:!0,restoreStateOnMove:!0};return pluginFactory({name:"answer-masking",init:function(){function isPluginEnabled(){var context=testRunner.getTestContext()||{},options=context.options||{};return options.answerMasking&&itemContainsChoiceInteraction()}function itemContainsChoiceInteraction(){var $container=self.getAreaBroker().getContentArea().parent();return $container.find(".qti-choiceInteraction").length}function togglePluginButton(){isPluginEnabled()?self.show():self.hide()}function togglePlugin(){answerMasking.getState("enabled")?disableMasking():enableMasking()}function enableMasking(){var testContext=testRunner.getTestContext(),itemId=testContext.itemIdentifier;answerMasking.enable(),pluginConfig.restoreStateOnToggle&&answerMasking.setMasksState(itemStates[itemId]),self.button.turnOn(),self.trigger("start")}function disableMasking(){var testContext=testRunner.getTestContext(),itemId=testContext.itemIdentifier;answerMasking.getState("enabled")&&(itemStates[itemId]=answerMasking.getMasksState()),answerMasking.disable(),self.button.turnOff(),self.trigger("end")}var self=this,testRunner=this.getTestRunner(),testData=testRunner.getTestData()||{},testConfig=testData.config||{},pluginConfig=_.defaults((testConfig.plugins||{})["answer-masking"]||{},defaultConfig),pluginShortcuts=(testConfig.shortcuts||{})["answer-masking"]||{},$contentArea=this.getAreaBroker().getContentArea(),answerMasking=answerMaskingFactory($contentArea);this.button=this.getAreaBroker().getToolbox().createEntry({title:__("Answer Masking"),icon:"result-nok",control:"answer-masking",text:__("Answer Masking")}),this.button.on("click",function(e){e.preventDefault(),testRunner.trigger(actionPrefix+"toggle")}),testConfig.allowShortcuts&&pluginShortcuts.toggle&&shortcut.add(namespaceHelper.namespaceAll(pluginShortcuts.toggle,this.getName(),!0),function(){testRunner.trigger(actionPrefix+"toggle")},{avoidInput:!0,prevent:!0}),this.disable(),testRunner.on("loaditem",function(){var testContext=testRunner.getTestContext(),itemId=testContext.itemIdentifier;pluginConfig.restoreStateOnMove||(itemStates[itemId]=[]),togglePluginButton()}).on("enabletools renderitem",function(){togglePluginButton(),self.enable()}).on("beforeunloaditem",function(){disableMasking()}).on("disabletools unloaditem",function(){self.disable(),disableMasking()}).on(actionPrefix+"toggle",function(){isPluginEnabled()&&togglePlugin()}).on("tool-eliminator-toggle",function(){disableMasking()})},destroy:function(){shortcut.remove("."+this.getName())},enable:function(){this.button.enable()},disable:function(){this.button.disable()},show:function(){this.button.show()},hide:function(){this.button.hide()}})}),define("tpl!taoQtiTest/runner/plugins/tools/areaMasking/mask",["handlebars"],function(hb){return hb.template(function(Handlebars,depth0,helpers,partials,data){this.compilerInfo=[4,">= 1.0.0"],helpers=this.merge(helpers,Handlebars.helpers),data=data||{};var buffer="",helperMissing=helpers.helperMissing,escapeExpression=this.escapeExpression,helper,options;return buffer+="<div class=\"mask\">\n   <div class=\"inner\"></div>\n   <div class=\"controls\">\n        <a href=\"#\" class=\"view\"  title=\""+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Preview the covered area",options):helperMissing.call(depth0,"__","Preview the covered area",options)))+"\"><span class=\"icon-preview\"></span></a>\n        <a href=\"#\" class=\"close\" title=\""+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Close the mask",options):helperMissing.call(depth0,"__","Close the mask",options)))+"\"><span class=\"icon-result-nok\"></span></a>\n   </div>\n</div>",buffer})}),function(global,factory){"object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&"undefined"!=typeof module?module.exports=factory():"function"==typeof define&&define.amd?define("core/mouseEvent",factory):(global=global||self,global["core/mouseEvent"]=factory())}(this,function(){'use strict';function triggerMouseEvent(element,eventName,eventOptions){var event;return-1!==allowedEvents.indexOf(eventName)&&(event=createEvent(eventName,eventOptions),dispatchEvent(element,eventName,event))}var allowedEvents=["click","contextmenu","dblclick","mousedown","mouseenter","mouseleave","mousemove","mouseout","mouseover","mouseup","show"],createEvent=function(eventName,eventOptions){var event;try{event=new MouseEvent(eventName,eventOptions)}catch(e){event=document.createEvent("MouseEvents"),event.initMouseEvent(eventName,eventOptions.bubbles||!1,eventOptions.cancelable||!1,eventOptions.view||null,eventOptions.detail||0,eventOptions.screenX||0,eventOptions.screenY||0,eventOptions.clientX||0,eventOptions.clientY||0,eventOptions.ctrlKey||!1,eventOptions.altKey||!1,eventOptions.shiftKey||!1,eventOptions.metaKey||!1,eventOptions.button||0,eventOptions.relatedTarget||null)}return event},dispatchEvent;return dispatchEvent=document.dispatchEvent?function(element,eventName,event){return!!element&&(element.dispatchEvent(event),!0)}:document.fireEvent?function(element,eventName,event){return!!element&&(element.fireEvent("on"+eventName,event),!0)}:function(){return!1},triggerMouseEvent}),function(global,factory){"object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&"undefined"!=typeof module?module.exports=factory():"function"==typeof define&&define.amd?define("util/position",factory):(global=global||self,global["util/position"]=factory())}(this,function(){'use strict';return{isInside:function(container,element){var containerCoords,elementCoords;if(container instanceof HTMLElement&&element instanceof HTMLElement&&(containerCoords=container.getBoundingClientRect(),elementCoords=element.getBoundingClientRect(),"object"===_typeof(containerCoords)&&"object"===_typeof(elementCoords)))return elementCoords.top>=containerCoords.top&&elementCoords.top<=containerCoords.bottom&&elementCoords.left>=containerCoords.left&&elementCoords.left<=containerCoords.right&&elementCoords.bottom<=containerCoords.bottom&&elementCoords.bottom>=containerCoords.top&&elementCoords.right<=containerCoords.right&&elementCoords.right>=containerCoords.left},isOver:function(container,element){var containerCoords,elementCoords;if(container instanceof HTMLElement&&element instanceof HTMLElement&&(containerCoords=container.getBoundingClientRect(),elementCoords=element.getBoundingClientRect(),"object"===_typeof(containerCoords)&&"object"===_typeof(elementCoords)))return elementCoords.top>=containerCoords.top&&elementCoords.top<=containerCoords.bottom&&elementCoords.left>=containerCoords.left&&elementCoords.left<=containerCoords.right}}}),define("taoQtiTest/runner/plugins/tools/areaMasking/mask",["lodash","ui/component","tpl!taoQtiTest/runner/plugins/tools/areaMasking/mask","ui/dynamicComponent"],function(_,component,areaMaskingTpl,dynamicComponent){'use strict';var defaultConfig={draggable:!0,resizable:!0,preserveAspectRatio:!1,width:250,minWidth:160,maxWidth:1e3,minHeight:60,height:100,stackingScope:"test-runner",top:50,left:10,previewDelay:3e3};return function(){var dynamicComponentInstance;return dynamicComponentInstance=dynamicComponent({preview:function(){var self=this,delay=this.config.previewDelay||1e3;return!this.is("rendered")||this.is("disabled")||this.is("previewing")||(this.setState("previewing",!0),this.trigger("preview"),_.delay(function(){self.setState("previewing",!1)},delay)),this}},defaultConfig).on("rendercontent",function($content){var self=this,$element=this.getElement();$content.append(areaMaskingTpl({})),$element.addClass("mask-container"),$element.on("click touchstart",".view",function(e){e.preventDefault(),self.preview()}).on("click touchend",".close",function(e){e.preventDefault(),self.destroy()})}).init(),dynamicComponentInstance}}),define("taoQtiTest/runner/plugins/tools/areaMasking/areaMasking",["jquery","lodash","i18n","ui/hider","util/shortcut","util/namespace","taoTests/runner/plugin","taoQtiTest/runner/plugins/tools/areaMasking/mask"],function($,_,__,hider,shortcut,namespaceHelper,pluginFactory,maskComponent){'use strict';var actionPrefix="tool-area-masking-",defaultConfig={max:5,foo:!0};return pluginFactory({name:"area-masking",init:function(){function addMask(){maskComponent().on("render",function(){self.masks.push(this),self.button.turnOn(),self.trigger("maskadd")}).on("destroy",function(){self.masks=_.without(self.masks,this),self.masks.length<config.max&&self.enable(),0===self.masks.length&&(self.button.turnOff(),self.trigger("close")),self.trigger("maskclose")}).init({renderTo:$container,draggableContainer:$container})}function isEnabled(){var context=testRunner.getTestContext(),options=context.options||{};return!!options.areaMasking}var self=this,testRunner=this.getTestRunner(),$container=testRunner.getAreaBroker().getContentArea().parent(),testConfig=testRunner.getTestData().config||{},config=_.defaults(_.clone((testConfig.plugins||{})["area-masking"])||{},defaultConfig),pluginShortcuts=(testConfig.shortcuts||{})["area-masking"]||{};this.masks=[],this.button=this.getAreaBroker().getToolbox().createEntry({control:"area-masking",text:__("Masking"),title:__("Covers parts of the item"),icon:"eye-slash"}),this.button.on("click",function(e){e.preventDefault(),testRunner.trigger(actionPrefix+"toggle")}),testConfig.allowShortcuts&&_.forEach(pluginShortcuts,function(command,key){shortcut.add(namespaceHelper.namespaceAll(command,"area-masking",!0),function(){testRunner.trigger(actionPrefix+key)},{avoidInput:!0})}),this.disable(),testRunner.on("loaditem",function(){isEnabled()?self.show():self.hide()}).on("enabletools renderitem",function(){self.enable()}).on("disabletools unloaditem",function(){self.disable(),_.invoke(self.masks,"destroy")}).on(actionPrefix+"toggle",function(){isEnabled()&&(0===self.masks.length&&self.trigger("open"),self.masks.length<config.max?addMask():1===config.max&&_.invoke(self.masks,"destroy"))})},destroy:function(){shortcut.remove(".area-masking")},enable:function(){this.button.enable()},disable:function(){this.button.disable()},show:function(){this.button.show()},hide:function(){this.button.hide()}})}),function(global,factory){"object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&"undefined"!=typeof module?module.exports=factory():"function"==typeof define&&define.amd?define("core/collections",factory):(global=global||self,global["core/collections"]=factory())}(this,function(){'use strict';var collections={Map:window.Map,Set:window.Set,WeakMap:window.WeakMap,WeakSet:window.WeakSet};return collections}),function(global,factory){"object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&"undefined"!=typeof module?module.exports=factory(require("lodash"),require("lib/decimal/decimal"),require("lib/expr-eval/expr-eval")):"function"==typeof define&&define.amd?define("util/mathsEvaluator",["lodash","lib/decimal/decimal","lib/expr-eval/expr-eval"],factory):(global=global||self,global["util/mathsEvaluator"]=factory(global._,global["lib/decimal/decimal"],global["lib/expr-eval/expr-eval"]))}(this,function(_,Decimal,exprEval){'use strict';function toPrecisionNumber(number,precision){var dot=number.indexOf(".");return 0<dot&&(number=number.substr(0,dot+precision+1)),number}function mathsEvaluatorFactory(config){function checkZero(number){return number.absoluteValue().lessThan(EPSILON)?new ConfiguredDecimal(0):number}function native(number){return Decimal.isDecimal(number)?number.toNumber():"true"===number||!0===number||"false"!==number&&!1!==number&&number}function useOrigin(){var args=[].slice.call(arguments),origin=args.pop();return origin.apply(this,args.map(native))}function decimalNumber(number){return Decimal.isDecimal(number)||(number=new ConfiguredDecimal(number)),number}function degreeToRadian(value){return decimalNumber(value).mul(PI).div(180)}function radianToDegree(value){return decimalNumber(value).mul(180).div(PI)}function unaryOperator(operator,operand){if(operand=decimalNumber(operand),!_.isFunction(operand[operator]))throw new TypeError(operator+" is not a valid operator!");return operand[operator]()}function binaryOperator(operator,left,right){if(left=decimalNumber(left),!_.isFunction(left[operator]))throw new TypeError(operator+" is not a valid operator!");return left[operator](decimalNumber(right))}function functionOperator(operator){var operands=[].slice.call(arguments,1);if(!_.isFunction(ConfiguredDecimal[operator]))throw new TypeError(operator+" is not a valid function!");return ConfiguredDecimal[operator].apply(ConfiguredDecimal,operands.map(decimalNumber))}function trigoOperator(operator,operand){if(!_.isFunction(Decimal[operator]))throw new TypeError(operator+" is not a valid operator!");return operand=localConfig.degree?degreeToRadian(operand):decimalNumber(operand),"tan"===operator&&operand.equals(PI.div(2))?new ConfiguredDecimal(NaN):checkZero(ConfiguredDecimal[operator](operand))}function inverseTrigoOperator(operator,operand){var result=checkZero(unaryOperator(operator,operand));return localConfig.degree?radianToDegree(result):result}function mapping(wrapper,origin,api){var fn;fn=api.value?api.value:api.action?_.partialRight(api.action,origin[api.entry]):_.partial(wrapper,api.mapTo),origin[api.entry]=fn}function evaluate(expression,variables){var parsedExpression,result,value;return _.isPlainObject(expression)&&(variables=variables||expression.variables,expression=expression.expression),parsedExpression=parser.parse(expression),result=parsedExpression.evaluate(variables),value=native(result),{expression:expression,variables:variables,result:result,value:value}}var localConfig=_.defaults({},config,defaultConfig),decimalConfig=_.pick(localConfig,decimalConfigEntries),parserConfig=_.pick(localConfig,parserConfigEntries),parser=new Parser(parserConfig),ConfiguredDecimal=Decimal.set(_.isEmpty(decimalConfig)?defaultDecimalConfig:decimalConfig),EPSILON=new ConfiguredDecimal(2).pow(-52),PI=new ConfiguredDecimal(toPrecisionNumber("3.1415926535897932384626433832795028841971693993751058209749445923078164062862089986280348253421170679821480865132823066470938446095505822317253594081284811174502841027019385211055596446229489549303819644288109756659334461284756482337867831652712019091456485669234603486104543266482133936072602491412737245870066063155881748815209209628292540917153643678925903600113305305488204665213841469519415116094330572703657595919530921861173819326117931051185480744623799627495673518857527248912279381830119491298336733624406566430860213949463952247371907021798609437027705392171762931767523846748184676694051320005681271452635608277857713427577896091736371787214684409012249534301465495853710507922796892589235420199561121290219608640344181598136297747713099605187072113499999983729780499510597317328160963185950244594553469083026425223082533446850352619311881710100031378387528865875332083814206171776691473035982534904287554687311595628638823537875937519577818577805321712268066130019278766111959092164201989",localConfig.internalPrecision)),E=new ConfiguredDecimal(toPrecisionNumber("2.7182818284590452353602874713526624977572470936999595749669676277240766303535475945713821785251664274274663919320030599218174135966290435729003342952605956307381323286279434907632338298807531952510190115738341879307021540891499348841675092447614606680822648001684774118537423454424371075390777449920695517027618386062613313845830007520449338265602976067371132007093287091274437470472306969772093101416928368190255151086574637721112523897844250569536967707854499699679468644549059879316368892300987931277361782154249992295763514822082698951936680331825288693984964651058209392398294887933203625094431173012381970684161403970198376793206832823764648042953118023287825098194558153017567173613320698112509961818815930416903515988885193458072738667385894228792284998920868058257492796104841984443634632449684875602336248270419786232090021609902353043699418491463140934317381436405462531520961836908887070167683964243781405927145635490613031072085103837505101157477041718986106873969655212671546889570350354",localConfig.internalPrecision)),mapAPI={unary:[{entry:"sin",action:function action(a){return trigoOperator("sin",a)}},{entry:"cos",action:function action(a){return trigoOperator("cos",a)}},{entry:"tan",action:function action(a){return trigoOperator("tan",a)}},{entry:"asin",action:function action(a){return inverseTrigoOperator("asin",a)}},{entry:"acos",action:function action(a){return inverseTrigoOperator("acos",a)}},{entry:"atan",action:function action(a){return inverseTrigoOperator("atan",a)}},{entry:"sinh",mapTo:"sinh"},{entry:"cosh",mapTo:"cosh"},{entry:"tanh",mapTo:"tanh"},{entry:"asinh",mapTo:"asinh"},{entry:"acosh",mapTo:"acosh"},{entry:"atanh",mapTo:"atanh"},{entry:"sqrt",mapTo:"sqrt"},{entry:"cbrt",mapTo:"cbrt"},{entry:"log",mapTo:"log"},{entry:"ln",mapTo:"ln"},{entry:"lg",mapTo:"log"},{entry:"log10",mapTo:"log"},{entry:"abs",mapTo:"abs"},{entry:"ceil",mapTo:"ceil"},{entry:"floor",mapTo:"floor"},{entry:"round",mapTo:"round"},{entry:"trunc",mapTo:"trunc"},{entry:"-",mapTo:"neg"},{entry:"+",action:decimalNumber},{entry:"exp",mapTo:"exp"},{entry:"not",action:function action(a){return!native(a)}},{entry:"!",action:useOrigin}],binary:[{entry:"+",mapTo:"add"},{entry:"-",mapTo:"sub"},{entry:"*",mapTo:"mul"},{entry:"/",mapTo:"div"},{entry:"%",mapTo:"mod"},{entry:"^",mapTo:"pow"},{entry:"==",mapTo:"equals"},{entry:"!=",action:function action(a,b){return!binaryOperator("equals",a,b)}},{entry:">",mapTo:"gt"},{entry:"<",mapTo:"lt"},{entry:">=",mapTo:"gte"},{entry:"<=",mapTo:"lte"},{entry:"and",action:function action(a,b){return!!(native(a)&&native(b))}},{entry:"or",action:function action(a,b){return!!(native(a)||native(b))}},{entry:"in",action:function action(array,obj){return obj=native(obj),"undefined"!=typeof _.find(array,function(el){return native(el)===obj})}}],ternaryOps:[{entry:"?",action:useOrigin}],functions:[{entry:"random",action:function action(dp){return ConfiguredDecimal.random(dp)}},{entry:"fac",action:useOrigin},{entry:"min",mapTo:"min"},{entry:"max",mapTo:"max"},{entry:"hypot",action:useOrigin},{entry:"pyt",action:useOrigin},{entry:"pow",mapTo:"pow"},{entry:"atan2",action:function action(y,x){var result=functionOperator("atan2",y,x);return localConfig.degree?radianToDegree(result):result}},{entry:"if",action:useOrigin},{entry:"gamma",action:useOrigin},{entry:"roundTo",action:useOrigin},{entry:"nthrt",action:function action(n,x){return x=decimalNumber(x),n=parseInt(n,10),x.isNeg()&&1!=n%2?decimalNumber(NaN):x.abs().pow(decimalNumber(1).div(n)).mul(Decimal.sign(x))}}],consts:[{entry:"PI",value:PI},{entry:"E",value:E},{entry:"EPSILON",value:EPSILON}]};return _.forEach(mapAPI.unary,_.partial(mapping,unaryOperator,parser.unaryOps)),_.forEach(mapAPI.binary,_.partial(mapping,binaryOperator,parser.binaryOps)),_.forEach(mapAPI.ternaryOps,_.partial(mapping,functionOperator,parser.ternaryOps)),_.forEach(mapAPI.functions,_.partial(mapping,functionOperator,parser.functions)),_.forEach(mapAPI.consts,_.partial(mapping,null,parser.consts)),evaluate}_=_&&_.hasOwnProperty("default")?_["default"]:_,Decimal=Decimal&&Decimal.hasOwnProperty("default")?Decimal["default"]:Decimal,exprEval=exprEval&&exprEval.hasOwnProperty("default")?exprEval["default"]:exprEval;var Parser=exprEval.Parser,defaultConfig={internalPrecision:100,degree:!1},defaultDecimalConfig={defaults:!0},decimalConfigEntries=["precision","rounding","toExpNeg","toExpPos","maxE","minE","modulo","crypto"],parserConfigEntries=["operators"];return mathsEvaluatorFactory}),function(global,factory){"object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&"undefined"!=typeof module?module.exports=factory(require("lodash"),require("core/promise")):"function"==typeof define&&define.amd?define("core/moduleLoader",["lodash","core/promise"],factory):(global=global||self,global["core/moduleLoader"]=factory(global._,global["core/promise"]))}(this,function(_,Promise){'use strict';function moduleLoaderFactory(requiredModules,validate,specs){var loaded={},modules={},excludes=[],bundles=[],loader={addList:function(moduleList){return _.forEach(moduleList,this.add,this),this},add:function(def){if(_.isEmpty(def.module)||!_.isString(def.module))throw new TypeError("An AMD module must be defined");if(_.isEmpty(def.category)||!_.isString(def.category))throw new TypeError("Providers must belong to a category");return modules[def.category]=modules[def.category]||[],_.isNumber(def.position)?modules[def.category][def.position]=def.module:"prepend"===def.position||"before"===def.position?modules[def.category].unshift(def.module):modules[def.category].push(def.module),def.bundle&&!_.contains(bundles,def.bundle)&&bundles.push(def.bundle),this},append:function(def){return this.add(_.merge({position:"append"},def))},prepend:function(def){return this.add(_.merge({position:"prepend"},def))},remove:function(module){return excludes.push(module),this},load:function(loadBundles){var self=this,dependencies=_(modules).values().flatten().uniq().difference(excludes).value(),loadModules=function(amdModules){return _.isArray(amdModules)&&amdModules.length?new Promise(function(resolve,reject){require(amdModules,function(){resolve([].slice.call(arguments))},reject)}):Promise.resolve()};return loadModules(loadBundles?bundles:[]).then(function(){return loadModules(dependencies)}).then(function(loadedModules){return _.forEach(dependencies,function(dependency,index){var module=loadedModules[index],category=_.findKey(modules,function(val){return _.contains(val,dependency)});if(!validate(module))throw new TypeError("Invalid module");_.isString(category)&&(loaded[category]=loaded[category]||[],loaded[category].push(module))}),self.getModules()})},getModules:function(category){return _.isString(category)?loaded[category]||[]:_(loaded).values().flatten().uniq().value()},getCategories:function(){return _.keys(loaded)}};return validate=_.isFunction(validate)?validate:_.isPlainObject,_.forEach(requiredModules,function(moduleList,category){if(_.isEmpty(category)||!_.isString(category))throw new TypeError("Modules must belong to a category");if(!_.isArray(moduleList))throw new TypeError("A list of modules must be an array");if(!_.all(moduleList,validate))throw new TypeError("The list does not contain valid modules");loaded[category]=loaded[category]?loaded[category].concat(moduleList):moduleList}),specs&&_(specs).functions().forEach(function(method){loader[method]=function(){return specs[method].apply(loader,[].slice.call(arguments))}}),loader}return _=_&&_.hasOwnProperty("default")?_["default"]:_,Promise=Promise&&Promise.hasOwnProperty("default")?Promise["default"]:Promise,moduleLoaderFactory}),function(global,factory){"object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&"undefined"!=typeof module?module.exports=factory(require("lodash"),require("core/moduleLoader")):"function"==typeof define&&define.amd?define("core/pluginLoader",["lodash","core/moduleLoader"],factory):(global=global||self,global["core/pluginLoader"]=factory(global._,global["core/moduleLoader"]))}(this,function(_,moduleLoaderFactory){'use strict';function pluginLoaderFactory(requiredPlugins){return moduleLoaderFactory(requiredPlugins,_.isFunction,{getPlugins:function(category){return this.getModules(category)}})}return _=_&&_.hasOwnProperty("default")?_["default"]:_,moduleLoaderFactory=moduleLoaderFactory&&moduleLoaderFactory.hasOwnProperty("default")?moduleLoaderFactory["default"]:moduleLoaderFactory,pluginLoaderFactory}),define("taoQtiTest/runner/plugins/tools/calculator",["jquery","lodash","i18n","ui/hider","ui/calculator","ui/maths/calculator/basicCalculator","ui/maths/calculator/scientificCalculator","util/shortcut","util/namespace","taoTests/runner/plugin"],function($,_,__,hider,calculatorFactory,basicCalculatorFactory,scientificCalculatorFactory,shortcut,namespaceHelper,pluginFactory){'use strict';var defaultCalcConfig={height:380,width:280,top:50,left:10,stackingScope:"test-runner",proportionalResize:!0},bodmasCalcConfig=_.defaults({height:380,width:280},defaultCalcConfig),scientificCalcConfig=_.defaults({width:490,height:420,calculator:{maths:{degree:!0}}},defaultCalcConfig);return pluginFactory({name:"calculator",init:function(){function isEnabled(){var context=testRunner.getTestContext()||{},options=context.options||{};return!!options.calculator||!!options.calculatorBodmas||!!options.calculatorScientific}function togglePlugin(){isEnabled()?self.show():self.hide()}function buildCalculator(calcTpl){var context=testRunner.getTestContext()||{},options=context.options||{},factory,calcConfig;options.calculatorScientific?(factory=scientificCalculatorFactory,calcConfig=scientificCalcConfig,calcConfig.calculator.maths.degree=_.isUndefined(config.degree)?scientificCalcConfig.calculator.maths.degree:config.degree):options.calculatorBodmas?(factory=basicCalculatorFactory,calcConfig=bodmasCalcConfig):(factory=calculatorFactory,calcConfig=defaultCalcConfig),self.calculator=factory(_.defaults({renderTo:self.$calculatorContainer,replace:!0,draggableContainer:areaBroker.getContainer(),alternativeTemplate:calcTpl||null},calcConfig)).on("show",function(){self.trigger("open"),self.button.turnOn()}).on("hide",function(){self.trigger("close"),self.button.turnOff()}).after("render",function(){this.show()})}function toggleCalculator(){!1!==self.getState("enabled")&&(self.calculator?self.calculator.is("hidden")?self.calculator.show():self.calculator.hide():config.template?require(["tpl!"+config.template.replace(/\.tpl$/,"")],function(calcTpl){buildCalculator(calcTpl)},function(){buildCalculator()}):buildCalculator())}var self=this,testRunner=this.getTestRunner(),areaBroker=this.getAreaBroker(),testData=testRunner.getTestData()||{},testConfig=testData.config||{},pluginsConfig=testConfig.plugins||{},config=pluginsConfig.calculator||{},pluginShortcuts=(testConfig.shortcuts||{})[this.getName()]||{};this.button=this.getAreaBroker().getToolbox().createEntry({control:"calculator",title:__("Open Calculator"),icon:"table",text:__("Calculator")}),this.$calculatorContainer=$("<div class=\"widget-calculator\">"),this.calculator=null,this.button.on("click",function(e){$(e.target).closest(".widget-calculator").length||(e.preventDefault(),testRunner.trigger("tool-calculator"))}),testConfig.allowShortcuts&&pluginShortcuts.toggle&&shortcut.add(namespaceHelper.namespaceAll(pluginShortcuts.toggle,this.getName(),!0),function(){testRunner.trigger("tool-calculator")},{avoidInput:!0,allowIn:".widget-calculator"}),togglePlugin(),this.disable(),testRunner.on("loaditem",togglePlugin).on("enabletools renderitem",function(){self.enable()}).on("disabletools unloaditem",function(){self.disable(),self.calculator&&(self.calculator.destroy(),self.calculator=null)}).on("tool-calculator",function(){isEnabled()&&toggleCalculator()})},render:function(){var areaBroker=this.getAreaBroker();areaBroker.getContainer().append(this.$calculatorContainer)},destroy:function(){shortcut.remove("."+this.getName()),this.$calculatorContainer.remove(),this.calculator&&this.calculator.destroy()},enable:function(){this.button.enable()},disable:function(){this.button.disable(),this.calculator&&this.calculator.hide()},show:function(){this.button.show()},hide:function(){this.button.hide(),this.calculator&&this.calculator.hide()}})}),define("tpl!taoQtiTest/runner/plugins/tools/comment/comment",["handlebars"],function(hb){return hb.template(function(Handlebars,depth0,helpers,partials,data){this.compilerInfo=[4,">= 1.0.0"],helpers=this.merge(helpers,Handlebars.helpers),data=data||{};var buffer="",helperMissing=helpers.helperMissing,escapeExpression=this.escapeExpression,helper,options;return buffer+="<div data-control=\"qti-comment\" class=\"hidden\">\n    <textarea data-control=\"qti-comment-text\" placeholder=\""+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Your comment\u2026",options):helperMissing.call(depth0,"__","Your comment\u2026",options)))+"\"></textarea>\n    <button data-control=\"qti-comment-cancel\" class=\"btn-info small\"></span>"+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Cancel",options):helperMissing.call(depth0,"__","Cancel",options)))+"</button>\n    <button data-control=\"qti-comment-send\" class=\"btn-info small\">"+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Send",options):helperMissing.call(depth0,"__","Send",options)))+"</button>\n</div>",buffer})}),define("taoQtiTest/runner/plugins/tools/comment/comment",["jquery","i18n","taoTests/runner/plugin","ui/hider","ui/stacker","util/shortcut","util/namespace","tpl!taoQtiTest/runner/plugins/tools/comment/comment"],function($,__,pluginFactory,hider,stackerFactory,shortcut,namespaceHelper,commentTpl){'use strict';return pluginFactory({name:"comment",init:function(){function isEnabled(){var context=testRunner.getTestContext();return!!context.options.allowComment}function togglePlugin(){isEnabled()?self.show():self.hide()}function toggleComment(){!1!==self.getState("enabled")&&(hider.toggle(self.$form),hider.isHidden(self.$form)?self.button.turnOff():(self.$input.val("").focus(),self.button.turnOn(),stacker.bringToFront(self.$form)))}var self=this,testRunner=this.getTestRunner(),testData=testRunner.getTestData()||{},testConfig=testData.config||{},pluginShortcuts=(testConfig.shortcuts||{})[this.getName()]||{},stacker=stackerFactory("test-runner");this.button=this.getAreaBroker().getToolbox().createEntry({control:"comment",title:__("Leave a comment"),icon:"tag",text:__("Comment")}),this.button.on("render",function(){self.$button=self.button.getElement(),self.$form=$(commentTpl()).appendTo(self.$button),self.$input=self.$button.find("[data-control=\"qti-comment-text\"]"),self.$cancel=self.$button.find("[data-control=\"qti-comment-cancel\"]"),self.$submit=self.$button.find("[data-control=\"qti-comment-send\"]"),stacker.autoBringToFront(self.$form),self.$cancel.on("click",function(){hider.hide(self.$form),self.button.turnOff()}),self.$submit.on("click",function(){var comment=self.$input.val();comment&&(self.disable(),self.button.turnOff(),testRunner.getProxy().callTestAction("comment",{comment:comment}).then(function(){hider.hide(self.$form),self.enable()}).catch(function(){hider.hide(self.$form),self.enable()}))})}),this.button.on("click",function(e){$(e.target).closest("[data-control=\"qti-comment\"]").length||(e.preventDefault(),testRunner.trigger("tool-comment"))}),testConfig.allowShortcuts&&pluginShortcuts.toggle&&shortcut.add(namespaceHelper.namespaceAll(pluginShortcuts.toggle,this.getName(),!0),function(){testRunner.trigger("tool-comment")},{avoidInput:!0}),togglePlugin(),this.disable(),testRunner.on("loaditem",togglePlugin).on("renderitem enabletools",function(){self.enable()}).on("unloaditem disabletools",function(){self.disable()}).on("tool-comment",function(){isEnabled()&&toggleComment()})},destroy:function(){shortcut.remove("."+this.getName())},enable:function(){this.button.enable()},disable:function(){this.$form&&hider.hide(this.$form),this.button.disable(),this.button.turnOff()},show:function(){this.button.show()},hide:function(){this.$form&&hider.hide(this.$form),this.button.hide()}})}),function(global,factory){"object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&"undefined"!=typeof module?module.exports=factory(require("lodash")):"function"==typeof define&&define.amd?define("core/providerRegistry",["lodash"],factory):(global=global||self,global["core/providerRegistry"]=factory(global._))}(this,function(_){'use strict';return _=_&&_.hasOwnProperty("default")?_["default"]:_,function(target,validator){function registerProvider(name,provider){var valid=!0;if(!_.isString(name)||0>=name.length)throw new TypeError("It is required to give a name to your provider.");if(!_.isPlainObject(provider)||!_.isFunction(provider.init))throw new TypeError("A provider is an object that contains at least an init function.");return valid=validator&&_.isFunction(validator)?validator(provider):valid,valid&&(_providers[name]=provider),this}function getProvider(providerName){var provider;if(!_providers||0===_.size(_providers))throw new Error("No provider registered");if(_.isString(providerName)&&0<providerName.length?provider=_providers[providerName]:1===_.size(_providers)&&(providerName=_.keys(_providers)[0],provider=_providers[providerName]),!provider)throw new Error("No candidate found for the provider");return provider}function getAvailableProviders(){return _.keys(_providers)}var _providers={};return target=target||{},target.registerProvider=registerProvider,target.getProvider=getProvider,target.getAvailableProviders=getAvailableProviders,target.clearProviders=function(){return _providers={},this},target}}),function(global,factory){"object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&"undefined"!=typeof module?module.exports=factory(require("core/promise")):"function"==typeof define&&define.amd?define("core/requireIfExists",["core/promise"],factory):(global=global||self,global["core/requireIfExists"]=factory(global["core/promise"]))}(this,function(Promise){'use strict';function requireIfExists(uri){return new Promise(function(resolve){require([uri],resolve,function(err){var failedId=err.requireModules&&err.requireModules[0];if(failedId===uri)requirejs.undef(failedId),define(failedId,function(){return null}),require([failedId],resolve);else throw err})})}return Promise=Promise&&Promise.hasOwnProperty("default")?Promise["default"]:Promise,requireIfExists}),define("tpl!taoQtiTest/runner/plugins/tools/documentViewer/panel",["handlebars"],function(hb){return hb.template(function(Handlebars,depth0,helpers,partials,data){this.compilerInfo=[4,">= 1.0.0"],helpers=this.merge(helpers,Handlebars.helpers),data=data||{};var buffer="",escapeExpression=this.escapeExpression,stack1,helper;return buffer+="<div class=\"document-viewer-plugin hidden\">\n    <div class=\"viewer-overlay\"></div>\n    <div class=\"viewer-panel\">\n        <div class=\"viewer-header\">\n            <span class=\"viewer-title\">",(helper=helpers.title)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.title,stack1="function"===_typeof(helper)?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+"</span>\n            <span class=\"icon icon-close\"></span>\n        </div>\n        <div class=\"viewer-content\">",(helper=helpers.content)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.content,stack1="function"===_typeof(helper)?helper.call(depth0,{hash:{},data:data}):helper),(stack1||0===stack1)&&(buffer+=stack1),buffer+="</div>\n        <div class=\"viewer-footer\"></div>\n    </div>\n</div>",buffer})}),define("taoQtiTest/runner/plugins/tools/documentViewer/documentViewer",["jquery","lodash","ui/hider","ui/documentViewer","ui/documentViewer/providers/pdfViewer","taoTests/runner/plugin","tpl!taoQtiTest/runner/plugins/tools/documentViewer/panel"],function($,_,hider,viewerFactory,pdfViewer,pluginFactory,panelTpl){'use strict';function showPanel(plugin){hider.show(plugin.controls.$panel),plugin.trigger("panelshow"),$(window).on("resize."+plugin.getName(),_.debounce(_.partial(resizeViewer,plugin),50))}function hidePanel(plugin){hider.hide(plugin.controls.$panel),plugin.trigger("panelhide"),$(window).off("resize."+plugin.getName())}function hideIfVisible(plugin){var isVisible=!hider.isHidden(plugin.controls.$panel,!0);return isVisible&&hidePanel(plugin),isVisible}function initPanelEvents(plugin){function stopPropagation(e){e.stopImmediatePropagation(),e.stopPropagation()}var namespace="."+plugin.getName(),stopEvents=["click","mousedown","mouseup","touchstart","touchend","keyup","keydow","keypress","scroll","drop"].join(namespace+" ")+namespace,hideViewer=_.partial(hidePanel,plugin);plugin.controls.$overlay.off(namespace).on("click"+namespace,hideViewer).on(stopEvents,stopPropagation),plugin.controls.$panel.off(namespace).on("click"+namespace,".icon-close",hideViewer).on(stopEvents,stopPropagation)}function resizeViewer(plugin){var $content=plugin.controls.$content;plugin.viewer.setSize($content.width(),$content.height())}return viewerFactory.registerProvider("pdf",pdfViewer),pluginFactory({name:"documentViewer",init:function(){function displayViewer(data){!1!==self.getState("enabled")&&(showPanel(self),self.controls.$title.text(data.label),resizeViewer(self),self.viewer.load(data.document,"pdf"))}var self=this,testRunner=this.getTestRunner(),$panel=$(panelTpl());this.controls={$panel:$panel,$overlay:$panel.find(".viewer-overlay"),$title:$panel.find(".viewer-title"),$content:$panel.find(".viewer-content")},this.viewer=viewerFactory({renderTo:this.controls.$content,replace:!0,fitToWidth:!0,allowSearch:!0}),testRunner.on("renderitem enabletools",function(){self.enable()}).on("renderitem",function(){self.getAreaBroker().getContentArea().append(self.controls.$panel).off("."+self.getName()).on("viewDocument."+self.getName(),function(event){var data=event.originalEvent.detail;displayViewer(data)}),initPanelEvents(self)}).on("move",function(){hideIfVisible(self)}).on("skip",function(){hideIfVisible(self)}).on("unloaditem disabletools",function(){self.disable()}).on("tool-documentViewer",function(data){displayViewer(data)})},render:function(){},destroy:function(){this.getAreaBroker().getContentArea().off("."+this.getName()),this.viewer&&this.viewer.destroy(),this.controls.$panel&&this.controls.$panel.remove(),this.viewer=null,this.controls={}},enable:function(){},disable:function(){hideIfVisible(this)},show:function(){},hide:function(){hideIfVisible(this)}})}),define("taoQtiTest/runner/plugins/tools/highlighter/highlighter",["lodash","jquery","core/eventifier","ui/highlighter"],function(_,$,eventifier,highlighterFactory){'use strict';function getAllRanges(){var allRanges=[],i;for(i=0;i<selection.rangeCount;i++)allRanges.push(selection.getRangeAt(i));return allRanges}function discardSelection(){setTimeout(function(){selection.removeAllRanges()},250)}var prevSelection=[],selection;if(!window.getSelection)throw new Error("Browser does not support getSelection()");return selection=window.getSelection(),function(options){var enabled=!0,isHighlighting=!1,highlightHelper=highlighterFactory({className:options.className||"txt-user-highlight",containerSelector:options.containerSelector||".qti-itemBody",containersBlackList:options.containersBlackList||[],clearOnClick:!0});return $(document).on("mouseup.highlighter",function(){isHighlighting&&!selection.isCollapsed&&(highlightHelper.highlightRanges(getAllRanges()),discardSelection())}),$(document).on("touchend.highlighter",function(){isHighlighting&&!selection.isCollapsed&&highlightHelper.highlightRanges(getAllRanges())}),/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream&&$(document).on("selectionchange",function(){isHighlighting||(prevSelection=_.clone(getAllRanges(),!0))}),eventifier({enable:function(){enabled=!0},disable:function(){enabled=!1},isEnabled:function(){return enabled},toggleHighlighting:function(bool){return isHighlighting=bool,isHighlighting?(this.trigger("start"),$(".qti-itemBody").toggleClass("highlighter-cursor",!0)):(this.trigger("end"),$(".qti-itemBody").toggleClass("highlighter-cursor",!1)),this},highlight:function(){isHighlighting?this.toggleHighlighting(!1):selection.isCollapsed?prevSelection[0]&&!prevSelection[0].collapsed?(this.toggleHighlighting(!0),highlightHelper.highlightRanges(prevSelection),this.toggleHighlighting(!1),discardSelection()):this.toggleHighlighting(!0):(this.toggleHighlighting(!0),highlightHelper.highlightRanges(getAllRanges()),this.toggleHighlighting(!1),discardSelection())},restoreIndex:function(index){index&&0<index.length&&highlightHelper.highlightFromIndex(index)},getIndex:function(){return highlightHelper.getHighlightIndex()},clearHighlights:function(){highlightHelper.clearHighlights(),selection.removeAllRanges()},getId:function(){return options.id}})}}),define("taoQtiTest/runner/plugins/tools/highlighter/collection",["lodash","taoQtiTest/runner/plugins/tools/highlighter/highlighter"],function(_,highlighterFactory){'use strict';var highlighters=[];return function(){return{addHighlighter:function(options){var hl=highlighterFactory(options);return highlighters.push(hl),hl},getHighlighterById:function(id){return highlighters.find(function(hl){return hl.getId()===id})},getAllHighlighters:function(){return highlighters},getItemHighlighter:function(){return highlighters[0]},getNonItemHighlighters:function(){return highlighters.slice(1)},getLength:function(){return highlighters.length},empty:function(){return highlighters=[],this}}}}),define("taoQtiTest/runner/plugins/tools/highlighter/plugin",["jquery","lodash","i18n","core/logger","core/promise","taoTests/runner/plugin","util/shortcut","util/namespace","taoQtiTest/runner/helpers/currentItem","taoQtiTest/runner/plugins/tools/highlighter/collection"],function($,_,__,loggerFactory,Promise,pluginFactory,shortcut,namespaceHelper,itemHelper,highlighterCollection){'use strict';return pluginFactory({name:"highlighter",install:function(){var testRunner=this.getTestRunner();testRunner.getTestStore().setVolatile(this.getName())},init:function(){function isPluginEnabled(){var context=testRunner.getTestContext()||{},options=context.options||{};return!!options.highlighter}function togglePlugin(){isPluginEnabled()?self.show():self.hide()}var self=this,testRunner=this.getTestRunner(),testData=testRunner.getTestData()||{},testConfig=testData.config||{},pluginShortcuts=(testConfig.shortcuts||{})[this.getName()]||{},hasHighlights=!1,logger=loggerFactory("highlighterPlugin"),highlighters=highlighterCollection();return highlighters.addHighlighter({className:"txt-user-highlight",containerSelector:".qti-itemBody",containersBlackList:[".qti-include"],id:"item-highlighter"}),this.buttonMain=this.getAreaBroker().getToolbox().createEntry({title:__("Highlight Text"),icon:"text-marker",control:"highlight-trigger",text:__("Highlight")}),this.buttonRemove=this.getAreaBroker().getToolbox().createEntry({title:__("Clear all active highlights"),icon:"result-nok",control:"highlight-clear",text:__("Clear Highlights")}),this.buttonMain.on("mousedown",function(e){e.preventDefault(),isPluginEnabled()&&_.forEach(highlighters.getAllHighlighters(),function(instance){instance.isEnabled()&&instance.highlight()})}),this.buttonRemove.on("click",function(e){e.preventDefault(),isPluginEnabled()&&(_.forEach(highlighters.getAllHighlighters(),function(instance){instance.isEnabled()&&instance.clearHighlights()}),testRunner.trigger("clear"))}),testConfig.allowShortcuts&&pluginShortcuts.toggle&&shortcut.add(namespaceHelper.namespaceAll(pluginShortcuts.toggle,this.getName(),!0),function(){isPluginEnabled()&&_.forEach(highlighters.getAllHighlighters(),function(instance){instance.isEnabled()&&instance.highlight()})},{avoidInput:!0,prevent:!0}),this.disable(),function(){return testRunner.getTestStore().getStore(self.getName())}().then(function(highlighterStore){function saveHighlight(itemId,key){var instance,highlightsIndex;return(itemId?(key=itemId,instance=highlighters.getItemHighlighter()):instance=highlighters.getHighlighterById(key),!instance)?Promise.resolve(!1):(highlightsIndex=instance.getIndex(),!!(isPluginEnabled()&&hasHighlights&&key)&&(logger.debug("Saving "+highlightsIndex.length+" highlights for id "+key),highlighterStore.setItem(key,highlightsIndex)))}function saveAll(){var nonItemHighlighters=highlighters.getNonItemHighlighters();return Promise.all(_(nonItemHighlighters).filter(function(instance){return instance.isEnabled()}).map(function(instance){var key=instance.getId();return saveHighlight(null,key)}).value()).then(function(results){var itemId=testRunner.getTestContext().itemIdentifier;return saveHighlight(itemId)&&_.every(results)})}function loadHighlight(itemId,key){var instance;return itemId?(key=itemId,instance=highlighters.getItemHighlighter()):instance=highlighters.getHighlighterById(key),instance?highlighterStore.getItem(key).then(function(index){index&&(logger.debug("Loading "+index.length+" highlights for key "+key),hasHighlights=!0,instance.restoreIndex(index))}).then(function(){instance.on("end.save",function(){return saveHighlight(itemId,key)})}):Promise.resolve(!1)}testRunner.on("loaditem",togglePlugin).on("enabletools renderitem",function(){self.enable()}).on("renderitem",function(){var itemId=testRunner.getTestContext().itemIdentifier,textStimuli;itemId&&isPluginEnabled()&&(hasHighlights=!1,highlighters.getItemHighlighter().enable(),loadHighlight(itemId),textStimuli=itemHelper.getTextStimuliHrefs(testRunner),_.forEach(textStimuli,function(textStimulusHref){var stimHighlighter=highlighters.getHighlighterById(textStimulusHref);stimHighlighter||(stimHighlighter=highlighters.addHighlighter({className:"txt-user-highlight",containerSelector:".qti-include[data-href=\""+textStimulusHref+"\"]",id:textStimulusHref})),stimHighlighter.enable(),loadHighlight(null,textStimulusHref)}))}).after("renderitem",function(){_.forEach(highlighters.getAllHighlighters(),function(instance){instance.isEnabled()&&instance.on("start",function(){self.buttonMain.turnOn(),self.trigger("start"),hasHighlights=!0}).on("end",function(){self.buttonMain.turnOff(),self.trigger("end")})})}).after("clear.highlighter",function(){saveAll()}).before("skip move timeout",function(){return saveAll()}).on("disabletools unloaditem",function(){self.disable(),isPluginEnabled()&&_.forEach(highlighters.getAllHighlighters(),function(instance){instance.isEnabled()&&instance.off("end.save").toggleHighlighting(!1).disable()})})})},destroy:function(){shortcut.remove("."+this.getName()),$(document).off(".highlighter")},enable:function(){this.buttonMain.enable(),this.buttonRemove.enable()},disable:function(){this.buttonMain.disable(),this.buttonRemove.disable()},show:function(){this.buttonMain.show(),this.buttonRemove.show()},hide:function(){this.buttonMain.hide(),this.buttonRemove.hide()}})}),define("taoQtiTest/runner/plugins/tools/itemThemeSwitcher/itemThemeSwitcher",["jquery","lodash","i18n","taoTests/runner/plugin","ui/hider","ui/themes","util/shortcut","util/namespace","ui/themeLoader"],function($,_,__,pluginFactory,hider,themeHandler,shortcut,namespaceHelper,themeLoader){'use strict';return pluginFactory({name:"itemThemeSwitcher",install:function(){this.getTestRunner().getTestStore().setVolatile(this.getName())},init:function(){function isPluginAllowed(){return themesConfig&&1<_.size(themesConfig.available)}function changeTheme(themeId){var $qtiItem=$(".qti-item"),previousTheme=state.selectedTheme;state.selectedTheme=themeId,$qtiItem&&_.defer(function(){$qtiItem.trigger("themechange",[state.selectedTheme])}),self.storage&&self.storage.setItem("itemThemeId",themeId),previousTheme!==state.selectedTheme&&testRunner.trigger("themechange",state.selectedTheme,previousTheme),allMenuEntries.forEach(function(menuEntry){menuEntry.getId()===themeId?menuEntry.turnOn():menuEntry.turnOff()})}var self=this,pluginName=this.getName(),testRunner=this.getTestRunner(),testData=testRunner.getTestData()||{},testConfig=testData.config||{},pluginShortcuts=(testConfig.shortcuts||{})[this.getName()]||{},pluginConfig=self.getConfig(),oldNamespace=themeHandler.getActiveNamespace(),themesConfig={},state={availableThemes:[],defaultTheme:"",selectedTheme:""},allMenuEntries=[];return pluginConfig.activeNamespace&&themeHandler.setActiveNamespace(pluginConfig.activeNamespace),themesConfig=themeHandler.get("items")||{},pluginConfig.activeNamespace===oldNamespace||_.isEmpty(themesConfig)||function(){var themeConfig=themeHandler.get("items");themeLoader(themeConfig).load(),state.selectedTheme?changeTheme(state.selectedTheme):changeTheme(themeConfig.default)}(),themesConfig&&(themesConfig.default&&(state.defaultTheme=themesConfig.default,state.selectedTheme=themesConfig.default),themesConfig.available&&_.forEach(themesConfig.available,function(theme){state.availableThemes.push({id:theme.id,label:theme.name})})),this.menuButton=this.getAreaBroker().getToolbox().createMenu({control:"color-contrast",title:__("Change the current color preset"),icon:"contrast",text:__("Contrast")}).on("click",function(e){e.preventDefault(),testRunner.trigger("tool-themeswitcher-toggle")}).on("openmenu",function(){testRunner.trigger("plugin-open."+pluginName,state.selectedTheme)}).on("closemenu",function(){testRunner.trigger("plugin-close."+pluginName,state.selectedTheme)}),state.availableThemes.forEach(function(theme){var themeEntry=self.getAreaBroker().getToolbox().createEntry({control:theme.id,title:theme.label,icon:"preview",text:__(theme.label)});themeEntry.setMenuId("color-contrast"),themeEntry.on("click",function(e){var themeId=this.config.control;e.preventDefault(),self.menuButton.turnOffAll(),this.turnOn(),changeTheme(themeId)}),state.defaultTheme===theme.id&&themeEntry.on("render",function(){this.turnOn()}),allMenuEntries.push(themeEntry)}),testConfig.allowShortcuts&&pluginShortcuts.toggle&&shortcut.add(namespaceHelper.namespaceAll(pluginShortcuts.toggle,this.getName(),!0),function(){testRunner.trigger("tool-themeswitcher-toggle")},{avoidInput:!0}),isPluginAllowed()||this.hide(),this.disable(),testRunner.on("loaditem",function(){isPluginAllowed()?self.show():self.hide()}).on("renderitem",function(){self.enable(),changeTheme(state.selectedTheme)}).on("enabletools",function(){self.enable()}).on("disabletools unloaditem",function(){self.disable()}).on("tool-themeswitcher-toggle",function(){!1!==self.getState("enabled")&&self.menuButton.toggleMenu()}),testRunner.getPluginStore(this.getName()).then(function(itemThemesStore){self.storage=itemThemesStore,self.storage.getItem("itemThemeId").then(function(itemThemeId){itemThemeId&&state.selectedTheme!==itemThemeId&&changeTheme(itemThemeId)})})},destroy:function(){shortcut.remove("."+this.getName())},enable:function(){this.menuButton.enable()},disable:function(){this.menuButton.disable()},show:function(){this.menuButton.show()},hide:function(){this.menuButton.hide()}})}),define("taoQtiTest/runner/plugins/tools/lineReader/compoundMask",["jquery","lodash","core/statifier","core/eventifier","ui/component","ui/component/placeable","ui/component/draggable","ui/component/resizable","ui/component/stackable"],function($,_,statifier,eventifier,componentFactory,makePlaceable,makeDraggable,makeResizable,makeStackable){'use strict';var defaultDimensions={outerWidth:600,outerHeight:400,innerWidth:500,innerHeight:20},defaultPosition={outerX:0,outerY:0,innerX:50,innerY:50},defaultOptions={dragMinWidth:10,dragMinHeight:10,resizeHandleSize:10,innerDragHeight:20},stackingOptions={stackingScope:"test-runner"},constrains;return function(options,dimensions,position){function createMask(maskConfig){var maskAPI={place:maskConfig.place,placeOverlay:maskConfig.placeOverlay,styleResizableEdges:function(){var $element=this.getElement();_.forOwn(this.config.edges,function(isResizable,edgeId){isResizable&&$element.addClass("border-"+edgeId)})}},mask;return mask=componentFactory(maskAPI,maskConfig),makeResizable(mask),makeStackable(mask,stackingOptions),mask.on("render",function(){var $element=this.getElement();this.styleResizableEdges(),$element.addClass("line-reader-mask "+maskConfig.id).on("mousedown touchstart",function(){bringAllToFront()})}).on("resizestart",function(){innerDrag.hide(),closer.hide(),invokeOnOverlays("hide"),invokeOnMasks("setState",["resizing",!0])}).on("beforeresize",maskConfig.beforeResize||_.noop).on("resize",maskConfig.onResize||_.noop).on("resizeend",function(){applyTransformsToOverlays(),applyTransformsToInnerDrag(),applyTransformsToCloser(),invokeOnMasks("setState",["resizing",!1]),invokeOnOverlays("show"),innerDrag.show(),closer.show()}).init()}function createOverlay(overlayConfig){var overlay;return overlay=componentFactory({transformOverlay:function(){var $element=this.getElement();this._sizeBackup=this.getSize(),this._posBackup=this.getPosition(),this.setSize(dimensions.outerWidth,dimensions.outerHeight).moveTo(position.outerX,position.outerY),$element.addClass("moving"),this.setState("transformed",!0)},restoreOverlay:function(){var $element=this.getElement();this.is("transformed")&&(this.setSize(this._sizeBackup.width,this._sizeBackup.height).moveTo(this._posBackup.x,this._posBackup.y),$element.removeClass("moving"),this._sizeBackup=null,this._posBackup=null,this.setState("transformed",!1))},appendVisualGuides:function(){var $element=this.getElement();$element.append(visualGuides.$maskBg),$element.append(visualGuides.$innerWindow),visualGuides.$maskBg.css({width:dimensions.outerWidth-2,height:dimensions.outerHeight-2,"border-top-width":dimensions.topHeight-2,"border-right-width":dimensions.rightWidth-2,"border-bottom-width":dimensions.bottomHeight-2,"border-left-width":dimensions.leftWidth-2}),visualGuides.$innerWindow.css({width:dimensions.innerWidth,height:dimensions.innerHeight,left:dimensions.leftWidth-2,top:dimensions.topHeight-2})},removeVisualGuides:function(){visualGuides.$maskBg.remove(),visualGuides.$innerWindow.remove()}},overlayConfig),makeDraggable(overlay),makeStackable(overlay,stackingOptions),overlay.on("render",function(){var self=this,$element=this.getElement(),pointerEventsPrefix=window.PointerEvent?"pointer":"mouse";$element.addClass("line-reader-overlay "+overlayConfig.id).on(pointerEventsPrefix+"down touchstart",function(){bringAllToFront(),self.transformOverlay()}).on(pointerEventsPrefix+"up touchend",function(){self.restoreOverlay()})}).on("dragstart",function(){innerDrag.hide(),closer.hide(),invokeOnMasks("hide"),this.appendVisualGuides()}).on("dragmove",function(xOffsetRelative,yOffsetRelative){position.outerX+=xOffsetRelative,position.outerY+=yOffsetRelative,position.innerX+=xOffsetRelative,position.innerY+=yOffsetRelative}).on("dragend",function(){this.removeVisualGuides(),invokeOnAll("show"),innerDrag.show(),closer.show(),applyTransforms()}).init()}function createInnerDragHandle(){innerDrag=componentFactory(),makeStackable(innerDrag,stackingOptions),makeDraggable(innerDrag,{dragRestriction:function(){var fixedXY=allParts.nw.mask.getElement().offset(),rect;return rect={x:fixedXY.left+constrains.minWidth,y:fixedXY.top+(constrains.minHeight+dimensions.innerHeight+options.resizeHandleSize),width:dimensions.outerWidth-2*constrains.minWidth,height:dimensions.outerHeight-(dimensions.innerHeight+constrains.minHeight+constrains.minBottomHeight-options.innerDragHeight)},rect}}).on("render",function(){var $element=this.getElement(),$dragIcon=$("<div>",{class:"icon icon-move"});$element.addClass("line-reader-inner-drag"),$element.append($dragIcon),$element.on("mousedown touchstart",function(e){e.stopPropagation(),bringAllToFront()})}).on("dragstart",function(){closer.hide(),invokeOnOverlays("hide"),invokeOnMasks("setState",["resizing",!0])}).on("dragmove",function(xOffsetRelative,yOffsetRelative){position.innerX+=xOffsetRelative,position.innerY+=yOffsetRelative,dimensions.leftWidth+=xOffsetRelative,dimensions.topHeight+=yOffsetRelative,dimensions.rightWidth-=xOffsetRelative,dimensions.bottomHeight-=yOffsetRelative,applyTransformsToMasks()}).on("dragend",function(){invokeOnOverlays("show"),innerDrag.bringToFront(),closer.show(),invokeOnMasks("setState",["resizing",!1]),applyTransformsToOverlays()}).init()}function createCloser(){closer=componentFactory(),makeStackable(closer,stackingOptions),makePlaceable(closer).on("render",function(){var self=this,$element=this.getElement(),$closeIcon=$("<div>",{class:"icon icon-result-nok"});$element.append($closeIcon),$element.addClass("line-reader-closer"),$element.on("mousedown touchstart",function(){bringAllToFront()}),$element.on("click",function(e){e.stopPropagation(),self.trigger("click")})}).init()}function bringAllToFront(){invokeOnAll("bringToFront"),innerDrag.bringToFront(),closer.bringToFront()}function invokeOnAll(fn,args){invokeOnMasks(fn,args),invokeOnOverlays(fn,args)}function invokeOnMasks(fn,args){invokeOn("mask",fn,args)}function invokeOnOverlays(fn,args){invokeOn("overlay",fn,args)}function invokeOn(target,fn,args){_.forOwn(allParts,function(part){_.isObject(part[target])&&_.isFunction(part[target][fn])&&part[target][fn].apply(part[target],args)})}function applyTransforms(){applyTransformsToMasks(),applyTransformsToOverlays(),applyTransformsToInnerDrag(),applyTransformsToCloser()}function applyTransformsToMasks(){invokeOnMasks("place")}function applyTransformsToOverlays(){_.forOwn(allParts,function(part){part.mask.placeOverlay(part.overlay)})}function applyTransformsToInnerDrag(){innerDrag&&innerDrag.setSize(dimensions.innerWidth,options.innerDragHeight).moveTo(position.innerX,position.innerY+dimensions.innerHeight+options.resizeHandleSize)}function applyTransformsToCloser(){closer&&closer.setSize(constrains.minWidth-options.resizeHandleSize,constrains.minHeight-options.resizeHandleSize).moveTo(position.outerX+dimensions.outerWidth-constrains.minWidth+3,position.outerY+options.resizeHandleSize)}function correctTransforms(){dimensions.topHeight<constrains.minHeight&&(dimensions.topHeight=constrains.minHeight,position.innerY=position.outerY+constrains.minHeight),dimensions.innerHeight<constrains.minHeight&&(dimensions.innerHeight=constrains.minHeight),dimensions.bottomHeight<constrains.minBottomHeight&&(dimensions.bottomHeight=constrains.minBottomHeight),dimensions.outerHeight=dimensions.topHeight+dimensions.innerHeight+dimensions.bottomHeight,dimensions.leftWidth<constrains.minWidth&&(dimensions.leftWidth=constrains.minWidth,position.innerX=position.outerX+constrains.minWidth),dimensions.innerWidth<constrains.minWidth&&(dimensions.innerWidth=constrains.minWidth),dimensions.rightWidth<constrains.minWidth&&(dimensions.rightWidth=constrains.minWidth),dimensions.outerWidth=dimensions.leftWidth+dimensions.innerWidth+dimensions.rightWidth}function setTopHeight(newHeight,newY,fromTop){dimensions.topHeight=newHeight,fromTop?(dimensions.outerHeight=newHeight+dimensions.innerHeight+dimensions.bottomHeight,position.outerY=newY):(dimensions.innerHeight=dimensions.outerHeight-newHeight-dimensions.bottomHeight,position.innerY=position.outerY+newHeight)}function setRightWidth(newWidth,newX,fromLeft){dimensions.rightWidth=newWidth,fromLeft?dimensions.innerWidth=newX-position.innerX:dimensions.outerWidth=dimensions.leftWidth+dimensions.innerWidth+newWidth}function setBottomHeight(newHeight,newY,fromTop){dimensions.bottomHeight=newHeight,fromTop?(dimensions.innerHeight=newY-position.innerY,dimensions.bottomHeight=newHeight):dimensions.outerHeight=dimensions.topHeight+dimensions.innerHeight+newHeight}function setLeftWidth(newWidth,newX,fromLeft){dimensions.leftWidth=newWidth,fromLeft?(dimensions.outerWidth=newWidth+dimensions.innerWidth+dimensions.rightWidth,position.outerX=newX):(dimensions.innerWidth=dimensions.outerWidth-newWidth-dimensions.rightWidth,position.innerX=position.outerX+newWidth)}function createCompoundMask(){createPart({id:"n",edges:{top:!0,right:!1,bottom:!0,left:!1},place:function(){this.moveTo(position.innerX,position.outerY).setSize(dimensions.innerWidth,dimensions.topHeight)},placeOverlay:function(overlay){var pos=this.getPosition(),size=this.getSize();overlay.moveTo(pos.x,pos.y+options.resizeHandleSize).setSize(size.width,size.height-2*options.resizeHandleSize)},beforeResize:function(width,height,fromLeft,fromTop){this.config.maxHeight=fromTop?null:dimensions.topHeight+(dimensions.innerHeight-constrains.minHeight)},onResize:function(width,height,fromLeft,fromTop,x,y){setTopHeight(height,y,fromTop),applyTransformsToMasks()}}),createPart({id:"ne",edges:{top:!0,right:!0,bottom:!1,left:!1},place:function(){this.moveTo(position.innerX+dimensions.innerWidth,position.outerY).setSize(dimensions.rightWidth,dimensions.topHeight)},placeOverlay:function(overlay){var pos=this.getPosition(),size=this.getSize();overlay.moveTo(pos.x,pos.y+options.resizeHandleSize).setSize(size.width-options.resizeHandleSize,size.height-2*options.resizeHandleSize)},onResize:function(width,height,fromLeft,fromTop,x,y){setTopHeight(height,y,fromTop),setRightWidth(width,x,fromLeft),applyTransformsToMasks()}}),createPart({id:"e",edges:{top:!1,right:!0,bottom:!1,left:!0},place:function(){this.moveTo(position.innerX+dimensions.innerWidth,position.innerY).setSize(dimensions.rightWidth,dimensions.innerHeight)},placeOverlay:function(overlay){var pos=this.getPosition(),size=this.getSize();overlay.moveTo(pos.x+options.resizeHandleSize,pos.y-options.resizeHandleSize).setSize(size.width-2*options.resizeHandleSize,size.height+2*options.resizeHandleSize)},beforeResize:function(width,height,fromLeft){this.config.maxWidth=fromLeft?dimensions.rightWidth+(dimensions.innerWidth-constrains.minWidth):null},onResize:function(width,height,fromLeft,fromTop,x){setRightWidth(width,x,fromLeft),applyTransformsToMasks()}}),createPart({id:"se",edges:{top:!1,right:!0,bottom:!0,left:!1},minHeight:constrains.minBottomHeight,place:function(){this.moveTo(position.innerX+dimensions.innerWidth,position.innerY+dimensions.innerHeight).setSize(dimensions.rightWidth,dimensions.bottomHeight)},placeOverlay:function(overlay){var pos=this.getPosition(),size=this.getSize();overlay.moveTo(pos.x,pos.y+options.resizeHandleSize).setSize(size.width-options.resizeHandleSize,size.height-2*options.resizeHandleSize)},onResize:function(width,height,fromLeft,fromTop,x,y){setRightWidth(width,x,fromLeft),setBottomHeight(height,y,fromTop),applyTransformsToMasks()}}),createPart({id:"s",edges:{top:!0,right:!1,bottom:!0,left:!1},minHeight:constrains.minBottomHeight,place:function(){this.moveTo(position.innerX,position.innerY+dimensions.innerHeight).setSize(dimensions.innerWidth,dimensions.bottomHeight)},placeOverlay:function(overlay){var pos=this.getPosition(),size=this.getSize();overlay.moveTo(pos.x,pos.y+options.resizeHandleSize).setSize(size.width,size.height-2*options.resizeHandleSize)},beforeResize:function(width,height,fromLeft,fromTop){this.config.maxHeight=fromTop?dimensions.bottomHeight+(dimensions.innerHeight-constrains.minHeight):null},onResize:function(width,height,fromLeft,fromTop,x,y){setBottomHeight(height,y,fromTop),applyTransformsToMasks()}}),createPart({id:"sw",edges:{top:!1,right:!1,bottom:!0,left:!0},minHeight:constrains.minBottomHeight,place:function(){this.moveTo(position.outerX,position.innerY+dimensions.innerHeight).setSize(dimensions.leftWidth,dimensions.bottomHeight)},placeOverlay:function(overlay){var pos=this.getPosition(),size=this.getSize();overlay.moveTo(pos.x+options.resizeHandleSize,pos.y+options.resizeHandleSize).setSize(size.width-options.resizeHandleSize,size.height-2*options.resizeHandleSize)},onResize:function(width,height,fromLeft,fromTop,x,y){setBottomHeight(height,y,fromTop),setLeftWidth(width,x,fromLeft),applyTransformsToMasks()}}),createPart({id:"w",edges:{top:!1,right:!0,bottom:!1,left:!0},place:function(){this.moveTo(position.outerX,position.innerY).setSize(dimensions.leftWidth,dimensions.innerHeight)},placeOverlay:function(overlay){var pos=this.getPosition(),size=this.getSize();overlay.moveTo(pos.x+options.resizeHandleSize,pos.y-options.resizeHandleSize).setSize(size.width-2*options.resizeHandleSize,size.height+2*options.resizeHandleSize)},beforeResize:function(width,height,fromLeft){this.config.maxWidth=fromLeft?null:dimensions.leftWidth+(dimensions.innerWidth-constrains.minWidth)},onResize:function(width,height,fromLeft,fromTop,x){setLeftWidth(width,x,fromLeft),applyTransformsToMasks()}}),createPart({id:"nw",edges:{top:!0,right:!1,bottom:!1,left:!0},place:function(){this.moveTo(position.outerX,position.outerY).setSize(dimensions.leftWidth,dimensions.topHeight)},placeOverlay:function(overlay){var pos=this.getPosition(),size=this.getSize();overlay.moveTo(pos.x+options.resizeHandleSize,pos.y+options.resizeHandleSize).setSize(size.width-options.resizeHandleSize,size.height-2*options.resizeHandleSize)},onResize:function(width,height,fromLeft,fromTop,x,y){setTopHeight(height,y,fromTop),setLeftWidth(width,x,fromLeft),applyTransformsToMasks()}})}function createPart(partConfig){allParts[partConfig.id]={mask:createMask(_.assign({},constrains,partConfig)),overlay:createOverlay(partConfig)}}function createVisualGuides(){visualGuides.$maskBg=$("<div>",{class:"mask-bg"}),visualGuides.$innerWindow=$("<div>",{class:"inner-window"})}var allParts={},visualGuides={},compoundMask,innerDrag,closer;return dimensions=_.defaults(dimensions||{},defaultDimensions),position=_.defaults(position||{},defaultPosition),options=_.defaults(options||{},defaultOptions),constrains={minWidth:2*options.resizeHandleSize+options.dragMinWidth,minHeight:2*options.resizeHandleSize+options.dragMinHeight,minBottomHeight:2*options.resizeHandleSize+options.innerDragHeight},compoundMask={init:function(){var self=this;return this.setTransforms(dimensions,position),createCompoundMask(),createVisualGuides(),createInnerDragHandle(),createCloser(),closer.on("click",function(){self.hide(),self.trigger("close")}),this},render:function($container){return invokeOnAll("render",[$container]),innerDrag.render($container),closer.render($container),applyTransforms(),this},destroy:function(){return invokeOnAll("destroy"),visualGuides=null,innerDrag=null,closer=null,this},show:function(){return invokeOnAll("show"),innerDrag.show(),closer.show(),this.setState("hidden",!1),this},hide:function(){return invokeOnAll("hide"),innerDrag.hide(),closer.hide(),this.setState("hidden",!0),this},setTransforms:function(dim,pos){dimensions=_.defaults(dim||{},dimensions),position=_.defaults(pos||{},position),dimensions.topHeight=pos.innerY-pos.outerY,dimensions.rightWidth=dim.outerWidth-(pos.innerX-pos.outerX)-dim.innerWidth,dimensions.bottomHeight=dim.outerHeight-(pos.innerY-pos.outerY)-dim.innerHeight,dimensions.leftWidth=pos.innerX-pos.outerX,correctTransforms(),applyTransforms()},getDimensions:function(){return dimensions},getPosition:function(){return position},getParts:function(){return allParts}},statifier(compoundMask),eventifier(compoundMask),compoundMask}}),define("taoQtiTest/runner/plugins/tools/lineReader/plugin",["jquery","lodash","i18n","taoTests/runner/plugin","ui/hider","util/shortcut","util/namespace","taoQtiTest/runner/plugins/tools/lineReader/compoundMask"],function($,_,__,pluginFactory,hider,shortcut,namespaceHelper,compoundMaskFactory){'use strict';function getDimensions($container){var $qtiContent=$container.find("#qti-content"),$qtiItem=$qtiContent.find(".qti-item"),lineHeight=Math.ceil(parseFloat($qtiContent.css("line-height")))||20;return{outerWidth:$qtiItem.width()+4*maskOptions.resizeHandleSize+2*maskOptions.dragMinWidth,outerHeight:175,innerWidth:$qtiItem.width(),innerHeight:lineHeight}}function getPosition($container){var $qtiContent=$container.find("#qti-content"),$qtiItem=$qtiContent.find(".qti-item"),itemPosition=$qtiItem.position()||{},paddingLeft=parseInt($qtiItem.css("padding-left"),10),paddingTop=parseInt($qtiItem.css("padding-top"),10),innerX=parseInt(itemPosition.left,10)+paddingLeft-3,innerY=parseInt(itemPosition.top,10)+paddingTop-3;return{outerX:innerX-2*maskOptions.resizeHandleSize-maskOptions.dragMinWidth,outerY:0,innerX:innerX,innerY:innerY}}function containerWidthHasChanged($container){var newDimensions=getDimensions($container);return newDimensions.outerWidth!==dimensions.outerWidth}var actionPrefix="tool-line-reader-",maskOptions={dragMinWidth:7,dragMinHeight:7,resizeHandleSize:7,innerDragHeight:20},dimensions,position;return pluginFactory({name:"line-reader",init:function(){function isEnabled(){var context=testRunner.getTestContext()||{},options=context.options||{};return!!options.lineReader}function toggleMask(){self.compoundMask.getState("hidden")?(containerWidthHasChanged($container)&&transformMask($container),openMask()):closeMask()}function openMask(){self.compoundMask.show(),self.trigger("start"),self.button.turnOn()}function closeMask(){self.compoundMask.getState("hidden")||self.compoundMask.hide(),self.trigger("end"),self.button.turnOff()}function transformMask($maskContainer){dimensions=getDimensions($maskContainer),position=getPosition($maskContainer),self.compoundMask.setTransforms(_.clone(dimensions),_.clone(position))}var self=this,testRunner=this.getTestRunner(),testData=testRunner.getTestData()||{},testConfig=testData.config||{},pluginShortcuts=(testConfig.shortcuts||{})["line-reader"]||{},$container=testRunner.getAreaBroker().getContentArea().parent();this.compoundMask=compoundMaskFactory(maskOptions).init().render($container).on("close",function(){closeMask()}).hide(),this.button=this.getAreaBroker().getToolbox().createEntry({title:__("Line Reader"),icon:"insert-horizontal-line",control:"line-reader",text:__("Line Reader")}),this.button.on("click",function(e){e.preventDefault(),testRunner.trigger(actionPrefix+"toggle")}),testConfig.allowShortcuts&&pluginShortcuts.toggle&&shortcut.add(namespaceHelper.namespaceAll(pluginShortcuts.toggle,this.getName(),!0),function(){testRunner.trigger(actionPrefix+"toggle")},{avoidInput:!0,prevent:!0}),this.disable(),testRunner.on("loaditem",function(){isEnabled()?self.show():self.hide()}).on("renderitem",function(){transformMask($container)}).on("enabletools renderitem",function(){self.enable()}).on("disabletools unloaditem",function(){self.disable(),closeMask()}).on(actionPrefix+"toggle",function(){isEnabled()&&toggleMask()})},destroy:function(){this.compoundMask.destroy(),shortcut.remove("."+this.getName())},enable:function(){this.button.enable()},disable:function(){this.button.disable()},show:function(){this.button.show()},hide:function(){this.button.hide()}})}),define("tpl!taoQtiTest/runner/plugins/tools/magnifier/magnifierPanel",["handlebars"],function(hb){return hb.template(function(Handlebars,depth0,helpers,partials,data){this.compilerInfo=[4,">= 1.0.0"],helpers=this.merge(helpers,Handlebars.helpers),data=data||{};var buffer="",escapeExpression=this.escapeExpression,helperMissing=helpers.helperMissing,stack1,helper,options;return buffer+="<div class=\"magnifier\">\n    <div class=\"level\">",(helper=helpers.level)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.level,stack1="function"===_typeof(helper)?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+"</div>\n    <div class=\"overlay\"></div>\n    <div class=\"inner\"></div>\n    <div class=\"controls close\">\n        <a href=\"#\" class=\"control\" data-control=\"zoomIn\" title=\""+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Magnify more",options):helperMissing.call(depth0,"__","Magnify more",options)))+"\"><span class=\"icon-add\"></span></a>\n        <a href=\"#\" class=\"control\"  data-control=\"zoomOut\" title=\""+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Magnify less",options):helperMissing.call(depth0,"__","Magnify less",options)))+"\"><span class=\"icon-remove\"></span></a>\n        <a href=\"#\" class=\"closeMagnifier\" data-control=\"closeMagnifier\" title=\""+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Close Magnifier",options):helperMissing.call(depth0,"__","Close Magnifier",options)))+"\"><span class=\"icon-result-nok\"></span></a>\n    </div>\n</div>",buffer})}),define("taoQtiTest/runner/plugins/tools/magnifier/magnifierPanel",["jquery","lodash","ui/component","tpl!taoQtiTest/runner/plugins/tools/magnifier/magnifierPanel","ui/dynamicComponent"],function($,_,component,magnifierPanelTpl,dynamicComponent){'use strict';var _Mathmin=Math.min,_Mathmax2=Math.max,screenRatio=window.screen.width/window.screen.height,defaultBaseSize=116,defaultLevelMin=2,defaultLevel=defaultLevelMin,defaultConfig={level:defaultLevel,levelMin:defaultLevelMin,levelMax:8,levelStep:.5,baseSize:defaultBaseSize,maxRatio:.5},dynamicComponentDefaultConfig={draggable:!0,resizable:!0,preserveAspectRatio:!1,width:defaultBaseSize*defaultLevel,height:defaultBaseSize*defaultLevel/screenRatio,minWidth:defaultBaseSize*defaultLevelMin,minHeight:defaultBaseSize*defaultLevelMin/screenRatio,stackingScope:"test-runner",top:50,left:10};return function(config){function scrollInClone(scrollData){var $clonedTarget;controls&&controls.$clone&&scrollData&&scrollData.id&&($clonedTarget=controls.$clone.find("[data-magnifier-scroll="+scrollData.id+"]"),$clonedTarget.length&&(_.isNumber(scrollData.scrollTop)&&($clonedTarget[0].scrollTop=scrollData.scrollTop),_.isNumber(scrollData.scrollLeft)&&($clonedTarget[0].scrollLeft=scrollData.scrollLeft)))}function setScrollingListener(){window.addEventListener("scroll",scrollingListenerCallback,!0)}function removeScrollingListener(){window.removeEventListener("scroll",scrollingListenerCallback,!0)}function applyScrolling(){_.forEach(scrolling,scrollInClone)}function adjustZoomLevel(level){return _Mathmax2(zoomLevelMin,_Mathmin(parseFloat(level),zoomLevelMax))}function applyZoomLevel(){controls&&controls.$inner.css({transform:"scale("+zoomLevel+")"})}function showZoomLevel(){var $newZoomLevel;controls&&($newZoomLevel=controls.$zoomLevel.clone(!0).html(zoomLevel),controls.$zoomLevel.before($newZoomLevel).remove(),controls.$zoomLevel=$newZoomLevel)}function updateMaxSize(){if(dynamicComponentInstance){var $window=$(window);dynamicComponentInstance.config.maxWidth=$window.width()*maxRatio,dynamicComponentInstance.config.maxHeight=$window.height()*maxRatio}}function applySize(){controls&&controls.$clone&&(targetWidth=controls.$target.width(),targetHeight=controls.$target.height(),controls.$clone.width(targetWidth).height(targetHeight))}function updateZoom(){var position;controls&&controls.$target&&(position=dynamicComponentInstance.position,position.x+=dx+controls.$target.scrollLeft(),position.y+=dy+controls.$target.scrollTop(),magnifierPanel.zoomAt(position.x,position.y))}function createObserver(){observer=new window.MutationObserver(updateMagnifier)}function startObserver(){controls&&controls.$target&&observer.observe(controls.$target.get(0),{childList:!0,attributes:!0,characterData:!0,subtree:!0}),setScrollingListener()}function stopObserver(){observer.disconnect(),removeScrollingListener()}function translateMagnifier(coordinate,actualSize,magnifierSize){var delta=0,ratio=zoomLevel;return actualSize&&(delta=actualSize*(zoomLevel-1)/2,ratio=(actualSize*zoomLevel-magnifierSize)/(actualSize-magnifierSize)),coordinate*ratio-delta}function getElementFromPoint(x,y){var el;return x=x||0,y=y||0,controls&&controls.$overlay.addClass("hidden"),el=document.elementFromPoint(x,y),controls&&controls.$overlay.removeClass("hidden"),el}function findSourceNode(node,root,target){var $node=$(node),$root=$(root),$target=$(target),indexes=[$node.index()];return $node.parents().each(function(){var $this=$(this);return!$this.is($root)&&void indexes.push($this.index())}),indexes.pop(),indexes.length?($node=$target,_.forEachRight(indexes,function(index){if($node=$node.children().eq(index),!$node.length)return!1})):$node=$(),$node}var initConfig=_.defaults(config||{},defaultConfig),zoomLevelMin=parseFloat(initConfig.levelMin),zoomLevelMax=parseFloat(initConfig.levelMax),zoomLevelStep=parseFloat(initConfig.levelStep),zoomLevel=adjustZoomLevel(initConfig.level),maxRatio=parseFloat(initConfig.maxRatio),$initTarget=null,controls=null,observer=null,scrolling=[],dynamicComponentConfig=_.defaults(config?config.component||{}:{},dynamicComponentDefaultConfig),magnifierPanel=component({getZoomLevel:function(){return zoomLevel},getTarget:function(){return controls&&controls.$target},setTarget:function($newTarget){return controls?(controls.$target=$newTarget,controls.$viewTarget=null,setScrollingListener(),this.trigger("targetchange",controls.$target),this.update()):$initTarget=$newTarget,this},zoomTo:function(level){return level&&_.isFinite(level)&&(zoomLevel=adjustZoomLevel(level)),applyZoomLevel(),showZoomLevel(),updateMaxSize(),updateZoom(),this.trigger("zoom",zoomLevel),this},zoomBy:function(step){return step&&_.isFinite(step)&&this.zoomTo(zoomLevel+parseFloat(step)),this},zoomIn:function(){return this.zoomBy(zoomLevelStep)},zoomOut:function(){return this.zoomBy(-zoomLevelStep)},zoomAt:function(x,y){var position;controls&&(position=this.translate(x,y),controls.$inner.css({top:-position.top,left:-position.left}))},translate:function(x,y){return{top:translateMagnifier(y,targetHeight,dynamicComponentInstance.config.height),left:translateMagnifier(x,targetWidth,dynamicComponentInstance.config.width)}},update:function(){return controls&&controls.$target&&(controls.$clone=controls.$target.clone().removeAttr("id"),controls.$clone.find("iframe").remove(),controls.$clone.find("[name],[id],[data-serial]").removeAttr("name id data-serial"),controls.$inner.empty().append(controls.$clone),applySize(),applyZoomLevel(),updateZoom(),updateMaxSize(),applyScrolling(),this.trigger("update")),this}},defaultConfig),updateMagnifier=_.debounce(_.bind(magnifierPanel.update,magnifierPanel),50),scrollingListenerCallback=_.throttle(function(event){var $target=$(event.target),scrollingTop=event.target.scrollTop,scrollLeft=event.target.scrollLeft,scrollId,scrollData;controls&&controls.$clone&&$target.data("magnifier-scroll")?(scrollId=$target.data("magnifier-scroll"),scrollData=_.find(scrolling,{id:scrollId}),scrollData.scrollTop=scrollingTop,scrollData.scrollLeft=scrollLeft,scrollInClone(scrollData)):(scrollId=_.uniqueId("scrolling_"),$target.attr("data-magnifier-scroll",scrollId),scrolling.push({id:scrollId,scrollTop:scrollingTop,scrollLeft:scrollLeft}),magnifierPanel.update())},20),targetWidth,targetHeight,dx,dy,dynamicComponentInstance;return dynamicComponentInstance=dynamicComponent({}).on("rendercontent",function($content){var dynamicComponentContext=this,$element=this.getElement();$element.addClass("magnifier-container"),magnifierPanel.setTemplate(magnifierPanelTpl).on("render",function(){var self=this,$component=this.getElement();this.setState("hidden",!0),dx=($component.outerWidth()-$component.width())/2,dy=($component.outerHeight()-$component.height())/2,controls={$target:$initTarget,$inner:$(".inner",$component),$zoomLevel:$(".level",$component),$overlay:$(".overlay",$component)},$initTarget=null,$component.on("click touchstart",".control[data-control=\"zoomOut\"]",function(event){event.preventDefault(),self.zoomOut()}),$component.on("click touchstart",".control[data-control=\"zoomIn\"]",function(event){event.preventDefault(),self.zoomIn()}),$component.on("click touchstart",".closeMagnifier",function(event){event.preventDefault(),self.hide(),self.trigger("close")}),$component.on("click touchstart",".overlay",function(event){findSourceNode(getElementFromPoint(event.pageX,event.pageY),controls.$inner,controls.$target).click().focus()}),createObserver(),updateMaxSize(),applyZoomLevel()}).on("show",function(){updateMagnifier(),startObserver(),dynamicComponentContext.show()}).on("hide",function(){stopObserver(),dynamicComponentContext.hide()}).on("destroy",function(){stopObserver(),$initTarget=null,controls=null,observer=null,dynamicComponentContext.destroy()}).init(initConfig).render($content)}).on("down move resize",function(){updateZoom()}).on("resize",function(){updateMaxSize()}).init(dynamicComponentConfig),magnifierPanel}}),define("taoQtiTest/runner/plugins/tools/magnifier/magnifier",["jquery","lodash","i18n","taoTests/runner/plugin","ui/hider","util/shortcut","util/namespace","taoQtiTest/runner/plugins/tools/magnifier/magnifierPanel"],function($,_,__,pluginFactory,hider,shortcut,namespaceHelper,magnifierPanelFactory){'use strict';var actionPrefix="tool-magnifier-",defaultOptions={zoomMin:2,zoomMax:8,zoomStep:.5};return pluginFactory({name:"magnifier",init:function(){function getMagnifierPanel(){var $container;return magnifierPanel||($container=testRunner.getAreaBroker().getContainer(),magnifierPanel=magnifierPanelFactory({levelMin:pluginConfig.zoomMin,levelMax:pluginConfig.zoomMax,levelStep:pluginConfig.zoomStep,component:{renderTo:$container.parent(),draggableContainer:$container.parent()}}).on("show",function(){self.trigger("magnifier-show")}).on("hide",function(){self.trigger("magnifier-hide")}).on("zoom",function(level){self.trigger("magnifier-zoom",level)}).on("close",function(){hideMagnifier()}).setTarget($container),self.trigger("magnifier-create")),magnifierPanel}function isEnabled(){var context=testRunner.getTestContext()||{},options=context.options||{};return!!options.magnifier}function togglePlugin(){isEnabled()?self.show():self.hide()}function toggleMagnifier(){self.getState("enabled")&&(self.getState("active")?hideMagnifier():showMagnifier())}function showMagnifier(){getMagnifierPanel(),magnifierPanel.is("hidden")&&magnifierPanel.show(),self.button.turnOn(),testRunner.trigger("plugin-open.magnifier"),self.setState("active",!0)}function hideMagnifier(){self.setState("active",!1),self.button.turnOff(),testRunner.trigger("plugin-close.magnifier"),magnifierPanel&&!magnifierPanel.is("hidden")&&magnifierPanel.hide()}var self=this,testRunner=this.getTestRunner(),testData=testRunner.getTestData()||{},testConfig=testData.config||{},pluginConfig=_.defaults((testConfig.plugins||{}).magnifier||{},defaultOptions),pluginShortcuts=(testConfig.shortcuts||{}).magnifier||{},magnifierPanel=null;this.button=this.getAreaBroker().getToolbox().createEntry({control:"magnify",title:__("Displays a customisable magnifier"),text:__("Magnifying Glass"),icon:"find"}),this.button.on("click",function(event){event.preventDefault(),testRunner.trigger(actionPrefix+"toggle")}),testConfig.allowShortcuts&&_.forEach(pluginShortcuts,function(command,key){shortcut.add(namespaceHelper.namespaceAll(command,"magnifier",!0),function(){testRunner.trigger(actionPrefix+key)},{avoidInput:!0})}),togglePlugin(),this.disable(),testRunner.on("loaditem",function(){togglePlugin(),self.disable()}).on("renderitem",function(){magnifierPanel&&magnifierPanel.update().zoomTo(pluginConfig.zoomMin)}).on("enabletools renderitem",function(){self.enable()}).on("disabletools unloaditem",function(){self.getState("active")&&hideMagnifier(),self.disable()}).on("destroy",function(){magnifierPanel&&magnifierPanel.destroy(),magnifierPanel=null}).on(actionPrefix+"toggle",function(){isEnabled()&&toggleMagnifier()}).on(actionPrefix+"in",function(){isEnabled()&&self.getState("enabled")&&self.getState("active")&&getMagnifierPanel().zoomIn()}).on(actionPrefix+"out",function(){isEnabled()&&self.getState("enabled")&&self.getState("active")&&getMagnifierPanel().zoomOut()}).on(actionPrefix+"close",function(){self.getState("active")&&hideMagnifier()})},destroy:function(){shortcut.remove(".magnifier")},enable:function(){this.button.enable()},disable:function(){this.button.disable()},show:function(){this.button.show()},hide:function(){this.button.hide()}})}),define("taoQtiTest/runner/plugins/tools/zoom",["jquery","i18n","ui/hider","ui/transformer","util/shortcut","util/namespace","taoTests/runner/plugin"],function($,__,hider,transformer,shortcut,namespaceHelper,pluginFactory){'use strict';var _Mathmax3=Math.max,threshold={lower:10,upper:200},_setZoomLevel=function($target,level){var $parent=$target.parent(),newScale=level/100,isOverZoom=$parent.outerWidth(!0)<$target.width()*newScale;isOverZoom?(transformer.setTransformOrigin($target,"0 0"),$parent.css("margin-left","0")):(transformer.setTransformOrigin($target,"50% 0"),$parent.css("margin-left","")),transformer.scale($target,newScale)},_resetZoom=function($target){transformer.reset($target)},forceRepaint=function($target){var sel=$target[0];sel&&(sel.style.display="none",sel.offsetHeight,sel.style.display="")};return pluginFactory({name:"zoom",init:function(){function isConfigured(){var context=testRunner.getTestContext()||{},options=context.options||{};return!!options.zoom}function togglePlugin(){isConfigured()?self.show():self.hide()}function zoomAction(dir){var el,sx,sy,before,after;self.$zoomTarget&&(el=self.$zoomTarget[0],before=el.getBoundingClientRect(),sx=self.$container.scrollLeft(),sy=self.$container.scrollTop(),self.zoom=_Mathmax3(threshold.lower,Math.min(threshold.upper,self.zoom+10*dir)),self.zoom===100?_resetZoom(self.$zoomTarget):_setZoomLevel(self.$zoomTarget,self.zoom),forceRepaint(self.$zoomTarget),after=el.getBoundingClientRect(),sx=_Mathmax3(0,sx+(after.width-before.width)/2),sy=_Mathmax3(0,sy+(after.height-before.height)/2),self.$container.scrollLeft(sx).scrollTop(sy))}var self=this,testRunner=this.getTestRunner(),testData=testRunner.getTestData()||{},testConfig=testData.config||{},pluginShortcuts=(testConfig.shortcuts||{})[this.getName()]||{};this.buttonZoomOut=this.getAreaBroker().getToolbox().createEntry({control:"zoomOut",title:__("Zoom out"),icon:"remove"}),this.buttonZoomIn=this.getAreaBroker().getToolbox().createEntry({control:"zoomIn",title:__("Zoom in"),icon:"add"}),this.buttonZoomIn.on("click",function(e){e.preventDefault(),testRunner.trigger("tool-zoomin")}),this.buttonZoomOut.on("click",function(e){e.preventDefault(),testRunner.trigger("tool-zoomout")}),testConfig.allowShortcuts&&(pluginShortcuts.in&&shortcut.add(namespaceHelper.namespaceAll(pluginShortcuts.in,this.getName(),!0),function(){testRunner.trigger("tool-zoomin")},{avoidInput:!0}),pluginShortcuts.out&&shortcut.add(namespaceHelper.namespaceAll(pluginShortcuts.out,this.getName(),!0),function(){testRunner.trigger("tool-zoomout")},{avoidInput:!0})),togglePlugin(),this.disable(),testRunner.on("loaditem",function(){self.zoom=100,togglePlugin(),self.disable()}).on("renderitem",function(){self.$container=$("#qti-content"),self.$zoomTarget=$(".qti-item"),self.enable()}).on("enabletools",function(){self.enable()}).on("disabletools unloaditem",function(){self.disable()}).on("tool-zoomin",function(){!1!==self.getState("enabled")&&zoomAction(1)}).on("tool-zoomout",function(){!1!==self.getState("enabled")&&zoomAction(-1)})},destroy:function(){shortcut.remove("."+this.getName())},enable:function(){this.buttonZoomIn.enable(),this.buttonZoomOut.enable()},disable:function(){this.buttonZoomIn.disable(),this.buttonZoomOut.disable()},show:function(){this.buttonZoomIn.show(),this.buttonZoomOut.show()},hide:function(){this.buttonZoomIn.hide(),this.buttonZoomOut.hide()}})}),function(c){var d=document,s=d.createElement("style");s.type="text/css",d.getElementsByTagName("head")[0].appendChild(s),s.styleSheet?s.styleSheet.cssText=c:s.appendChild(d.createTextNode(c))}(".test-runner-scope .content-wrapper p.key-navigation-group,.test-runner-scope .content-wrapper div.key-navigation-group{padding:5px !important}.test-runner-scope .content-wrapper .key-navigation-group:not(.qti-extendedTextInteraction):not(.qti-textEntryInteraction){border-width:1px !important;border-style:solid;border-color:transparent}.test-runner-scope .content-wrapper .key-navigation-group:not(.qti-extendedTextInteraction):not(.qti-textEntryInteraction).focusin{border-color:#0e5d91 !important;outline:none}.test-runner-scope .content-wrapper .key-navigation-group:not(.qti-extendedTextInteraction):not(.qti-textEntryInteraction).qti-interaction .qti-choice.key-navigation-highlight{background:#e7eff4 !important}.test-runner-scope .content-wrapper span.key-navigation-group{border:none !important}.test-runner-scope .content-wrapper span.key-navigation-group.focusin{outline:solid #0e5d91 1px !important;outline-offset:1px}.test-runner-scope .test-sidebar .key-navigation-group.focusin{background:#e7eff4}.test-runner-scope .test-sidebar .key-navigation-group .qti-navigator-filters .key-navigation-highlight .qti-navigator-tab{border-width:2px}.test-runner-scope .test-sidebar .key-navigation-group .qti-navigator-filters .key-navigation-highlight:focus{outline:none}.test-runner-scope .test-sidebar .key-navigation-group .qti-navigator-filters .key-navigation-highlight:focus .qti-navigator-tab{border-top-color:#222 !important;border-left-color:#222 !important;border-right-color:#222 !important}.test-runner-scope .test-sidebar .key-navigation-group li.qti-navigator-item.key-navigation-highlight{padding-left:8px;border-left:solid 2px #222}.test-runner-scope .test-sidebar .key-navigation-group li.qti-navigator-item.key-navigation-highlight .key-navigation-highlight:focus{outline:none}.test-runner-scope .bottom-action-bar.content-action-bar.key-navigation-group.focusin{-webkit-box-shadow:0 0 6px 2px #3e7da7;-moz-box-shadow:0 0 6px 2px #3e7da7;-ms-box-shadow:0 0 6px 2px #3e7da7;-o-box-shadow:0 0 6px 2px #3e7da7;box-shadow:0 0 6px 2px #3e7da7}.test-runner-scope .bottom-action-bar.content-action-bar.key-navigation-group .key-navigation-highlight:focus{margin-bottom:0;border-bottom-color:#e7eff4 !important;outline:none}.test-runner-scope .bottom-action-bar.content-action-bar.key-navigation-group .key-navigation-highlight:focus.active{border-bottom-color:transparent !important;background:#e7eff4 !important}.test-runner-scope .bottom-action-bar.content-action-bar.key-navigation-group .key-navigation-highlight:focus:not(.active):not(:active) .li-inner{color:#e7eff4}header .settings-menu .key-navigation-group{padding-right:5px}header .settings-menu .key-navigation-group.focusin{background-color:rgba(14,93,145,0.5);padding-bottom:10px}header .settings-menu .key-navigation-highlight:focus{height:54px;color:white !important;border-bottom:solid 2px white !important}\n\n/*# sourceMappingURL=key-navigation.css.map */.countdown{opacity:0;position:relative;display:inline-block;overflow:hidden;text-align:center;vertical-align:top;line-height:1.2;padding:0 20px;margin-top:-1px;height:100%}.countdown.rendered{opacity:1;-webkit-transition:opacity, 300ms, linear, 0s;-moz-transition:opacity, 300ms, linear, 0s;-ms-transition:opacity, 300ms, linear, 0s;-o-transition:opacity, 300ms, linear, 0s;transition:opacity, 300ms, linear, 0s}.countdown .label{max-width:130px;display:block;font-size:12px;font-size:1.2rem}\n\n/*# sourceMappingURL=countdown.css.map */.timer-box{opacity:0;padding-top:0;white-space:nowrap;-webkit-flex:1 0 auto;-ms-flex:1 0 auto;flex:1 0 auto;display:-ms-flexbox;display:-webkit-flex;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-flex-wrap:nowrap;-ms-flex-wrap:nowrap;flex-wrap:nowrap;-webkit-justify-content:flex-end;-ms-flex-pack:end;justify-content:flex-end}.timer-box.rendered{opacity:1;-webkit-transition:opacity, 300ms, linear, 0s;-moz-transition:opacity, 300ms, linear, 0s;-ms-transition:opacity, 300ms, linear, 0s;-o-transition:opacity, 300ms, linear, 0s;transition:opacity, 300ms, linear, 0s}.timer-box .timer-toggler{text-decoration:none;color:#fff;line-height:1.3;opacity:.68;padding:8px 20px;position:relative;top:-1px;left:20px;z-index:2;-webkit-transition:opacity, .5s, ease-out, 0s;-moz-transition:opacity, .5s, ease-out, 0s;-ms-transition:opacity, .5s, ease-out, 0s;-o-transition:opacity, .5s, ease-out, 0s;transition:opacity, .5s, ease-out, 0s}.timer-box .timer-toggler:hover,.timer-box .timer-toggler:active,.timer-box .timer-toggler:focus{outline:unset}.timer-box .timer-toggler:hover{opacity:.93;-webkit-transition:opacity, .5s, ease-out, 0s;-moz-transition:opacity, .5s, ease-out, 0s;-ms-transition:opacity, .5s, ease-out, 0s;-o-transition:opacity, .5s, ease-out, 0s;transition:opacity, .5s, ease-out, 0s}.timer-box.zen .timer-toggler{opacity:.93;-webkit-transition:opacity, .5s, ease-out, 0s;-moz-transition:opacity, .5s, ease-out, 0s;-ms-transition:opacity, .5s, ease-out, 0s;-o-transition:opacity, .5s, ease-out, 0s;transition:opacity, .5s, ease-out, 0s}.timer-box.zen .countdown .time{opacity:0;-webkit-transition:opacity, 1s, ease-out, 0s;-moz-transition:opacity, 1s, ease-out, 0s;-ms-transition:opacity, 1s, ease-out, 0s;-o-transition:opacity, 1s, ease-out, 0s;transition:opacity, 1s, ease-out, 0s}.timer-box .countdown::before{content:' ';background:rgba(255,255,255,0.3);width:1px;height:20px;position:absolute;left:0;top:5px}.timer-box .countdown:first-child::before{content:none}.timer-box .countdown[data-scope=test][data-type=min]{-ms-flex-order:5;-webkit-order:5;order:5}.timer-box .countdown[data-scope=test]{-ms-flex-order:10;-webkit-order:10;order:10}.timer-box .countdown[data-scope=testPart][data-type=min]{-ms-flex-order:15;-webkit-order:15;order:15}.timer-box .countdown[data-scope=testPart]{-ms-flex-order:20;-webkit-order:20;order:20}.timer-box .countdown[data-scope=section][data-type=min]{-ms-flex-order:25;-webkit-order:25;order:25}.timer-box .countdown[data-scope=section]{-ms-flex-order:30;-webkit-order:30;order:30}.timer-box .countdown[data-scope=item][data-type=min]{-ms-flex-order:35;-webkit-order:35;order:35}.timer-box .countdown[data-scope=item]{-ms-flex-order:40;-webkit-order:40;order:40}\n\n/*# sourceMappingURL=timerbox.css.map */"),define("taoQtiTest/loader/testPlugins.bundle",function(){});
//# sourceMappingURL=testPlugins.min.js.map